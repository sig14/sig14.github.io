<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Documentation SIG14 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="_static/sphinx_rtd_theme_ext_color_contrast.css" />
      <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="_static/togglebutton.js"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="#">
            
              <img src="_static/CD14_petit.png" class="logo" alt="Logo"/>
          </a>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Équipe</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-equipe/I_membres">I- Membres</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-equipe/II_contact">II- Contact</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Adressage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-adressage/I_acc_communes">I- Accompagnement des Communes</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-adressage/II_application_saisie">II- Application de saisie</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-adressage/III_consultation_exports">III- Consulter et exporter les données “Adresses” depuis QGIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-adressage/IV_depot_bal">IV- Déposer une BAL via l’API BAN avec FME</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Cadastre</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-cadastre/I_maj_annuelle">I- Mettre à jour les données EDIGEO / Majic III (maj annuelle)</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-cadastre/II_gpu_docs_urba">II- Ajouter un onglet “Documents d’urbanisme GPU” à la pop-up cadastre de Lizmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-cadastre/III_filiation_parcelles">III- Ajouter un onglet “Filiation parcellaire” à la pop-up cadastre de Lizmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-cadastre/IV_mutation_immo">IV- Ajouter un onglet “Mutations immobilières” à la pop-up cadastre de Lizmap</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">DECI</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-deci/I_perimetres_pei">I- Périmètres des bornes incendies</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-deci/II_rapproch_ign">II- Rapprochement adresse BDtopo IGN</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Traitements FME</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-traitements_fme/I_plannificateur_taches">I- Produire un calendrier des tâches du plannificateur</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Traitements GDAL</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-traitements_gdal/I_geopackage">I- Produire un GeoPackage des orthos tuilées</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-traitements_gdal/II_cog">II- Produire un COG à partir des orthos IGN</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="#">Documentation SIG14</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="#" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Documentation SIG14  documentation</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/sig14/sig14.github.io/blob/master/index" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="ressources-sig-du-departement-du-calvados">
<h1>Ressources SIG du Département du Calvados<a class="headerlink" href="#ressources-sig-du-departement-du-calvados" title="Permalink to this heading"></a></h1>
<p>L’équipe SIG du Département du Calvados utilise ce site pour documenter et partager certaines de ses activités. Vous trouverez notamment sur ce site la description de traitements effectués avec l’ETL FME ou en base de données avec PostgreSQL/GIS.</p>
<p>Vous pouvez accéder à la page github source en suivant ce lien : <a class="reference external" href="https://github.com/sig14/sig14.github.io/">github CD14</a></p>
<p>Bonne visite !</p>
<div class="toctree-wrapper compound">
<span id="document-equipe/I_membres"></span><div class="section" id="i-membres">
<h2>I- Membres<a class="headerlink" href="#i-membres" title="Permalink to this heading"></a></h2>
<div class="section" id="jeremie-ory">
<h3>Jérémie Ory<a class="headerlink" href="#jeremie-ory" title="Permalink to this heading"></a></h3>
<a class="reference internal image-reference" href="_images/photo_jeremie.jpg"><img alt="A screen capture showing the elements of the course outline in the LMS." src="_images/photo_jeremie.jpg" style="width: 150px;" /></a>
<p>Responsable du pôle SIG, <a class="reference external" href="mailto:jeremie&#46;ory&#37;&#52;&#48;calvados&#46;fr">jeremie<span>&#46;</span>ory<span>&#64;</span>calvados<span>&#46;</span>fr</a> - 02.31.57.11.51</p>
<ul class="simple">
<li><p><strong>Expertises :</strong> QGIS, postgreSQL/GIS, webmapping, modélisation, analyse spatiale, open data</p></li>
<li><p><strong>Thématiques métiers :</strong> adressage, DECI, urbanisme, cadastre</p></li>
</ul>
</div>
<div class="section" id="theo-grondin">
<h3>Théo Grondin<a class="headerlink" href="#theo-grondin" title="Permalink to this heading"></a></h3>
<a class="reference internal image-reference" href="_images/photo_theo.jpg"><img alt="A screen capture showing the elements of the course outline in the LMS." src="_images/photo_theo.jpg" style="width: 150px;" /></a>
<p>Chargé de mission SIG, <a class="reference external" href="mailto:theo&#46;grondin&#37;&#52;&#48;calvados&#46;fr">theo<span>&#46;</span>grondin<span>&#64;</span>calvados<span>&#46;</span>fr</a> - 02.31.57.12.30</p>
<ul class="simple">
<li><p><strong>Expertises :</strong> QGIS, postgreSQL/GIS, FME, lizmap, modélisation, analyse spatiale</p></li>
<li><p><strong>Thématiques métiers :</strong> adressage, deci, urbanisme, cadastre</p></li>
</ul>
</div>
<div class="section" id="clement-belletre">
<h3>Clément Bellêtre<a class="headerlink" href="#clement-belletre" title="Permalink to this heading"></a></h3>
<a class="reference internal image-reference" href="_images/photo_clement.png"><img alt="A screen capture showing the elements of the course outline in the LMS." src="_images/photo_clement.png" style="width: 150px;" /></a>
<p>Chargé de mission SIG, <a class="reference external" href="mailto:clement&#46;belletre&#37;&#52;&#48;calvados&#46;fr">clement<span>&#46;</span>belletre<span>&#64;</span>calvados<span>&#46;</span>fr</a> - 02.31.57.12.08</p>
<ul class="simple">
<li><p><strong>Expertises :</strong> QGIS, postgreSQL/GIS, lizmap</p></li>
<li><p><strong>Thématiques métiers :</strong> adressage, deci</p></li>
</ul>
</div>
<div class="section" id="samuel-audrain">
<h3>Samuel Audrain<a class="headerlink" href="#samuel-audrain" title="Permalink to this heading"></a></h3>
<a class="reference internal image-reference" href="_images/photo_samuel.jpg"><img alt="A screen capture showing the elements of the course outline in the LMS." src="_images/photo_samuel.jpg" style="width: 150px;" /></a>
<p>Géomaticen, <a class="reference external" href="mailto:samuel&#46;audrain&#37;&#52;&#48;calvados&#46;fr">samuel<span>&#46;</span>audrain<span>&#64;</span>calvados<span>&#46;</span>fr</a> - 02.31.57.13.79</p>
<ul class="simple">
<li><p><strong>Expertises :</strong> QGIS, postgreSQL/GIS, lizmap, FME, cartographie</p></li>
<li><p><strong>Thématiques métiers :</strong> cadastre, urbanisme, gestion des routes</p></li>
</ul>
</div>
</div>
<span id="document-equipe/II_contact"></span><div class="section" id="ii-contact">
<h2>II- Contact<a class="headerlink" href="#ii-contact" title="Permalink to this heading"></a></h2>
<p>L’équipe est disponible à l’adresse mail suivante : <a class="reference external" href="mailto:sig&#37;&#52;&#48;calvados&#46;fr">sig<span>&#64;</span>calvados<span>&#46;</span>fr</a></p>
</div>
</div>
<div class="toctree-wrapper compound">
<span id="document-adressage/I_acc_communes"></span><div class="section" id="i-accompagnement-des-communes">
<h2>I- Accompagnement des Communes<a class="headerlink" href="#i-accompagnement-des-communes" title="Permalink to this heading"></a></h2>
<p>L’adressage est une <strong>compétence communale</strong> qui consiste pour une mairie à nommer les rues et numéroter les habitations. Depuis le 21 février 2022 et la promulgation de la loi relative à la différenciation, la déconcentration, la décentralisation et portant diverses mesures de simplification (<a class="reference external" href="https://www.legifrance.gouv.fr/jorf/id/JORFTEXT000045197395">Loi 3DS</a>), il s’agit même d’une <strong>obligation réglementaire</strong>. Les communes doivent :</p>
<ul class="simple">
<li><p>Nommer chaque voie</p></li>
<li><p>Numéroter chaque habitation, entreprise et service public</p></li>
<li><p>Certifier et publier les adresses dans la <a class="reference external" href="https://adresse.data.gouv.fr/">Base Adresse Nationale</a></p></li>
</ul>
<p>Disposer d’une base adresse complète et fiable répond à d’importants enjeux du quotidien :</p>
<ul class="simple">
<li><p>Efficacité des services de secours</p></li>
<li><p>Délivrance des colis et du courrier</p></li>
<li><p>Déploiement du réseau de fibre optique</p></li>
<li><p>Repérage au quotidien avec les services de GPS</p></li>
<li><p>etc.</p></li>
</ul>
<p>Depuis 2019, le Département du Calvados propose aux communes <strong>un accompagnement dans cette démarche d’adressage</strong>. Différents outils ont été développés afin de répondre aux besoins des communes mais aussi pour faciliter et accélerer la production et la certification des adresses dans le Calvados.</p>
<div class="section" id="rapport-d-accompagnement">
<h3>1- Rapport d’accompagnement<a class="headerlink" href="#rapport-d-accompagnement" title="Permalink to this heading"></a></h3>
<p>Afin de pouvoir présenter aux élus la démarche d’adressage et le dispositif d’accompagnement proposé par le Département du Calvados, le Pôle SIG s’est doté d’un projet de génération de <strong>rapports thématiques automatisés</strong>. Ces rapports pouvant donc être transposés à n’importe quelle autre thématique que l’adressage.</p>
<p>Avec la fonctionnalité d’<a class="reference external" href="http://www.qgistutorials.com/fr/docs/automating_map_creation.html">Atlas de QGIS</a> il est possible de générer une carte pour chaque entité géographique à partir d’un modèle. Ainsi, cet outil permet de produire une carte par commune (ou par canton, EPCI etc.) à partir d’un modèle unique. Pour l’exemple qui va suivre, la maille choisie est celle du canton de façon à pouvoir présenter aux conseillers départementaux un rapport d’avancement de l’adressage sur les communes composant leur territoire.</p>
<p>Dans cet exemple, le choix est de faire apparaître deux types d’informations :</p>
<ul class="simple">
<li><p>Une cartographie des communes qui sont engagées dans la démarche ou qui ont terminé leur projet. (<strong>1</strong>)</p></li>
<li><p>Des statistiques à l’échelle du département (<strong>2</strong>) et du canton en question (<strong>3</strong>).</p></li>
</ul>
<a class="reference internal image-reference" href="_images/rapport_adressage_canton_bayeux.png"><img alt="_images/rapport_adressage_canton_bayeux.png" class="align-center" src="_images/rapport_adressage_canton_bayeux.png" style="width: 340.5px; height: 481.5px;" /></a>
<p>Les statistiques sont calculées avec des expressions QGIS intégrées dans du code HTML. Dans cet exemple ci-dessous, le nombre de communes accompagnées dans le Calvados est calculé avec le champ <code class="docutils literal notranslate"><span class="pre">actif</span></code> de la table <code class="docutils literal notranslate"><span class="pre">Communes</span></code>. Il indique si la commune a engagé une démarche d’adressage avec le CD14)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Nombre</span> <span class="n">de</span> <span class="n">communes</span> <span class="n">engagées</span> <span class="n">dans</span> <span class="n">l</span><span class="s1">&#39;adressage :</span>
<span class="p">[</span><span class="o">%</span><span class="n">aggregate</span><span class="p">(</span><span class="n">layer</span><span class="o">:=</span><span class="s1">&#39;Communes&#39;</span><span class="p">,</span> <span class="n">aggregate</span><span class="o">:=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">expression</span><span class="o">:=</span><span class="n">id_com</span><span class="p">,</span> <span class="nb">filter</span><span class="o">:=</span><span class="n">actif</span> <span class="o">=</span><span class="s1">&#39;Oui&#39;</span> <span class="p">)</span><span class="o">%</span><span class="p">]</span>
<span class="o">/</span> <span class="p">[</span><span class="o">%</span><span class="n">aggregate</span><span class="p">(</span><span class="n">layer</span><span class="o">:=</span><span class="s1">&#39;Communes&#39;</span><span class="p">,</span> <span class="n">aggregate</span><span class="o">:=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">expression</span><span class="o">:=</span><span class="n">id_com</span><span class="p">)</span><span class="o">%</span><span class="p">]</span><span class="o">&lt;/</span><span class="n">b</span><span class="o">&gt;</span><span class="p">,</span>
<span class="n">soit</span> <span class="p">[</span><span class="o">%</span><span class="nb">round</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">aggregate</span><span class="p">(</span><span class="n">layer</span><span class="o">:=</span><span class="s1">&#39;Communes&#39;</span><span class="p">,</span> <span class="n">aggregate</span><span class="o">:=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">expression</span><span class="o">:=</span><span class="n">id_com</span><span class="p">,</span> <span class="nb">filter</span><span class="o">:=</span><span class="n">actif</span> <span class="o">=</span><span class="s1">&#39;Oui&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">aggregate</span><span class="p">(</span><span class="n">layer</span><span class="o">:=</span><span class="s1">&#39;Communes&#39;</span><span class="p">,</span> <span class="n">aggregate</span><span class="o">:=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">expression</span><span class="o">:=</span><span class="n">id_com</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="p">]</span><span class="o">%</span>
</pre></div>
</div>
<p>Ce qui donne</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Nombre</span> <span class="n">de</span> <span class="n">communes</span> <span class="n">engagées</span> <span class="n">dans</span> <span class="n">l</span>\<span class="s1">&#39;adressage : 326 / 528 soit 61.6%</span>
</pre></div>
</div>
</div>
</div>
<span id="document-adressage/II_application_saisie"></span><div class="section" id="ii-application-de-saisie">
<h2>II- Application de saisie<a class="headerlink" href="#ii-application-de-saisie" title="Permalink to this heading"></a></h2>
<div class="section" id="triggers-et-fonctions">
<h3>1- Triggers et fonctions<a class="headerlink" href="#triggers-et-fonctions" title="Permalink to this heading"></a></h3>
<div class="section" id="module-d-aide-a-la-numerotation">
<h4>1.1 Module d’aide à la numérotation<a class="headerlink" href="#module-d-aide-a-la-numerotation" title="Permalink to this heading"></a></h4>
<p>Il existe deux types de numérotation différents :</p>
<ul class="simple">
<li><p>La numérotation <strong>classique</strong></p></li>
</ul>
<img alt="_images/numerotation_classique.png" src="_images/numerotation_classique.png" />
<p>Cette numérotation consiste à numéroter de deux en deux avec les numéros pairs à droite de la voie et les numéros impairs à gauche. C’est le système historique en France utilisé par une majorité des communes, notamment en ville.
L’inconvénient est que ce système n’est pas évolutif. En cas de nouvelles constructions s’intercalant entre deux numéros consécutifs il faut ajouter un numéro à extension (bis puis ter par exemple).</p>
<ul class="simple">
<li><p>La numérotation <strong>métrique</strong></p></li>
</ul>
<img alt="_images/numerotation_metrique.png" src="_images/numerotation_metrique.png" />
<p>Ce second système consiste à calculer le numéro en fonction de la distance depuis le début de la voie. Beaucoup plus évolutif car elle permet d’intercaler autant de numéros que l’on souhaite, cette numérotation permet également de donner une information précieuse sur la distance à parcourir jusqu’à la propriété. Cela est notamment très utile pour les secours ou les livreurs. Les numéros pairs et impairs peuvent être séparés de chaque côté de la voie, bien que ce ne soit pas obligatoire.</p>
<p>Quel que soit le type de numérotation choisi par la commune, l’application propose une aide à la numérotation automatique.</p>
<p>Pour la numérotation classique, une fonction soumet le numéro qu’elle considère être le plus juste à l’utilisateur en regardant les numéros déjà présents avant et après sur la voie. Au positionnement d’un premier point adresse à droite de la voie, l’outil proposera le n°2, puis pour un second le n°4 et ainsi de suite. À la création d’un point adresse entre le n°2 et le n°4, l’outil proposera un n°2 bis puis un n°2 ter etc.</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">DECLARE</span>
<span class="w">        </span><span class="n">numa</span><span class="w"> </span><span class="nb">integer</span><span class="p">;</span>
<span class="w">        </span><span class="n">numb</span><span class="w"> </span><span class="nb">integer</span><span class="p">;</span>
<span class="w">        </span><span class="n">numc</span><span class="w"> </span><span class="nb">integer</span><span class="p">;</span>
<span class="w">        </span><span class="n">sens</span><span class="w"> </span><span class="nb">boolean</span><span class="p">;</span>
<span class="w">        </span><span class="n">s</span><span class="w"> </span><span class="nb">text</span><span class="p">;</span>
<span class="w">        </span><span class="n">rec</span><span class="w"> </span><span class="nb">text</span><span class="p">;</span>
<span class="w">        </span><span class="n">suff</span><span class="w"> </span><span class="nb">text</span><span class="p">[];</span>
<span class="w">        </span><span class="n">idvoie</span><span class="w"> </span><span class="nb">integer</span><span class="p">;</span>
<span class="w">        </span><span class="n">isleft</span><span class="w"> </span><span class="nb">boolean</span><span class="p">;</span>
<span class="w">        </span><span class="n">test</span><span class="w"> </span><span class="nb">boolean</span><span class="p">;</span>

<span class="k">BEGIN</span>
<span class="w">        </span><span class="c1">-- Get idvoie</span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">get_id_voie</span><span class="p">(</span><span class="n">pgeom</span><span class="p">)</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">idvoie</span><span class="p">;</span>

<span class="c1">-- Aucune voie dévérouillée trouvée</span>
<span class="k">IF</span><span class="w"> </span><span class="n">idvoie</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">numc</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">idvoie</span><span class="p">;</span>
<span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>

<span class="k">SELECT</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">calcul_point_position</span><span class="p">(</span><span class="n">adresse</span><span class="p">.</span><span class="n">calcul_segment_proche</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">pgeom</span><span class="p">),</span><span class="n">pgeom</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">isleft</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">voie</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">statut_voie_num</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">FALSE</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">id_voie</span><span class="o">=</span><span class="n">idvoie</span><span class="p">;</span>

<span class="k">SELECT</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">sens_numerotation</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">sens</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">voie</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">id_voie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idvoie</span><span class="p">;</span>

<span class="k">SELECT</span><span class="w"> </span><span class="n">numero</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">numa</span>
<span class="k">FROM</span><span class="p">(</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">ST_Distance</span><span class="p">(</span><span class="n">pgeom</span><span class="p">,</span><span class="w"> </span><span class="n">p1</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">dist</span><span class="p">,</span><span class="w"> </span><span class="n">p1</span><span class="p">.</span><span class="n">numero</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">numero</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">point_adresse</span><span class="w"> </span><span class="n">p1</span><span class="p">,</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">voie</span><span class="w"> </span><span class="n">v</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">statut_voie_num</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">FALSE</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">p1</span><span class="p">.</span><span class="n">id_voie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idvoie</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">id_voie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idvoie</span><span class="w"> </span><span class="k">AND</span>
<span class="w">        </span><span class="p">(</span><span class="n">ST_LineLocatePoint</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">ST_ClosestPoint</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">pgeom</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ST_LineLocatePoint</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">ST_ClosestPoint</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">p1</span><span class="p">.</span><span class="n">geom</span><span class="p">)))</span><span class="w"> </span><span class="o">&gt;</span><span class="mi">0</span>
<span class="w">        </span><span class="k">AND</span>
<span class="w">        </span><span class="n">isleft</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">adresse</span><span class="p">.</span><span class="n">calcul_point_position</span><span class="p">(</span><span class="n">adresse</span><span class="p">.</span><span class="n">calcul_segment_proche</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">p1</span><span class="p">.</span><span class="n">geom</span><span class="p">),</span><span class="w"> </span><span class="n">p1</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>

<span class="n">suff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">ARRAY</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;bis&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ter&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;qua&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;qui&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;e&#39;</span><span class="p">];</span>

<span class="k">SELECT</span><span class="w"> </span><span class="n">numero</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">numb</span>
<span class="k">FROM</span><span class="p">(</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">ST_Distance</span><span class="p">(</span><span class="n">pgeom</span><span class="p">,</span><span class="w"> </span><span class="n">p1</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">dist</span><span class="p">,</span><span class="w"> </span><span class="n">p1</span><span class="p">.</span><span class="n">numero</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">numero</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">point_adresse</span><span class="w"> </span><span class="n">p1</span><span class="p">,</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">voie</span><span class="w"> </span><span class="n">v</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">statut_voie_num</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">FALSE</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">p1</span><span class="p">.</span><span class="n">id_voie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idvoie</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">id_voie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idvoie</span><span class="w"> </span><span class="k">AND</span>
<span class="w">        </span><span class="p">(</span><span class="n">ST_LineLocatePoint</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">ST_ClosestPoint</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">pgeom</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ST_LineLocatePoint</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">ST_ClosestPoint</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">p1</span><span class="p">.</span><span class="n">geom</span><span class="p">)))</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">0</span>
<span class="w">        </span><span class="k">AND</span>
<span class="w">        </span><span class="n">isleft</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">adresse</span><span class="p">.</span><span class="n">calcul_point_position</span><span class="p">(</span><span class="n">adresse</span><span class="p">.</span><span class="n">calcul_segment_proche</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">p1</span><span class="p">.</span><span class="n">geom</span><span class="p">),</span><span class="w"> </span><span class="n">p1</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>

<span class="k">IF</span><span class="w"> </span><span class="n">numa</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">numb</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">        </span><span class="n">test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="n">numb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">numa</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">         </span><span class="n">numc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numa</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>
<span class="w">        </span><span class="k">ELSE</span>
<span class="w">                </span><span class="n">FOREACH</span><span class="w"> </span><span class="n">rec</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="nb">ARRAY</span><span class="w"> </span><span class="n">suff</span><span class="w"> </span><span class="n">LOOP</span>
<span class="w">                        </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">TRUE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">point_adresse</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id_voie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idvoie</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">numero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numa</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">suffixe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rec</span><span class="p">)</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w">                              </span><span class="k">NOT</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">                                </span><span class="n">test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">                                </span><span class="n">numc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numa</span><span class="p">;</span>
<span class="w">                                </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rec</span><span class="p">;</span>
<span class="w">                        </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="w">                </span><span class="k">END</span><span class="w"> </span><span class="n">LOOP</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="k">ELSIF</span><span class="w"> </span><span class="n">numa</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">numb</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">        </span><span class="n">numc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numa</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>
<span class="k">ELSIF</span><span class="w"> </span><span class="n">numa</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">numb</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="n">numb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&gt;</span><span class="mi">0</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">                </span><span class="n">numc</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">numb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">        </span><span class="k">ELSIF</span><span class="w"> </span><span class="n">numb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">                </span><span class="n">test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">                </span><span class="n">FOREACH</span><span class="w"> </span><span class="n">rec</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="nb">ARRAY</span><span class="w"> </span><span class="n">suff</span><span class="w"> </span><span class="n">LOOP</span>
<span class="w">                        </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">TRUE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">point_adresse</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id_voie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idvoie</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">numero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numb</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">suffixe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rec</span><span class="p">)</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w">                              </span><span class="k">NOT</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">                                </span><span class="n">test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">                                </span><span class="n">numc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numb</span><span class="p">;</span>
<span class="w">                                </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rec</span><span class="p">;</span>
<span class="w">                        </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="w">                </span><span class="k">END</span><span class="w"> </span><span class="n">LOOP</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="k">ELSIF</span><span class="w"> </span><span class="n">numa</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">numb</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="n">isleft</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">sens</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">                </span><span class="n">numc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="k">ELSIF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">isleft</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">sens</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">                </span><span class="n">numc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">        </span><span class="k">ELSIF</span><span class="w"> </span><span class="n">isleft</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">sens</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">                </span><span class="n">numc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">        </span><span class="k">ELSIF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">isleft</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">sens</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">                </span><span class="n">numc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>

<span class="k">return</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">numc</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">idvoie</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>Pour la numérotation métrique, une fonction calcule la distance avec <code class="docutils literal notranslate"><span class="pre">ST_Length</span></code> et répartit aussi automatiquement les numéros pairs à droite et impairs à gauche. Via la variable <code class="docutils literal notranslate"><span class="pre">sens</span></code>, l’utilisateur peut sélectionner la voie qu’il a dessinée et la numéroter en sens inverse. L’application prend en compte cette information et calcule le nunéro “à l’envers”.</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">DECLARE</span>
<span class="w">        </span><span class="n">num</span><span class="w"> </span><span class="nb">integer</span><span class="p">;</span>
<span class="w">        </span><span class="n">idvoie</span><span class="w"> </span><span class="nb">integer</span><span class="p">;</span>
<span class="w">        </span><span class="n">numc</span><span class="w"> </span><span class="nb">integer</span><span class="p">;</span>
<span class="w">        </span><span class="n">sens</span><span class="w"> </span><span class="nb">boolean</span><span class="p">;</span>
<span class="w">        </span><span class="n">res</span><span class="w"> </span><span class="nb">text</span><span class="p">;</span>
<span class="w">        </span><span class="n">rec</span><span class="w"> </span><span class="nb">text</span><span class="p">;</span>
<span class="w">        </span><span class="n">isleft</span><span class="w"> </span><span class="nb">boolean</span><span class="p">;</span>
<span class="w">        </span><span class="n">test</span><span class="w"> </span><span class="nb">boolean</span><span class="p">;</span>
<span class="w">        </span><span class="n">suff</span><span class="w"> </span><span class="nb">text</span><span class="p">[];</span>
<span class="k">BEGIN</span>

<span class="c1">-- Get idvoie</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">get_id_voie</span><span class="p">(</span><span class="n">pgeom</span><span class="p">)</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">idvoie</span><span class="p">;</span>

<span class="c1">-- Aucune voie dévérouillée trouvée</span>
<span class="k">IF</span><span class="w"> </span><span class="n">idvoie</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">numc</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">idvoie</span><span class="p">;</span>
<span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>

<span class="k">SELECT</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">sens_numerotation</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">sens</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">voie</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">id_voie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idvoie</span><span class="p">;</span>

<span class="k">SELECT</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">calcul_point_position</span><span class="p">(</span><span class="n">adresse</span><span class="p">.</span><span class="n">calcul_segment_proche</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">pgeom</span><span class="p">),</span><span class="n">pgeom</span><span class="p">)</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">isleft</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">voie</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">statut_voie_num</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">FALSE</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">id_voie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idvoie</span><span class="p">;</span>

<span class="k">SELECT</span><span class="w"> </span><span class="n">round</span><span class="p">(</span><span class="n">ST_Length</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span><span class="o">*</span><span class="n">ST_LineLocatePoint</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">pgeom</span><span class="p">))::</span><span class="nb">integer</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">num</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">voie</span><span class="w"> </span><span class="n">v</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">id_voie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idvoie</span><span class="p">;</span>

<span class="n">suff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">ARRAY</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;bis&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ter&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;qua&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;qui&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;e&#39;</span><span class="p">];</span>

<span class="k">IF</span><span class="w"> </span><span class="n">isleft</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">num</span><span class="o">%</span><span class="mi">2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">sens</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">        </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="k">ELSIF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">isleft</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">num</span><span class="o">%</span><span class="mi">2</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">sens</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">        </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="k">ELSIF</span><span class="w"> </span><span class="n">isleft</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">num</span><span class="o">%</span><span class="mi">2</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">sens</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">        </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="k">ELSIF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">isleft</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">num</span><span class="o">%</span><span class="mi">2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">sens</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">        </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>

<span class="n">test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="n">WHILE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">LOOP</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">TRUE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">point_adresse</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id_voie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idvoie</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">numero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">                </span><span class="n">test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">                </span><span class="n">numc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num</span><span class="p">;</span>
<span class="w">        </span><span class="k">ELSE</span>
<span class="w">                </span><span class="n">FOREACH</span><span class="w"> </span><span class="n">rec</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="nb">ARRAY</span><span class="w"> </span><span class="n">suff</span><span class="w"> </span><span class="n">LOOP</span>
<span class="w">                        </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">TRUE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">point_adresse</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id_voie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idvoie</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">numero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">suffixe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rec</span><span class="p">)</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w">                               </span><span class="k">NOT</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">                                </span><span class="n">test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">                                </span><span class="n">numc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num</span><span class="p">;</span>
<span class="w">                                </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rec</span><span class="p">;</span>
<span class="w">                        </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="w">                </span><span class="k">END</span><span class="w"> </span><span class="n">LOOP</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="w">        </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>
<span class="k">END</span><span class="w"> </span><span class="n">LOOP</span><span class="p">;</span>

<span class="k">RETURN</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">numc</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">idvoie</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="outils-de-controle">
<h3>2- Outils de contrôle<a class="headerlink" href="#outils-de-controle" title="Permalink to this heading"></a></h3>
<p>Solution SIG permettant d’affiner et de réduire le temps de contrôle de saisie des agents et d’assurer un suivi interactif des données.</p>
<p>Lorsque les communes effectuent la saisie dans l’application cartographique dédiée du Département, elles doivent créer un ensemble de points adresses (numérotés) et de linéaires de voies (dénommés). Cette saisie doit respecter un ensemble de règles et de normes afin d’assurer la cohérence du plan d’adressage de la commune et de ses voisines (même type de numérotation, même sens de numérotation, etc.) et d’optimiser la prise en compte de ces adresses par les organismes remplissant des missions de services aux citoyens (repérage facilité pour les secours, limite de nombre de caractères pris en compte par les GPS, etc.).</p>
<p>De plus, la base de données fournie doit répondre à des normes de qualité sémantiques (nom unique, etc.) et géographiques (pas d’auto intersection de linéaires, points adresses localisés dans une parcelle, etc.).</p>
<div class="section" id="controles-postgis">
<h4>2.1 - Contrôles postgis<a class="headerlink" href="#controles-postgis" title="Permalink to this heading"></a></h4>
<p>Liste de défauts fréquemment rencontrés :</p>
<ul class="simple">
<li><p>Points adresse hors parcelles</p></li>
</ul>
<a class="reference internal image-reference" href="_images/2.1_erreur_hp.png"><img alt="_images/2.1_erreur_hp.png" src="_images/2.1_erreur_hp.png" style="width: 480px;" /></a>
<ul class="simple">
<li><p>Point adresse plus près d’une autre voie que celle à laquelle il est rattaché</p></li>
</ul>
<a class="reference internal image-reference" href="_images/2.1_erreur_adresse_voie.png"><img alt="_images/2.1_erreur_adresse_voie.png" src="_images/2.1_erreur_adresse_voie.png" style="width: 480px;" /></a>
<ul class="simple">
<li><p>Point adresse pair ou impair du mauvais côté de la voie</p></li>
</ul>
<a class="reference internal image-reference" href="_images/2.1_erreur_impair.png"><img alt="_images/2.1_erreur_impair.png" src="_images/2.1_erreur_impair.png" style="width: 480px;" /></a>
<ul class="simple">
<li><p>Erreurs de tracé de voies (ex : auto intersection)</p></li>
</ul>
<a class="reference internal image-reference" href="_images/2.1_erreur_trace.png"><img alt="_images/2.1_erreur_trace.png" src="_images/2.1_erreur_trace.png" style="width: 480px;" /></a>
<ul class="simple">
<li><p>Voie portant le même nom qu’une autre voie de la même commune</p></li>
</ul>
<a class="reference internal image-reference" href="_images/2.1_erreur_meme_nom_voie.png"><img alt="_images/2.1_erreur_meme_nom_voie.png" src="_images/2.1_erreur_meme_nom_voie.png" style="width: 480px;" /></a>
<ul class="simple">
<li><p>Voies avec un nom trop long</p></li>
</ul>
<a class="reference internal image-reference" href="_images/2.1_erreur_nom_trop_long.png"><img alt="_images/2.1_erreur_nom_trop_long.png" src="_images/2.1_erreur_nom_trop_long.png" style="width: 480px;" /></a>
<p>Sur la base de cette liste, un ensemble de scripts SQL permet d’identifier automatiquement ces différents cas :</p>
<ol class="arabic simple">
<li><p>Détecter automatiquement des erreurs de saisie sémantiques dans les données adresse</p></li>
<li><p>Détecter les erreurs de saisie géométrique</p></li>
<li><p>Produire un bilan sur l’ensemble des données de référence.</p></li>
</ol>
<p>Les scripts listés sont disponibles ici :<a class="reference external" href="https://github.com/sig14/sig14.github.io/blob/master/adressage/sql/outils_controles.sql">Scripts de contrôle</a></p>
<p>Description des scripts</p>
<p><strong>adresse.f_point_voie_distant()</strong></p>
<p><em>Synopsis</em></p>
<p>Fonction trigger adresse.f_point_voie_distant()
Identifie les points adresse plus près d’une autre voie que celle à laquelle ils appartiennent et retourne la distance entre le point et sa voie de rattachement.</p>
<p><em>Description</em></p>
<p>Retourne un BOOLEAN dans le champ c_erreur_dist_voie» de la table point_adresse.
Retourne un Integer dans le champ « c_dist_voie» de la table point_adresse.
Elle identifie ainsi la voie la plus proche dans un rayon de 10 km autour du point. Si la voie identifiée contient un « id_voie » différent de celui du point, la fonction retourne TRUE, sinon FALSE.</p>
<p>Elle calcule également la distance entre le point adresse et sa voie de rattachement.
Cette fonction se déclenche à chaque modification de la table point_adresse au niveau de la ligne modifiée.</p>
<a class="reference internal image-reference" href="_images/2.1_f1.png"><img alt="_images/2.1_f1.png" src="_images/2.1_f1.png" style="width: 480px;" /></a>
<p><strong>adresse.point_proj()</strong></p>
<p><em>Synopsis</em></p>
<p>Fonction adresse. point_proj (ptgeom geometry, ptgeom_proj geometry);
Projette un point sur la voix de rattachement du point adresse.</p>
<p><em>Description</em></p>
<p>Retourne une géométrie point dans un champ nommé « geom_pt_proj».
Elle crée un point à partir de la localisation du point le plus proche du point adresse d’entrée, sur la ligne possédant le même id_voie que ce point d’entrée.
Fonctions postgis mobilisées :
•       ST_LineLocatePoint(voie.geom, point_adresse.geom) -&gt; float between 0 and 1
•       ST_LineInterpolatePoint(voie.geom, float between 0 and 1)</p>
<a class="reference internal image-reference" href="_images/2.1_f2.png"><img alt="_images/2.1_f2.png" src="_images/2.1_f2.png" style="width: 480px;" /></a>
<p><strong>adresse.segment_prolong()</strong></p>
<p><em>Synopsis</em></p>
<p>Fonction trigger adresse.segment_prolong(pgeom geometry, idv integer);
Dessine un segment prolongé du point adresse au point projeté.</p>
<p><em>Description</em></p>
<p>Retourne une géométrie ligne dans un champ nommé « geom_segment_prolong».
Dessine un segment du point adresse à un point projeté au 50/49e de la distance entre le point adresse et son point projeté.
Fonctions postgis mobilisées :
•       ST_DISTANCE(ptgeom,ptgeom_proj) as distance_pt
•       ST_AZIMUTH(ptgeom,ptgeom_proj) as azimuth_pt
•       ST_TRANSLATE (ptgeom, sinus(azimuth_pt) * distance_pt + 50/49 distance_pt, cosinus(azimuth_pt)*distance_pt+50/49 distance_pt as translation_pt
•       ST_MakeLine(ptgeom, translation_pt)</p>
<a class="reference internal image-reference" href="_images/2.1_f3.png"><img alt="_images/2.1_f3.png" src="_images/2.1_f3.png" style="width: 480px;" /></a>
<p><strong>adresse.f_cote_voie()</strong></p>
<p><em>Synopsis</em></p>
<p>Fonction adresse.f_cote_voie(idv integer, geom_segment geometry);</p>
<p>Indique la position du point par rapport à sa voie de rattachement : droite, gauche, indéfinie. Sinon problème (voie mal tracée, point non rattaché à une voie, …)</p>
<p><em>Description</em></p>
<p>Retourne du texte dans un champ nommé « cote_voie».</p>
<p>Elle identifie si le segment prolongé créé à partir du point projeté sur la voie de rattachement du point adresse, croise la ligne à gauche, à droite, ne croise pas ou croise plusieurs fois.</p>
<p>Fonction postgis mobilisée :
•       ST_LineCrossingDirection(geom_segment, voie_geom)</p>
<a class="reference internal image-reference" href="_images/2.1_f4.png"><img alt="_images/2.1_f4.png" src="_images/2.1_f4.png" style="width: 480px;" /></a>
<p><strong>adresse.c_erreur_cote_parite()</strong></p>
<p><em>Synopsis</em></p>
<p>Fonction adresse.c_erreur_cote_parite(numero integer, cote_voie  geometry);</p>
<p>Identifie si le point adresse est pair ou impair et du mauvais côté de la voie à laquelle il est rattaché : true (erreur coté), false (pas derreur) ou indefini.</p>
<p>Sinon problème (voie mal tracée, point non rattaché à une voie, …)</p>
<p><em>Description</em></p>
<p>Retourne du texte dans un champ nommé « erreur_cote_parite».</p>
<p>Elle identifie si le côté duquel se trouve le point adresse correspond à la parité de son numéro.</p>
<p><em>Exemple</em>
Le numéro 5 impair se trouve du coté droit.
•       Erreur_cote_parite = True</p>
<p><strong>adresse.f_erreur_cote_parite()</strong></p>
<p><em>Synopsis</em></p>
<p>Fonction trigger adresse.f_erreur_cote_parite();  Identifie les points adresse pairs ou impairs du mauvais côté de la voie, à gauche ou à droite.</p>
<p><em>Description</em></p>
<p>Retourne un BOOLEAN dans le champ « c_erreur_cote_parite» de la table point_adresse. Elle identifie ainsi si le point adresse créé est à gauche ou à droite de la voie.</p>
<p>Si le point adresse est pair, mais à gauche de la voie ou si le point adresse est impair mais à droite de la voie, la fonction retourne TRUE, sinon FALSE.</p>
<p>Sinon indefini. Sinon problème (voie mal tracée, point non rattaché à une voie, …)</p>
<p>La fonction se déclenche à chaque modification du « geom » du point et s’éffectue en 4 étapes :
1-      Projection du point adresse sur sa voie de rattachement
•       adresse.point_proj(pgeom geometry, idv integer)
2-      Dessin d’un segment prolongé au 50/49 de la taille du segment initial.
•       adresse.point_segment_prolong(pgeom geometry, idv integer)
3-      Identification du sens de croisement du segment prolongé
•       adresse.f_cote_voie(idv integer, geom_segment geometry)
4-      Comparaison avec le numéro du point adresse d’origine.
•       adresse.c_erreur_cote_parite(numero integer, cote_voie  geometry)</p>
<a class="reference internal image-reference" href="_images/2.1_f5.png"><img alt="_images/2.1_f5.png" src="_images/2.1_f5.png" style="width: 480px;" /></a>
<p><strong>adresse.segment_extract()</strong></p>
<p><em>Synopsis</em></p>
<p>Fonction adresse.segment_extract(table_name varchar, id_line varchar, geom_line varchar);</p>
<p>Extrait des segments à partir de polylignes.</p>
<p><em>Description</em></p>
<p>Retourne une table composée de 3 champs ( id bigint,  id_voie integer, geom_segment geometry).</p>
<p>Sélectionne les nœuds des voies. Puis trace des lignes entre les différents nœuds créés.
Fonctions postgis mobilisées :
•       ST_DumpPoints(voie_geom)
•       ST_makeline()</p>
<a class="reference internal image-reference" href="_images/2.1_f6.png"><img alt="_images/2.1_f6.png" src="_images/2.1_f6.png" style="width: 480px;" /></a>
<p><strong>adresse.line_rotation()</strong></p>
<p><em>Synopsis</em></p>
<p>Fonction adresse.line_rotation( lgeom geometry);</p>
<p>Retourne les segments au niveau de leur centroide raccourcis de 2/3</p>
<p><em>Description</em></p>
<p>Retourne une géométrie de lignes dans un champ nommé « geom_rotate».</p>
<p>Elle effectue une rotation à 80,1 degrès d’1/3 du segment au niveau de son centroide.
Fonction postgis mobilisées :
•       ST_LineSubstring(lgeom, 0.333 ::real, 0.666::real) as substring
•       ST_centroid(lgeom) as centroid
•       st_rotate(substring, centroid) as rotate
•       ST_CollectionExtract(rotate)</p>
<a class="reference internal image-reference" href="_images/2.1_f7.png"><img alt="_images/2.1_f7.png" src="_images/2.1_f7.png" style="width: 480px;" /></a>
<p><strong>adresse.f_voie_erreur_trace()</strong></p>
<p><em>Synopsis</em></p>
<p>Fonction adresse.f_voie_erreur_trace();
Identifier les voies avec erreur de tracés (plusieurs passages de lignes, voies recourbées sur elles-mêmes, etc.)</p>
<p><em>Description</em></p>
<p>Retourne un BOOLEAN dans le champ « c_erreur_trace» de la table adresse.voie.</p>
<p>Elle identifie ainsi si la voie qui croise plusieurs fois un segment retourné. La voie croise plusieurs fois, la fonction retourne TRUE, sinon FALSE.</p>
<p>La fonction se déclenche à chaque modif/ajout du « geom » de la voie et s’effectue en 3 étapes :
1-      Extrait des segments à partir de polylignes
•       adresse.segment_extract(table_name varchar, id_line varchar, geom_line varchar
2-      Retourne les segments au niveau de leur centroides raccourcis de 2/3
•       adresse.line_rotation( lgeom geometry);
3-      Identification du sens de croisement du segment prolongé
•       ST_LineCrossingDirection(New.geom, geom_rotate)</p>
<a class="reference internal image-reference" href="_images/2.1_f8.png"><img alt="_images/2.1_f8.png" src="_images/2.1_f8.png" style="width: 480px;" /></a>
<p><strong>adresse.f_bilan_pt_parcelle()</strong></p>
<p><em>Synopsis</em></p>
<p>Fonction adresse.f_bilan_pt_parcelle();
Bilan du nombre de points adresse et dernière date de modification d’un point par parcelle.</p>
<p><em>Description</em></p>
<p>Retourne un integer dans le champ « nb_pt_adresse» et une DATE dans le champ « date_pt_modif »  de la table adresse.parcelle.</p>
<p>Elle compte d’abord le nombre d’id point adresse par parcelle. Puis ajoute la date de modification associée nulle ou la plus récente.</p>
<p>La fonction se déclenche à chaque modif/ajout du « geom » du point adresse.</p>
<a class="reference internal image-reference" href="_images/2.1_f9.png"><img alt="_images/2.1_f9.png" src="_images/2.1_f9.png" style="width: 480px;" /></a>
<p><strong>adresse.f_commune_repet_nom_voie()</strong></p>
<p><em>Synopsis</em></p>
<p>Fonction trigger adresse.f_commune_repet_nom_voie();</p>
<p>Identifie les voies portant le même nom qu’une autre voie de la même commune.</p>
<p><em>Description</em></p>
<p>Retourne un BOOLEAN dans un champ nommé « c-repet-nom_voie» de la table adresse.voie.</p>
<p>Elle sélectionne le nom des communes, le nom des voies et le nombre d’itération du nom des voies par commune.</p>
<p>Si aucun nom n’est répertorié elle retournera FALSE sinon TRUE.</p>
<p>Elle se déclenche à chaque création ou modification d’une valeur du champ nom.</p>
<a class="reference internal image-reference" href="_images/2.1_f10.png"><img alt="_images/2.1_f10.png" src="_images/2.1_f10.png" style="width: 480px;" /></a>
<p><strong>adresse.f_controle_longueur_nom()</strong></p>
<p><em>Synopsis</em></p>
<p>Fonction trigger adresse.f_controle_longueur_nom() ;</p>
<p>Identifie les voies portant un nom de plus de 24 caractères.</p>
<p><em>Description</em></p>
<p>Retourne un BOOLEAN dans un champ nommé « c_long_nom» de la table adresse.voie.</p>
<p>Si le nom de la voie fait plus de 24 caractères la fonction retournera TRUE sinon FALSE</p>
<p>Elle se déclenche à chaque création ou modification d’une valeur du champ nom.</p>
<a class="reference internal image-reference" href="_images/2.1_f11.png"><img alt="_images/2.1_f11.png" src="_images/2.1_f11.png" style="width: 480px;" /></a>
<p><strong>adresse.f_voie_double_saisie()</strong></p>
<p><em>Synopsis</em></p>
<p>Fonction trigger adresse.f_voie_double_saisie() ;</p>
<p>Identifie les voies saisies en 2 fois.</p>
<p><em>Description</em></p>
<p>Retourne un BOOLEAN dans un champ nommé « c_saisie_double» de la table adresse.voie.</p>
<p>Cette requête retourne les voies à moins de 500 mètres de la nouvelle voie créée et dont le nom est proche de celui-ci. Si aucune voie n’est répertoriée elle retournera FALSE sinon TRUE.</p>
<p>Elle se déclenche à chaque création ou modification sur la table voie.</p>
<a class="reference internal image-reference" href="_images/2.1_f12.png"><img alt="_images/2.1_f12.png" src="_images/2.1_f12.png" style="width: 480px;" /></a>
</div>
<div class="section" id="dashboard-qgis">
<h4>2.2 - Dashboard QGis<a class="headerlink" href="#dashboard-qgis" title="Permalink to this heading"></a></h4>
<p>Tableau de bord de suivi des indicateurs clés du projet, intégré aux logiciels SIG utilisés quotidiennement par les équipes et les partenaires.</p>
<a class="reference internal image-reference" href="_images/intro.png"><img alt="_images/intro.png" src="_images/intro.png" style="width: 728.0px; height: 377.5px;" /></a>
<p><strong>Un outil de suivi intégré</strong></p>
<p>Au sein du pôle SIG, nous souhaitions obtenir une vue d’ensemble des données produites au fur et à mesure de l’avancement du projet. Il fallait donc identifier une solution SIG permettant d’assurer un suivi interactif des données (contrôle des erreurs de saisies et bilan de l’avancement du projet).
Elle devait s’intégrer au logiciel QGIS utilisé par le chargé de mission SIG du Département et sur l’application cartographique Lizmap à disposition des communes et des partenaires.</p>
<p>Nous nous sommes appuyés sur une méthodologie publiée sur le site &lt;<a class="reference external" href="https://plugins.QGIS.org/geopackages/5/">https://plugins.QGIS.org/geopackages/5/</a>&gt; (Sutton, 2020) , afin de développer un « dashboard » par manipulation des étiquettes de couches QGIS.</p>
<p>Cette méthode permet, en créant une couche spécifique de tableau de bord, de paramétrer le style des étiquettes de la couche et via requêtes sql d’agrégation, de produire un tableau interactif de suivi des données présentes dans le projet QGIS.</p>
<p><strong>Les étapes de construction du dashboard</strong></p>
<p><em>Etape 1 : création de la couche dashboard</em></p>
<p>Créer une couche « dashboard » de polygones composée des champs suivant :</p>
<a class="reference internal image-reference" href="_images/1_champs_dashboard.png"><img alt="_images/1_champs_dashboard.png" src="_images/1_champs_dashboard.png" style="width: 334.0px; height: 239.5px;" /></a>
<p><em>Etape 2 : créer un polygone</em></p>
<p>Éditer la couche « dashboard » et créer un polygone suivant l’emprise du projet.</p>
<a class="reference internal image-reference" href="_images/2_polygon_dashboard.png"><img alt="_images/2_polygon_dashboard.png" src="_images/2_polygon_dashboard.png" style="width: 960.0px; height: 515.0px;" /></a>
<p><em>Etape 3 : symbologie de la couche</em></p>
<p>Ouvrir les propriétés de la couche dashboard et dans l’onglet symbologie sélectionner ‘aucun symbole’.</p>
<p>Le polygone doit disparaître à l’écran.</p>
<a class="reference internal image-reference" href="_images/3_symbologie_dashboard.png"><img alt="_images/3_symbologie_dashboard.png" src="_images/3_symbologie_dashboard.png" style="width: 816.5px; height: 416.5px;" /></a>
<p><em>Etape 4 : paramétrer les étiquettes</em></p>
<p>Sélectionner ‘Etiquettes simples’ dans l’onglet Étiquettes. Dans le sous onglet valeur, faites une sélection par expression et inscrivez le code suivant : <cite>eval( “label_expression”)</cite></p>
<a class="reference internal image-reference" href="_images/4_etiquettes_dashboard.png"><img alt="_images/4_etiquettes_dashboard.png" src="_images/4_etiquettes_dashboard.png" style="width: 816.5px; height: 416.5px;" /></a>
<p>Dans le sous-onglet texte cliquer sur l’icône à droite de la police. Aller chercher type de champ et pointer vers le champ <strong>font</strong> de la table « dashboard » créée à l’étape 1.</p>
<a class="reference internal image-reference" href="_images/5_etiquettes_dashboard.png"><img alt="_images/5_etiquettes_dashboard.png" src="_images/5_etiquettes_dashboard.png" style="width: 816.5px; height: 416.5px;" /></a>
<p>Faire de même avec le <strong>style</strong> et pointer sur le champ style.</p>
<a class="reference internal image-reference" href="_images/6_etiquettes_dashboard.png"><img alt="_images/6_etiquettes_dashboard.png" src="_images/6_etiquettes_dashboard.png" style="width: 816.5px; height: 416.5px;" /></a>
<p>Faire de même avec la <strong>couleur</strong> et pointer sur le champ _**font_color**_.</p>
<a class="reference internal image-reference" href="_images/7_etiquettes_dashboard.png"><img alt="_images/7_etiquettes_dashboard.png" src="_images/7_etiquettes_dashboard.png" style="width: 816.5px; height: 416.5px;" /></a>
<p>Aller maintenant dans l’onglet <strong>arrière-plan.</strong></p>
<p>Faire de même que précédemment avec la <strong>taille X</strong> et pointer sur le champ _**width**_.</p>
<a class="reference internal image-reference" href="_images/8_etiquettes_dashboard.png"><img alt="_images/8_etiquettes_dashboard.png" src="_images/8_etiquettes_dashboard.png" style="width: 816.5px; height: 459.5px;" /></a>
<p>Faire de même que précédemment avec la <strong>taille Y</strong> et pointer sur le champ _**height**_.</p>
<a class="reference internal image-reference" href="_images/9_etiquettes_dashboard.png"><img alt="_images/9_etiquettes_dashboard.png" src="_images/9_etiquettes_dashboard.png" style="width: 816.5px; height: 459.5px;" /></a>
<p>Faire de même avec la <strong>couleur de remplissage</strong> et pointer sur le champ _**bg_colour**_.</p>
<a class="reference internal image-reference" href="_images/10_etiquettes_dashboard.png"><img alt="_images/10_etiquettes_dashboard.png" src="_images/10_etiquettes_dashboard.png" style="width: 816.5px; height: 459.5px;" /></a>
<p>Aller maintenant dans l’onglet <strong>position</strong>.</p>
<p>Choisir l’option quadrant de l’image ci-dessous.</p>
<p>Cliquer sur l’icône à droite de <strong>décalage X,Y</strong>. Choisissez cette fois-ci la sélection par expression.</p>
<p>Dans le constructeur de requête qui s’ouvre, indiquer la variable suivante : <cite>array( “label_offset_x” , “label_offset_y”)</cite>
Appuyer sur ok.</p>
<a class="reference internal image-reference" href="_images/11_etiquettes_dashboard.png"><img alt="_images/11_etiquettes_dashboard.png" src="_images/11_etiquettes_dashboard.png" style="width: 500.0px; height: 281.0px;" /></a>
<p>Pour finir, afin de fixer les étiquettes selon l’emprise de la carte, cocher la case <strong>générateur de géométrie</strong> et inscrire l’expression suivante : start_point( &#64;map_extent )</p>
<a class="reference internal image-reference" href="_images/last_emprise_carte_expression.png"><img alt="_images/last_emprise_carte_expression.png" src="_images/last_emprise_carte_expression.png" style="width: 827.0px; height: 400.5px;" /></a>
<p><em>Etape 5 : Remplir les champs de la table attributaire</em></p>
<p>Revenir à la table attributaire de « dashboard ».</p>
<p>Donner un nom qui mette en évidence l’action. Ici le titre de la première étiquette que nous appellerons fenêtre dashboard.</p>
<p>Puis indiquer dans le champ “label expression” l’expression qui s’affichera dans la première fenêtre dashboard, ici, simplement le titre <strong>‘nbr pt total’</strong></p>
<a class="reference internal image-reference" href="_images/12_1rst_fenetre_dashboard.png"><img alt="_images/12_1rst_fenetre_dashboard.png" src="_images/12_1rst_fenetre_dashboard.png" style="width: 500.0px; height: 35.5px;" /></a>
<p>Paramétrer ensuite les champs qui vont déterminer la taille, la position, la couleur de fond et la police de la première fenêtre Dashboard.</p>
<a class="reference internal image-reference" href="_images/12_1rst_fenetre_suite_dashboard.png"><img alt="_images/12_1rst_fenetre_suite_dashboard.png" src="_images/12_1rst_fenetre_suite_dashboard.png" style="width: 500.0px; height: 25.5px;" /></a>
<p>Au fur et à mesure des modifications des valeurs de champ, lorsque vous enregistrez, vous devez voir apparaître la 1ere fenêtre Dashboard et les modifications apportées.</p>
<a class="reference internal image-reference" href="_images/12_1rst_fenetre_vue.png"><img alt="_images/12_1rst_fenetre_vue.png" src="_images/12_1rst_fenetre_vue.png" style="width: 250.0px; height: 42.5px;" /></a>
<p>Si aucune fenêtre n’apparaît au niveau de votre projet QGIS, jouez avec les différents champs (surtout label_offset x, label_offset y), cela peut être un problème de position de la fenêtre. Si elle n’apparaît toujours pas, reprenez les étapes précédentes.</p>
<p><em>Etape 6 : Créer de nouvelles fenêtres dashboard</em></p>
<p>Pour créer une nouvelle fenêtre dashboard, passer la table attributaire en mode édition. Copier la première ligne et coller la dans la partie blanche de la table attributaire. Une deuxième ligne identique apparaît.</p>
<a class="reference internal image-reference" href="_images/13_2nd_fenetre_dashboard.png"><img alt="_images/13_2nd_fenetre_dashboard.png" src="_images/13_2nd_fenetre_dashboard.png" style="width: 500.0px; height: 38.0px;" /></a>
<p><em>Etape 7 : Paramétrer des requêtes dans les nouvelles lignes</em></p>
<p>Une fois la nouvelle entité créée, modifier les valeurs de champ de la seconde pour positionner la deuxième fenêtre sous la première.  Vous pouvez modifier le champ label_expression avec une requête sql qgis qui vous permettra d’afficher la valeur souhaitée dans cette deuxième fenêtre.</p>
<a class="reference internal image-reference" href="_images/14_2nd_fenetre_vue.png"><img alt="_images/14_2nd_fenetre_vue.png" src="_images/14_2nd_fenetre_vue.png" style="width: 150.0px; height: 42.0px;" /></a>
<p><em>Exemple de table attributaire dashboard et rendu</em></p>
<p>Ci-dessous, nous avons organisé la table avec une fenêtre par ligne comme suit : une 1ère fenêtre avec valeur « titre » suivie d’une fenêtre affichant une valeur « expression ».</p>
<a class="reference internal image-reference" href="_images/15_ex_table_attrib.png"><img alt="_images/15_ex_table_attrib.png" src="_images/15_ex_table_attrib.png" style="width: 500.0px; height: 185.5px;" /></a>
<a class="reference internal image-reference" href="_images/16_ex_table_attrib_suite.png"><img alt="_images/16_ex_table_attrib_suite.png" src="_images/16_ex_table_attrib_suite.png" style="width: 500.0px; height: 236.5px;" /></a>
<p><em>Exemple de requêtes utilisées</em></p>
<p>1- Total de la somme des valeurs de la colonne pt_total de la couche Infos Communes</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">aggregate</span><span class="p">(</span><span class="n">layer</span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Infos Communes&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">aggregate</span><span class="p">:</span><span class="o">=</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">expression</span><span class="p">:</span><span class="o">=</span><span class="n">pt_total</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p>2- Total de la somme des valeurs de la colonne pt_total des entités sélectionnées sur la couche Infos Communes</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">aggregate</span><span class="p">(</span><span class="n">layer</span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Infos Communes&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">aggregate</span><span class="p">:</span><span class="o">=</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">expression</span><span class="p">:</span><span class="o">=</span><span class="n">pt_total</span><span class="p">,</span><span class="w"> </span><span class="n">filter</span><span class="p">:</span><span class="o">=</span><span class="n">is_selected</span><span class="p">(</span><span class="s1">&#39;Infos Communes&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;$&#39;</span><span class="n">currentfeature</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p>3- Nombre de communes accompagnées (champ : actif, valeur : oui) dans la couche Infos Communes</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">aggregate</span><span class="p">(</span><span class="n">layer</span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Infos Communes&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">aggregate</span><span class="p">:</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">expression</span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">actif</span><span class="p">,</span><span class="w"> </span><span class="n">filter</span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">actif</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;Oui&#39;</span><span class="w"> </span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p><em>Exemple de rendu</em></p>
<p>Le dashboard est utilisé par le pôle SIG afin de contrôler les erreurs de saisies en temps réel par les communes et présenter un bilan général de l’avancement du projet.</p>
<p>Ci-dessous, un exemple d’affichage des bilans adresses (en haut à droite) après sélection d’une commune sous QGIS.</p>
<a class="reference internal image-reference" href="_images/qgis_dashboard.gif"><img alt="_images/qgis_dashboard.gif" src="_images/qgis_dashboard.gif" style="width: 960.0px; height: 515.0px;" /></a>
</div>
</div>
</div>
<span id="document-adressage/III_consultation_exports"></span><div class="section" id="iii-consulter-et-exporter-les-donnees-adresses-depuis-qgis">
<h2>III- Consulter et exporter les données “Adresses” depuis QGIS<a class="headerlink" href="#iii-consulter-et-exporter-les-donnees-adresses-depuis-qgis" title="Permalink to this heading"></a></h2>
<div class="section" id="outils-d-export">
<h3>1- Outils d’export<a class="headerlink" href="#outils-d-export" title="Permalink to this heading"></a></h3>
<div class="section" id="export-bal-qgis">
<h4>1.1 Export BAL QGIS<a class="headerlink" href="#export-bal-qgis" title="Permalink to this heading"></a></h4>
<p>Création d’une commande QGIS pour exporter les données points adresses et voies par commune avec un simple clik bouton.</p>
<p><strong>Etape 1 : ouverture de la console action</strong></p>
<p>Ouvrir la console « action » depuis les propriétés de la couche Commune (ici la couche <code class="docutils literal notranslate"><span class="pre">Accompagnement</span></code>  alias du projet de la table <code class="docutils literal notranslate"><span class="pre">adresse.commune</span></code>).</p>
<p><strong>Etape 2 : paramétrer l’action</strong></p>
<p>Donner un nom à l’action et coller, paramétrer l’action et inscrire le code python dans la console.</p>
<img alt="_images/export_qgis1.png" src="_images/export_qgis1.png" />
<p>Le code python pour l’export des points adresse est le suivant :</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># importer les biblihotèques</span>
<span class="kn">from</span> <span class="nn">qgis.utils</span> <span class="kn">import</span> <span class="n">iface</span>
<span class="kn">from</span> <span class="nn">qgis.core</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">qgis.gui</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">layer</span> <span class="o">=</span> <span class="n">iface</span><span class="o">.</span><span class="n">activeLayer</span><span class="p">()</span> <span class="c1"># garde en memoire  la couche active</span>
<span class="n">selection</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">selectedFeatures</span><span class="p">()</span> <span class="c1"># garde en memoire  les entités sélectionnées</span>
<span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>  <span class="c1"># boucle sur les couches sélectionnées</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">feat</span><span class="p">[</span><span class="s1">&#39;Code INSEE&#39;</span><span class="p">]</span> <span class="c1"># garde en memoire  les valeurs du champs code insee</span>
<span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
        <span class="n">value2</span> <span class="o">=</span> <span class="n">feat</span><span class="p">[</span><span class="s1">&#39;Commune&#39;</span><span class="p">]</span> <span class="c1"># garde en memoire  les valeurs du champs commune</span>
<span class="n">cl</span> <span class="o">=</span> <span class="n">QgsProject</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">mapLayersByName</span><span class="p">(</span><span class="s1">&#39;v_export_pts&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># garde en memoire  la couche dénommée</span>
<span class="n">iface</span><span class="o">.</span><span class="n">setActiveLayer</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span> <span class="c1"># active la couche</span>
<span class="n">cl</span><span class="o">.</span><span class="n">selectByExpression</span><span class="p">(</span> <span class="s2">&quot; </span><span class="se">\&quot;</span><span class="s2">Code INSEE</span><span class="se">\&quot;</span><span class="s2"> = &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">QgsVectorLayer</span><span class="o">.</span><span class="n">SetSelection</span><span class="p">)</span> <span class="c1"># séléctionne les entités dont le champs code INSEE est égal à la valeur du champs code insee de la première couche</span>
<span class="n">output_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;G:\DDTFE\ST\POLE_SIG\01_PROJETS_SIG\12_Adressage_BAN\02_PROJETS_COMMUNES\Export\export_points\</span><span class="si">%s</span><span class="s1">_Export_points.csv&#39;</span> <span class="o">%</span> <span class="n">value2</span> <span class="c1"># definit le chemin d&#39;export avec la variable value2 dans le nom</span>
<span class="n">QgsVectorFileWriter</span><span class="o">.</span><span class="n">writeAsVectorFormat</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;UTF-8&quot;</span><span class="p">,</span> <span class="n">driverName</span><span class="o">=</span><span class="s2">&quot;CSV&quot;</span><span class="p">,</span> <span class="n">onlySelected</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Exporte les entité selectionnées</span>
<span class="n">iface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">pushMessage</span><span class="p">(</span><span class="s2">&quot;Export réalisé avec succès vers G/POLE_SIG/12_Adressage_BAN/02_PROJETS_COMMUNES/Export&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p>Le code python pour l’export des voies est le suivant :</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">qgis.utils</span> <span class="kn">import</span> <span class="n">iface</span>
<span class="kn">from</span> <span class="nn">qgis.core</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">qgis.gui</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">layer</span> <span class="o">=</span> <span class="n">iface</span><span class="o">.</span><span class="n">activeLayer</span><span class="p">()</span>
<span class="n">selection</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">selectedFeatures</span><span class="p">()</span>
<span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">feat</span><span class="p">[</span><span class="s1">&#39;Code INSEE&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
        <span class="n">value2</span> <span class="o">=</span> <span class="n">feat</span><span class="p">[</span><span class="s1">&#39;Commune&#39;</span><span class="p">]</span>
<span class="n">cl</span> <span class="o">=</span> <span class="n">QgsProject</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">mapLayersByName</span><span class="p">(</span><span class="s1">&#39;v_export_voies&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">iface</span><span class="o">.</span><span class="n">setActiveLayer</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span>
<span class="n">cl</span><span class="o">.</span><span class="n">selectByExpression</span><span class="p">(</span> <span class="s2">&quot; </span><span class="se">\&quot;</span><span class="s2">Code INSEE</span><span class="se">\&quot;</span><span class="s2"> = &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">QgsVectorLayer</span><span class="o">.</span><span class="n">SetSelection</span><span class="p">)</span>
<span class="n">output_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;G:\DDTFE\ST\POLE_SIG\01_PROJETS_SIG\12_Adressage_BAN\02_PROJETS_COMMUNES\Export\export_voies\</span><span class="si">%s</span><span class="s1">_Export_voies.csv&#39;</span> <span class="o">%</span> <span class="n">value2</span>
<span class="n">QgsVectorFileWriter</span><span class="o">.</span><span class="n">writeAsVectorFormat</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;UTF-8&quot;</span><span class="p">,</span> <span class="n">driverName</span><span class="o">=</span><span class="s2">&quot;CSV&quot;</span><span class="p">,</span> <span class="n">onlySelected</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">iface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">pushMessage</span><span class="p">(</span><span class="s2">&quot;Export réalisé avec succès vers G/POLE_SIG/12_Adressage_BAN/02_PROJETS_COMMUNES/Export&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p><strong>Etape 3 : test exécution de l’action</strong></p>
<p>Sélectionner la couche en entrée et la commune pour laquelle vous voulez réaliser l’export. Et utiliser la commande action.</p>
<img alt="_images/export_qgis2.png" src="_images/export_qgis2.png" />
<p>Faire un clic droit sur la carte</p>
<img alt="_images/export_qgis3.png" src="_images/export_qgis3.png" />
</div>
</div>
</div>
<span id="document-adressage/IV_depot_bal"></span><div class="section" id="iv-deposer-une-bal-via-l-api-ban-avec-fme">
<h2>IV- Déposer une BAL via l’API BAN avec FME<a class="headerlink" href="#iv-deposer-une-bal-via-l-api-ban-avec-fme" title="Permalink to this heading"></a></h2>
<a class="reference internal image-reference" href="_images/FME_depot_bal.png"><img alt="_images/FME_depot_bal.png" src="_images/FME_depot_bal.png" style="width: 880px;" /></a>
<p>Etalab, via sa plateforme adresse.data.gouv.fr met à disposition une <strong>API</strong> permettant de déposer les mises à jour de <strong>Bases Adresses Locales</strong> dans la <strong>Base Adresse Nationale</strong>.</p>
<p><a class="reference external" href="https://github.com/BaseAdresseNationale/api-depot/wiki/Documentation">Documentation github de l’API de dépot</a>.</p>
<p>Les communes ou leurs représentants peuvent, avec un justificatif, obtenir une habilitation à déposer les fichiers adresses BAL sur un périmètre donné.</p>
<p>Ainsi, le Département du Calvados, dans le cadre de sa mission d’accompagnement à l’adressage des Communes, téléverse chaque nuit les fichiers BAL communaux certifiés par les Communes partenaires.</p>
<div class="section" id="boite-a-outils">
<h3>Boite à outils<a class="headerlink" href="#boite-a-outils" title="Permalink to this heading"></a></h3>
<p>La méthodologie développée ici s’appuie sur les travaux réalisés et publiés par <strong>l’Agglomération de la Région de Compiègne</strong> : <a class="reference external" href="https://github.com/sigagglocompiegne/rva/blob/master/api/doc_api_balc_fme.md">github de l’ARC</a>.</p>
<p>Elle repose sur le système de gestion de <strong>base de données PostgreSQL</strong> sous licence BSD et le logiciel <strong>ETL</strong> propriétaire <strong>FME</strong> développé par SAFE Software.</p>
<p>Ces développements ont été réalisés sous système d’exploitation Windows.</p>
</div>
<div class="section" id="ere-etape-preparation-des-donnees">
<h3>1ère Etape : Préparation des données<a class="headerlink" href="#ere-etape-preparation-des-donnees" title="Permalink to this heading"></a></h3>
<p>L’ensemble des données adresses mises à jours et certifiées quotidiennement par les Communes dans le cadre de l’accompagnement CD14 sont stockées dans une table (ici nommée <strong>adresse.v_bal_dept</strong>) au sein de la Base de Données SIG du Département.</p>
<p>Ces données sont structurées selont le modèle de données BAL attendu par l’API de dépot : <a class="reference external" href="https://aitf-sig-topo.github.io/voies-adresses/">ressources AITF voies-adresses</a>.</p>
<p>Un validateur en ligne permet de vérifier que les fichiers à déposer répondent bien à ce standart : <a class="reference external" href="https://adresse.data.gouv.fr/bases-locales/validateur">Validateur BAL adresse.data.gouv</a>.</p>
<a class="reference internal image-reference" href="_images/bal_dept.png"><img alt="_images/bal_dept.png" src="_images/bal_dept.png" style="width: 880px;" /></a>
<p>Un traitement FME enregistre chaque nuit les entités adresses de cette table par commune dans des fichiers CSV nommés avec la valeurs INSEE de chaque commune ayant certifié son adressage (illustration ci-dessous)</p>
<a class="reference internal image-reference" href="_images/enregistrement_csv_ban.png"><img alt="_images/enregistrement_csv_ban.png" src="_images/enregistrement_csv_ban.png" style="width: 383.0px; height: 231.5px;" /></a>
<p>Une seconde table de données regroupe l’ensemble des données adresses aglomérées à la Commune. Elle contient les champs suivants :</p>
<ul class="simple">
<li><p>L’INSEE de la commune</p></li>
<li><p>Le nom de la commune</p></li>
<li><p>Le nombre total de points adresses recencés le matin avant 6h00</p></li>
<li><p>Le nombre total de points adresses recencés le soir après 23h00</p></li>
<li><p>Le nombre total de points adresses modifiés dans la journée (comptabilisé le soir après 23h00)</p></li>
</ul>
<p>Les 3 derniers champs de cette table sont mis à jours quotidienement comme suit :</p>
<blockquote>
<div><dl>
<dt><strong>1-</strong> Mise en place de fichiers Batch pour exécution des script sql via psql</dt><dd><blockquote>
<div><div class="highlight-Batch notranslate"><div class="highlight"><pre><span></span><span class="p">@</span><span class="k">echo</span> off
<span class="k">CALL</span> D:\_cron_postgres\conf\config_db_pg.bat
<span class="k">setlocal</span>
<span class="k">set</span> <span class="nv">PGPASSWORD</span><span class="p">=</span><span class="nv">%PGPASSWORD%</span>
<span class="s2">&quot;D:\PostgreSQL\11\bin\psql.exe&quot;</span> -h <span class="nv">%PGHOSTNAME%</span> -U <span class="nv">%PGUSER%</span> -d <span class="nv">%PGROLE%</span> -p <span class="nv">%PGPORT%</span> -f D:\_cron_postgres\adressage\api_ban\scripts\count_pts_matin.sql
<span class="k">endlocal</span>
</pre></div>
</div>
</div></blockquote>
<p><strong>2-</strong> Ex2cution des script sql  suivants :</p>
<blockquote>
<div><ul>
<li><dl>
<dt>A 6h00 du matin* :</dt><dd><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Compte le nombre de points adresse par commune</span>
<span class="k">update</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">commune</span><span class="w"> </span><span class="k">set</span><span class="w">  </span><span class="n">nb_pts_matin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ct</span>
<span class="k">from</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="n">commune_insee</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ct</span><span class="p">,</span><span class="w"> </span><span class="n">commune_insee</span>
<span class="w">        </span><span class="k">from</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">v_bal_dept</span>
<span class="w">        </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">commune_insee</span>
<span class="w">        </span><span class="p">)</span><span class="n">b</span>
<span class="k">where</span><span class="w"> </span><span class="n">commune</span><span class="p">.</span><span class="n">insee_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">commune_insee</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt>A 23h00 le soir* :</dt><dd><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Remet le compte de points modifiés à null dans la table commune</span>
<span class="k">update</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">commune</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">nb_pts_modif_today</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">null</span><span class="p">;</span>

<span class="c1">-- Compte le nombre de points adresse modifié dans la journée (date now) par commune</span>
<span class="k">update</span><span class="w">  </span><span class="n">adresse</span><span class="p">.</span><span class="n">commune</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">nb_pts_modif_today</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ct</span>
<span class="k">from</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="n">commune_insee</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ct</span><span class="p">,</span><span class="w"> </span><span class="n">commune_insee</span>
<span class="w">        </span><span class="k">from</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">v_bal_dept</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">date_der_maj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NOW</span><span class="p">()::</span><span class="nb">DATE</span>
<span class="w">        </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">commune_insee</span>
<span class="w">        </span><span class="p">)</span><span class="n">b</span>
<span class="k">where</span><span class="w"> </span><span class="n">commune</span><span class="p">.</span><span class="n">insee_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">commune_insee</span><span class="p">;</span>

<span class="c1">-- Compte le nombre de points adresse par commune</span>
<span class="k">update</span><span class="w">  </span><span class="n">adresse</span><span class="p">.</span><span class="n">commune</span><span class="w"> </span><span class="k">set</span><span class="w">  </span><span class="n">nb_pts_soir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ct</span>
<span class="k">from</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="n">commune_insee</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ct</span><span class="p">,</span><span class="w"> </span><span class="n">commune_insee</span>
<span class="w">        </span><span class="k">from</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">v_bal_dept</span>
<span class="w">        </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">commune_insee</span>
<span class="w">        </span><span class="p">)</span><span class="n">b</span>
<span class="k">where</span><span class="w"> </span><span class="n">commune</span><span class="p">.</span><span class="n">insee_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">commune_insee</span><span class="p">;</span>
</pre></div>
</div>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="e-etape-chaine-de-traitement-fme">
<h3>2e Etape : Chaîne de traitement FME<a class="headerlink" href="#e-etape-chaine-de-traitement-fme" title="Permalink to this heading"></a></h3>
<p><em>Vous pouvez télécharger la dernière version du projet FME en cliquant sur le lien ci dessous :</em></p>
<p><a class="reference external" href="https://github.com/sig14/sig14.github.io/files/10873043/api_depot_bal.zip">Téléchargement du projet FME</a></p>
<div class="section" id="ajouter-les-donnees-sources">
<h4>2.1 - Ajouter les données sources<a class="headerlink" href="#ajouter-les-donnees-sources" title="Permalink to this heading"></a></h4>
<p>Ajout de la première table de données à l’échelle des communes dans le projet FME.</p>
<a class="reference internal image-reference" href="_images/1_FME_donnees_sources.png"><img alt="_images/1_FME_donnees_sources.png" src="_images/1_FME_donnees_sources.png" style="width: 214.0px; height: 168.0px;" /></a>
<p>Supprimer les champs inutiles. Ne garder que les champs suivants :</p>
<ul class="simple">
<li><p>Le nom  communes du département</p></li>
<li><p>Leurs code INSEE</p></li>
<li><p>Le nombre de points adresses total par commune actualisé chaque matin</p></li>
<li><p>Le nombre points adresses total par commune actualisé chaque soir</p></li>
<li><p>Le nombre de points modifié dans la journée actualisé chaque soir</p></li>
</ul>
</div>
<div class="section" id="ajouter-les-jetons-d-acces-api">
<h4>2.2 - Ajouter les jetons d’accès API<a class="headerlink" href="#ajouter-les-jetons-d-acces-api" title="Permalink to this heading"></a></h4>
<p>Utiliser le transformer <strong>AttributeCreator</strong>.
Créer un nouveau champs <strong>“jeton”</strong> et attribuer la valeur de votre jeton d’accès à l’API.</p>
<a class="reference internal image-reference" href="_images/2_FME_jeton_API.png"><img alt="_images/2_FME_jeton_API.png" src="_images/2_FME_jeton_API.png" style="width: 301.0px; height: 313.5px;" /></a>
</div>
<div class="section" id="selection-des-communes-avec-mises-a-jour-de-points-adresse">
<h4>2.3 - Sélection des communes avec mises à jour de points adresse<a class="headerlink" href="#selection-des-communes-avec-mises-a-jour-de-points-adresse" title="Permalink to this heading"></a></h4>
<a class="reference internal image-reference" href="_images/3_FME_verif_MAJ.png"><img alt="_images/3_FME_verif_MAJ.png" src="_images/3_FME_verif_MAJ.png" style="width: 580px;" /></a>
<p>Dans cette partie, nous ne conserverons que les communes dont au moins 1 point a été mis à jour dans la journée.</p>
<p>Pour cela :</p>
<ul class="simple">
<li><p>Ajouter le transformer <strong>testFilter</strong> pour ne garder que les communes dont le compte de points de la journée (<em>pts_modif_today</em>) est égal ou supérieur à 1.</p></li>
</ul>
<a class="reference internal image-reference" href="_images/4_FME_test_MAJ.png"><img alt="_images/4_FME_test_MAJ.png" src="_images/4_FME_test_MAJ.png" style="width: 337.5px; height: 319.5px;" /></a>
<ul class="simple">
<li><p>Supprimer ensuite les champs non nécessaires à l’agrégation, pour ne conserver que : <strong>le jeton</strong>,  <strong>le nom de la commune</strong> et <strong>le code insee</strong></p></li>
</ul>
</div>
<div class="section" id="selection-des-communes-avec-suppression-ou-ajout-de-points-adresse">
<h4>2.4 - Sélection des communes avec suppression ou ajout de points adresse<a class="headerlink" href="#selection-des-communes-avec-suppression-ou-ajout-de-points-adresse" title="Permalink to this heading"></a></h4>
<a class="reference internal image-reference" href="_images/5_FME_verif_ajout_supr.png"><img alt="_images/5_FME_verif_ajout_supr.png" src="_images/5_FME_verif_ajout_supr.png" style="width: 780px;" /></a>
<p>Dans cette partie, nous ne conserverons que les communes pour lesquelles des adresses ont été suprimées ou ajoutées.</p>
<p>Pour cela :</p>
<ul class="simple">
<li><p>Ajouter le transformer <strong>testFilter</strong> pour ne garder que les communes dont le compte de point du matin (<em>nb_pts_matin</em>) est différent du compte de point du soir (<em>nb_pts_soir</em>).</p></li>
</ul>
<a class="reference internal image-reference" href="_images/6_FME_test_ajout_supr.png"><img alt="_images/6_FME_test_ajout_supr.png" src="_images/6_FME_test_ajout_supr.png" style="width: 487.5px; height: 292.0px;" /></a>
<ul class="simple">
<li><p>Supprimer ensuite les champs non nécessaires à l’aggregation, pour ne conserver que : <strong>le jeton</strong>,  <strong>le nom de la commune</strong> et <strong>le code insee</strong></p></li>
</ul>
</div>
<div class="section" id="agregation-des-communes-filtrees">
<h4>2.5 - Agrégation des communes filtrées<a class="headerlink" href="#agregation-des-communes-filtrees" title="Permalink to this heading"></a></h4>
<p>Une fois les deux filtres éffectués, on agrége l’ensemble des données avec le transformer <strong>Aggregator</strong>.</p>
<a class="reference internal image-reference" href="_images/7_FME_aggregation_com.png"><img alt="_images/7_FME_aggregation_com.png" src="_images/7_FME_aggregation_com.png" style="width: 448.5px; height: 415.5px;" /></a>
</div>
<div class="section" id="requetes-a-l-api">
<h4>2.6 - Requêtes à l’API<a class="headerlink" href="#requetes-a-l-api" title="Permalink to this heading"></a></h4>
<a class="reference internal image-reference" href="_images/8_FME_requête_api_com.png"><img alt="_images/8_FME_requ%C3%AAte_api_com.png" src="_images/8_FME_requ%C3%AAte_api_com.png" style="width: 880px;" /></a>
<p>Le traitement pour dépot des BAL à l’API se déroule comme suit :</p>
<ul class="simple">
<li><p>Mise à jour des adresses d’une Commune par dépot d’une nouvelle BAL qui écrase l’ancienne :  <strong>REVISION</strong></p></li>
<li><p>Téléversement du fichier au format BAL : <strong>TELEVERSEMENT</strong></p></li>
<li><p>Validation des données transmises :  <strong>VALIDATION</strong></p></li>
<li><p>Publication de la nouvelle BAL :  <strong>PUBLICATION</strong></p></li>
<li><p>Récupération de la Réponse de l’API : <strong>REPONSE</strong></p></li>
</ul>
<p><strong>REVISION</strong></p>
<blockquote>
<div><p><strong>1-</strong> Utliser le Transformer <strong>HTTPCaller</strong> comme suit</p>
</div></blockquote>
<a class="reference internal image-reference" href="_images/10_caller_revision.png"><img alt="_images/10_caller_revision.png" src="_images/10_caller_revision.png" style="width: 480px;" /></a>
<p><em>Paramètres :</em></p>
<p>1 <em>URL :</em> <a class="reference external" href="https://plateforme.adresse.data.gouv.fr/api-depot/communes/&#64;Value(insee)/revisions">https://plateforme.adresse.data.gouv.fr/api-depot/communes/&#64;Value(insee)/revisions</a></p>
<p>2 <em>Méthode HTTP</em> : POST</p>
<dl>
<dt>3 <em>En-têtes :</em></dt><dd><p><em>Nom =</em> Authorization
<em>Valeur =</em> Token &#64;Value(jeton)</p>
</dd>
<dt>4 <em>Corps</em> :</dt><dd><p><em>Type de données à charger =</em> Specify Upload Body
<em>Corps de la requête =</em> { “context”: { “nomComplet”: “A remplacer”, “organisation”: “A remplacer” } }
<em>Type de contenu =</em> json</p>
</dd>
<dt>5 <em>Réponse</em> :</dt><dd><blockquote>
<div><p><em>Enregistrer le corps de la réponse dans =</em> Attribut
<em>Attribut de réponse =</em> _response_body</p>
</div></blockquote>
<p><strong>2-</strong> Récupérer l’ID dans la réponse avec les transformer <em>JSONFragmenter</em> et <em>Tester</em> comme suit :</p>
</dd>
</dl>
<a class="reference internal image-reference" href="_images/11_recup_id_revision.png"><img alt="_images/11_recup_id_revision.png" src="_images/11_recup_id_revision.png" style="width: 880px;" /></a>
<p><strong>TELEVERSEMENT</strong></p>
<blockquote>
<div><p><strong>1-</strong> Utliser le Transformer <strong>HTTPCaller</strong> comme suit</p>
</div></blockquote>
<a class="reference internal image-reference" href="_images/12_FME_caller_televersement.png"><img alt="_images/12_FME_caller_televersement.png" class="align-center" src="_images/12_FME_caller_televersement.png" style="width: 480px;" /></a>
<p><em>Paramètres :</em></p>
<p>1 <em>URL :</em> <a class="reference external" href="https://plateforme.adresse.data.gouv.fr/api-depot/revisions/&#64;Value(_response_body)/files/bal">https://plateforme.adresse.data.gouv.fr/api-depot/revisions/&#64;Value(_response_body)/files/bal</a></p>
<p>2 <em>Méthode HTTP</em> : PUT</p>
<dl>
<dt>4 <em>Paramètres complémentaires de la requête :</em></dt><dd><p><em>Nom =</em> Content-MD5
<em>Valeur =</em> 1234567890abcdedf1234567890abcdedf</p>
</dd>
<dt>4 <em>En-têtes :</em></dt><dd><p><em>Nom =</em> Authorization
<em>Valeur =</em> Token &#64;Value(jeton)</p>
</dd>
<dt>5 <em>Corps</em> :</dt><dd><p><em>Type de données à charger =</em> Envoyer à partir d’un fichier
<em>Chemin du fichier à charger = * Le chemin vers les fichiers CSV adresse par commune créés en partie I
*Type de contenu =</em> text/csv</p>
</dd>
<dt>6 <em>Réponse</em> :</dt><dd><blockquote>
<div><p><em>Enregistrer le corps de la réponse dans =</em> Attribut
<em>Attribut de réponse =</em> _response_body</p>
</div></blockquote>
<p><strong>2-</strong> Récupérer l’ID dans la réponse avec les transformer <strong>JSONFragmenter</strong> et <strong>Tester</strong> comme précédemment pour la révision</p>
</dd>
</dl>
<p><strong>VALIDATION</strong></p>
<blockquote>
<div><p><strong>1-</strong> Utliser le Transformer <strong>HTTPCaller</strong> comme suit</p>
</div></blockquote>
<a class="reference internal image-reference" href="_images/13_FME_caller_validation.png"><img alt="_images/13_FME_caller_validation.png" class="align-center" src="_images/13_FME_caller_validation.png" style="width: 480px;" /></a>
<p><em>Paramètres :</em></p>
<p>1 <em>URL :</em> <a class="reference external" href="https://plateforme.adresse.data.gouv.fr/api-depot/revisions/&#64;Value(_response_body)/compute">https://plateforme.adresse.data.gouv.fr/api-depot/revisions/&#64;Value(_response_body)/compute</a></p>
<p>2 <em>Méthode HTTP</em> : POST</p>
<blockquote>
<div><p><strong>2-</strong> Récupérer l’ID dans la réponse avec les transformer <strong>JSONFragmenter</strong> et <strong>Tester</strong> comme précédemment pour la validation</p>
</div></blockquote>
<p><strong>PUBLICATION</strong></p>
<blockquote>
<div><p><strong>1-</strong> Utliser le Transformer <strong>HTTPCaller</strong> comme suit</p>
</div></blockquote>
<a class="reference internal image-reference" href="_images/14_FME_caller_publication.png"><img alt="_images/14_FME_caller_publication.png" class="align-center" src="_images/14_FME_caller_publication.png" style="width: 480px;" /></a>
<p><em>Paramètres :</em></p>
<p>1 <em>URL :</em> <a class="reference external" href="https://plateforme.adresse.data.gouv.fr/api-depot/revisions/&#64;Value(_response_body)/publish">https://plateforme.adresse.data.gouv.fr/api-depot/revisions/&#64;Value(_response_body)/publish</a></p>
<blockquote>
<div><p><strong>2-</strong> Récupérer l’ID dans la réponse avec les transformer <em>JSONFragmenter</em> et <em>Tester</em> comme précédemment pour la validation</p>
</div></blockquote>
<p>A la fin de cette étape, vos adresses sont publiées sur la BAN.</p>
<p><strong>REPONSE</strong></p>
<blockquote>
<div><p><strong>1-</strong> Utliser le Transformer <strong>HTTPCaller</strong> comme suit</p>
</div></blockquote>
<a class="reference internal image-reference" href="_images/15_FME_caller_reponse.png"><img alt="_images/15_FME_caller_reponse.png" class="align-center" src="_images/15_FME_caller_reponse.png" style="width: 480px;" /></a>
<p><em>Paramètres :</em></p>
<p>1 <em>URL :</em> <a class="reference external" href="https://plateforme.adresse.data.gouv.fr/api-depot/communes/&#64;Value(insee)/current-revision">https://plateforme.adresse.data.gouv.fr/api-depot/communes/&#64;Value(insee)/current-revision</a></p>
<p>2 <em>Méthode HTTP</em> : GET</p>
<blockquote>
<div><p><strong>2-</strong> Récupérer l’ID dans la réponse avec les transformer <strong>JSONFragmenter</strong> et <strong>Tester</strong> comme précédemment pour la validation</p>
</div></blockquote>
</div>
<div class="section" id="mail-recapitulatif">
<h4>2.6 - Mail récapitulatif<a class="headerlink" href="#mail-recapitulatif" title="Permalink to this heading"></a></h4>
<a class="reference internal image-reference" href="_images/16_FME_mail.png"><img alt="_images/16_FME_mail.png" src="_images/16_FME_mail.png" style="width: 880px;" /></a>
<p>Suite à la réponse de l’API, on supprime les champs inutiles pour ne conserver que  :</p>
<ul class="simple">
<li><p>Commune</p></li>
<li><p>Insee</p></li>
<li><p>response_body</p></li>
</ul>
<p>Avec le Transformer <strong>StringSearcher</strong>, on extrait par expression régulière les valeurs de chiffres après rowsCounts. L’idée est ici d’extraire le nombre d’adresses publiées de la réponse API.</p>
<blockquote>
<div><p><strong>(?&lt;=rowsCount”:)[w+.-]+</strong></p>
</div></blockquote>
<p>On créé ensuite un nouvel attribut comprenant le nombre de points extraits de la réponse suivi du texte que l’on souhaite ajouter.</p>
<a class="reference internal image-reference" href="_images/17_FME_mail_attrribute_create.png"><img alt="_images/17_FME_mail_attrribute_create.png" src="_images/17_FME_mail_attrribute_create.png" style="width: 480px;" /></a>
<p>Puis, on met en place une liste sur le champ précédemment créé et on va concatener la liste au niveau des sauts de lignes. Ceci pour n’obtenir qu’une seule entité à intégrer dans le mail.</p>
<a class="reference internal image-reference" href="_images/18_FME_mail_list_concat.png"><img alt="_images/18_FME_mail_list_concat.png" src="_images/18_FME_mail_list_concat.png" style="width: 199.0px; height: 113.5px;" /></a>
<p>Enfin, avec le transformer <strong>Emailer</strong>, on envoie dans le corps du mail la valeur de concatenation de liste.</p>
<a class="reference internal image-reference" href="_images/19_FME_mail_Emailer.png"><img alt="_images/19_FME_mail_Emailer.png" src="_images/19_FME_mail_Emailer.png" style="width: 594.5px; height: 371.5px;" /></a>
</div>
<div class="section" id="integration-du-compte-de-points-publies-dans-la-base-de-donnees">
<h4>2.7 - Intégration du compte de points publiés dans la base de données<a class="headerlink" href="#integration-du-compte-de-points-publies-dans-la-base-de-donnees" title="Permalink to this heading"></a></h4>
<a class="reference internal image-reference" href="_images/20_Intégration_bd.png"><img alt="_images/20_Int%C3%A9gration_bd.png" src="_images/20_Int%C3%A9gration_bd.png" style="width: 680px;" /></a>
<p>Après identification du compte de points publiés, on supprime les champs inutiles pour ne garder que :</p>
<ul class="simple">
<li><p>Le nombre de points publiés extrait par <strong>StringSearcher</strong>  (<em>_rows</em>)</p></li>
<li><p>Le code INSEE de la commune</p></li>
</ul>
<p>On crée ensuite un champs <em>date_depot_api</em> avec la date du jour (<strong>AttributeCreator</strong> : &#64;DateTimeFormat(&#64;DateTimeNow(local), %Y%m%d)).</p>
<p>On insère finalement les données dans la table <em>commune</em> citée en partie I au niveau de la correspondance insee (<strong>DatabaseUpdater</strong>).</p>
<a class="reference internal image-reference" href="_images/21_FME_Databaseupdater.png"><img alt="_images/21_FME_Databaseupdater.png" src="_images/21_FME_Databaseupdater.png" style="width: 276.0px; height: 338.5px;" /></a>
</div>
</div>
<div class="section" id="e-etape-mailing-automatique">
<h3>3e Etape :  Mailing automatique<a class="headerlink" href="#e-etape-mailing-automatique" title="Permalink to this heading"></a></h3>
<p>En complément de la chaine de traitement détaillée précédemment, un bilan hebdomadaire est réalisé sur la base de données adresse du Département.</p>
<p>Ce bilan vise à recenser le détail des points adresses modifiés, supprimés et ajoutés sur les communes ayant publié leur BAN durant les 7 derniers jours.</p>
<p>Il est transmis chaque début de semaine au chef de projet adresse du Département et aux partennaires du projet (La poste, DGFIP, …).</p>
<div class="section" id="enregistrement-des-donnees-adresses">
<h4>3.1 - Enregistrement des données adresses<a class="headerlink" href="#enregistrement-des-donnees-adresses" title="Permalink to this heading"></a></h4>
<p><strong>Chaque lundi à 4h (n7) et à 5h du matin (n0)</strong> :</p>
<p>Enregistrement au format CSV d’une table de données des adresses sur les communes publiées. Elle contient les champs suivants :</p>
<ul>
<li><p>L’identifiant du point</p></li>
<li><p>Le nom de la commune et son code INSEE</p></li>
<li><p>L’adresse complète du point</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">copy</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id_point</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">commune_nom</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">insee_code</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">adresse_complete</span>
<span class="k">from</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">v_point_adresse</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">v_communes_publiees</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">where</span><span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">insee_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">insee_code</span><span class="w"> </span><span class="p">)</span>
<span class="k">TO</span><span class="w"> </span><span class="s1">&#39;D:\BD_adresse\bakup_adresses\v_point_adresse_dimanche.csv&#39;</span><span class="w"> </span><span class="k">DELIMITER</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="w"> </span><span class="n">CSV</span><span class="w"> </span><span class="n">HEADER</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s1">&#39;NULL&#39;</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<p>Enregistrement au format CSV d’une table de données des adresses modifiées durant les 7 derniers jours sur les communes publiées. Elle contient les champs suivants :</p>
<ul>
<li><p>L’identifiant du point</p></li>
<li><p>Le nom de la commune et son code INSEE</p></li>
<li><p>L’adresse complète du point</p></li>
<li><p>La date de modification du point</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">copy</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id_point</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">date_modif</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">commune_nom</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">insee_code</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">adresse_complete</span>
<span class="k">from</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">v_point_adresse</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">v_communes_publiees</span><span class="w"> </span><span class="n">b</span>
<span class="k">where</span><span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">insee_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">insee_code</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">date_modif</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">current_date</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="s1">&#39;7&#39;</span><span class="p">))</span>
<span class="k">TO</span><span class="w"> </span><span class="s1">&#39;D:\BD_adresse\bakup_adresses\v_point_adresse_dimanche_modif.csv&#39;</span><span class="w"> </span><span class="k">DELIMITER</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="w"> </span><span class="n">CSV</span><span class="w"> </span><span class="n">HEADER</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s1">&#39;NULL&#39;</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<p>Enregistrement au format CSV d’une table de données des adresses créées durant les 7 derniers jours sur les communes publiées. Elle contient les champs suivants :</p>
<ul>
<li><p>L’identifiant du point</p></li>
<li><p>Le nom de la commune et son code INSEE</p></li>
<li><p>L’adresse complète du point</p></li>
<li><p>La date de création du point</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">copy</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id_point</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">date_creation</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">commune_nom</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">insee_code</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">adresse_complete</span>
<span class="k">from</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">v_point_adresse</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">v_communes_publiees</span><span class="w"> </span><span class="n">b</span>
<span class="k">where</span><span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">insee_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">insee_code</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">date_creation</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">current_date</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="s1">&#39;7&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="k">TO</span><span class="w"> </span><span class="s1">&#39;D:\BD_adresse\bakup_adresses\v_point_adresse_dimanche_creation.csv&#39;</span><span class="w"> </span><span class="k">DELIMITER</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="w"> </span><span class="n">CSV</span><span class="w"> </span><span class="n">HEADER</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s1">&#39;NULL&#39;</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="traitement-fme">
<h4>3.2 - Traitement FME<a class="headerlink" href="#traitement-fme" title="Permalink to this heading"></a></h4>
<p><strong>Chaque lundi à 4h30 du matin</strong> :</p>
<p><em>Vous pouvez télécharger la dernière version du projet FME en cliquant sur le lien ci dessous :</em></p>
<p><a class="reference external" href="https://github.com/sig14/sig14.github.io/releases/tag/FME_mail">Téléchargement du FME</a></p>
<p>Le traitement se déroule comme suit :</p>
<ul class="simple">
<li><p>Jointures des points adresse n0 - n7 , ne garder que les n0 non joints</p></li>
</ul>
<a class="reference internal image-reference" href="_images/22_mailing_comptage_n0_n7.png"><img alt="_images/22_mailing_comptage_n0_n7.png" src="_images/22_mailing_comptage_n0_n7.png" style="width: 680px;" /></a>
<ul class="simple">
<li><p>comparaisons des points adresses modifiés n7 avec les adresses n0. Ajout champ modif_geom et modif_semantique pour connaitre la modif.</p></li>
</ul>
<a class="reference internal image-reference" href="_images/22_mailing_comparaison_n0__modifn7.png"><img alt="_images/22_mailing_comparaison_n0__modifn7.png" src="_images/22_mailing_comparaison_n0__modifn7.png" style="width: 680px;" /></a>
<ul class="simple">
<li><p>export csv pour pièce jointe des adresses suprimées et modifiées</p></li>
<li><p>Comptage des points adresse modifiés durant les 7 derniers jours et non créés durant les 7 derniers jours</p></li>
</ul>
<a class="reference internal image-reference" href="_images/23_mailing_comparaison_n0_n7.png"><img alt="_images/23_mailing_comparaison_n0_n7.png" src="_images/23_mailing_comparaison_n0_n7.png" style="width: 680px;" /></a>
<ul class="simple">
<li><p>Points adresses créés durant les 7 derniers jours</p></li>
</ul>
<a class="reference internal image-reference" href="_images/24_mailing_comptage_pts__modif_n7.png"><img alt="_images/24_mailing_comptage_pts__modif_n7.png" src="_images/24_mailing_comptage_pts__modif_n7.png" style="width: 1000px;" /></a>
<ul class="simple">
<li><p>Jointure des comptages et envoi du mail</p></li>
</ul>
<a class="reference internal image-reference" href="_images/25_mailing_comptage_pts__crees_n7.png"><img alt="_images/25_mailing_comptage_pts__crees_n7.png" src="_images/25_mailing_comptage_pts__crees_n7.png" style="width: 1000px;" /></a>
</div>
</div>
</div>
</div>
<div class="toctree-wrapper compound">
<span id="document-cadastre/I_maj_annuelle"></span><div class="section" id="i-mettre-a-jour-les-donnees-edigeo-majic-iii-maj-annuelle">
<h2>I- Mettre à jour les données EDIGEO / Majic III (maj annuelle)<a class="headerlink" href="#i-mettre-a-jour-les-donnees-edigeo-majic-iii-maj-annuelle" title="Permalink to this heading"></a></h2>
<a class="reference internal image-reference" href="_images/schema_intro_maj_anuelle.png"><img alt="_images/schema_intro_maj_anuelle.png" src="_images/schema_intro_maj_anuelle.png" style="width: 880px;" /></a>
<div class="section" id="installation-du-plugin-cadastre">
<h3>1- Installation du plugin cadastre<a class="headerlink" href="#installation-du-plugin-cadastre" title="Permalink to this heading"></a></h3>
<p>Télécharger la dernière version stable du plugin cadastre Qgis <a class="reference external" href="https://github.com/3liz/QgisCadastrePlugin/releases">ICI</a></p>
<p>Déziper-le et installer-le depuis le menu <strong>extension</strong> de QGIS.</p>
<a class="reference internal image-reference" href="_images/1_plugin_cadaster.png"><img alt="_images/1_plugin_cadaster.png" src="_images/1_plugin_cadaster.png" style="width: 648.5px; height: 378.0px;" /></a>
<p>Une fois le plugin installé, un nouveau menu Cadastre apparaît dans le menu Extensions de QGIS. Il comporte les sous-menus suivants :</p>
<blockquote>
<div><ul class="simple">
<li><p>Importer des données</p></li>
<li><p>Charger des données</p></li>
<li><p>Outils de recherche</p></li>
<li><p>Exporter la vue</p></li>
<li><p>Configurer le plugin</p></li>
<li><p>À propos</p></li>
<li><p>Notes de version</p></li>
<li><p>Aide</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="recuperation-des-donnees-cadastre">
<h3>2- Récupération des données cadastre<a class="headerlink" href="#recuperation-des-donnees-cadastre" title="Permalink to this heading"></a></h3>
<p><strong>Plan Cadastral Informatisé (PCI)</strong></p>
<ul class="simple">
<li><p>Télécharger les données Millésime 1er au 1er janvier du PCI Vecteur au format EDIGEO :  <a class="reference external" href="https://cadastre.data.gouv.fr/datasets/plan-cadastral-informatise">Site cadastre EDIGEO</a></p></li>
</ul>
<p><strong>Mise A Jour des Informations Cadastrales (MAJIC)</strong></p>
<ul class="simple">
<li><p>Transmission chaque année au CD14 (juillet/aout) des données MAJIC par la DDFIP.</p></li>
<li><p>Les données MAJIC transmises correspondent à un état des lieux à janvier de l’année courante.</p></li>
</ul>
<p><strong>Fichier ANnuaire TOpographique Initialisé Réduit (FANTOIR)</strong>
* Télécharger des données à l’échelle de la région Normandie :  <a class="reference external" href="https://www.collectivites-locales.gouv.fr/competences/la-mise-disposition-gratuite-du-fichier-des-voies-et-des-lieux-dits-fantoir">Site fantoir collectivites-locales.gouv.fr</a></p>
</div>
<div class="section" id="recenser-les-dependances-au-schema-cadastre">
<h3>3- Recenser les dépendances au schéma cadastre<a class="headerlink" href="#recenser-les-dependances-au-schema-cadastre" title="Permalink to this heading"></a></h3>
<p>La mise à jour des données cadastre dans la base de données postgresql nécessite de remplacer l’intégralité des tables de données, des vues et vues matérialisées qui en dépendent.</p>
<p>Il est donc nécéssaire de garder en mémoire les vues et vues matérialisées dépendantes du schéma afin de pouvoir les relancer après intégration des données cadastre.</p>
<p>Nous allons ainsi créer une table listant les vues et vm dépendantes du schéma cadastre et le code sql qui leur est associé.</p>
<p>Pour cela nous lançons la requête suivante :</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">drop</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">dependances_v_vm_cadastre</span><span class="p">;</span>
<span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w">  </span><span class="k">public</span><span class="p">.</span><span class="n">dependances_v_vm_cadastre</span><span class="w"> </span><span class="k">as</span>
<span class="k">with</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">as</span>

<span class="p">(</span><span class="k">WITH</span><span class="w"> </span><span class="k">RECURSIVE</span><span class="w"> </span><span class="n">s</span><span class="p">(</span><span class="n">start_schemaname</span><span class="p">,</span><span class="w"> </span><span class="n">start_relname</span><span class="p">,</span><span class="w"> </span><span class="n">start_relkind</span><span class="p">,</span><span class="w"> </span><span class="n">relhasindex</span><span class="p">,</span><span class="w"> </span><span class="n">schemaname</span><span class="p">,</span><span class="w"> </span><span class="n">relname</span><span class="p">,</span><span class="w"> </span><span class="n">relkind</span><span class="p">,</span><span class="w"> </span><span class="n">reloid</span><span class="p">,</span><span class="w"> </span><span class="n">owneroid</span><span class="p">,</span><span class="w"> </span><span class="n">ownername</span><span class="p">,</span><span class="w"> </span><span class="n">depth</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="c1">--recursive sur l&#39;ensemble des données du schema cadastre</span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="n">nspname</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">start_schemaname</span><span class="p">,</span><span class="w"> </span><span class="c1">-- nom du schema</span>
<span class="w">            </span><span class="k">c</span><span class="p">.</span><span class="n">relname</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">start_relname</span><span class="p">,</span><span class="w"> </span><span class="c1">-- nom de la table</span>
<span class="w">            </span><span class="k">c</span><span class="p">.</span><span class="n">relkind</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">start_relkind</span><span class="p">,</span>
<span class="w">            </span><span class="k">c</span><span class="p">.</span><span class="n">relhasindex</span><span class="p">,</span>
<span class="w">            </span><span class="n">n2</span><span class="p">.</span><span class="n">nspname</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">schemaname</span><span class="p">,</span><span class="w"> </span><span class="c1">-- nom du schema de la table dépendante</span>
<span class="w">            </span><span class="n">c2</span><span class="p">.</span><span class="n">relname</span><span class="p">,</span><span class="w"> </span><span class="c1">-- nom de la table dépendante</span>
<span class="w">            </span><span class="n">c2</span><span class="p">.</span><span class="n">relkind</span><span class="p">,</span>
<span class="w">            </span><span class="n">c2</span><span class="p">.</span><span class="n">oid</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">reloid</span><span class="p">,</span>
<span class="w">            </span><span class="n">au</span><span class="p">.</span><span class="n">oid</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">owneroid</span><span class="p">,</span>
<span class="w">            </span><span class="n">au</span><span class="p">.</span><span class="n">rolname</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ownername</span><span class="p">,</span>
<span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="c1">-- Commencer la dépendance à 0</span>
<span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_class</span><span class="w"> </span><span class="k">c</span>
<span class="w">            </span><span class="k">JOIN</span><span class="w"> </span><span class="n">pg_namespace</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">relnamespace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="n">oid</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">relkind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">ANY</span><span class="w"> </span><span class="p">(</span><span class="nb">ARRAY</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;v&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="s1">&#39;t&#39;</span><span class="p">,</span><span class="s1">&#39;f&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;p&#39;</span><span class="p">]))</span><span class="w"> </span><span class="c1">-- on commence par lister les tables, vues, vm dus chema cadastre</span>
<span class="w">            </span><span class="k">JOIN</span><span class="w"> </span><span class="n">pg_depend</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">oid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">refobjid</span>
<span class="w">            </span><span class="k">JOIN</span><span class="w"> </span><span class="n">pg_rewrite</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">objid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">oid</span>
<span class="w">            </span><span class="k">JOIN</span><span class="w"> </span><span class="n">pg_class</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">ev_class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c2</span><span class="p">.</span><span class="n">oid</span>
<span class="w">            </span><span class="k">JOIN</span><span class="w"> </span><span class="n">pg_namespace</span><span class="w"> </span><span class="n">n2</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">n2</span><span class="p">.</span><span class="n">oid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c2</span><span class="p">.</span><span class="n">relnamespace</span>
<span class="w">            </span><span class="k">JOIN</span><span class="w"> </span><span class="n">pg_authid</span><span class="w"> </span><span class="n">au</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">au</span><span class="p">.</span><span class="n">oid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c2</span><span class="p">.</span><span class="n">relowner</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="n">nspname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;cadastre&#39;</span><span class="w"> </span><span class="c1">-- on limite le schema d&#39;origine au cadastre</span>
<span class="w">        </span><span class="k">UNION</span><span class="w"> </span><span class="c1">-- union pour la récursivité</span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="n">s_1</span><span class="p">.</span><span class="n">start_schemaname</span><span class="p">,</span>
<span class="w">            </span><span class="n">s_1</span><span class="p">.</span><span class="n">start_relname</span><span class="p">,</span>
<span class="w">            </span><span class="n">s_1</span><span class="p">.</span><span class="n">start_relkind</span><span class="p">,</span>
<span class="w">            </span><span class="n">s_1</span><span class="p">.</span><span class="n">relhasindex</span><span class="p">,</span>
<span class="w">            </span><span class="n">n</span><span class="p">.</span><span class="n">nspname</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">schemaname</span><span class="p">,</span>
<span class="w">            </span><span class="n">c2</span><span class="p">.</span><span class="n">relname</span><span class="p">,</span>
<span class="w">            </span><span class="n">c2</span><span class="p">.</span><span class="n">relkind</span><span class="p">,</span>
<span class="w">            </span><span class="n">c2</span><span class="p">.</span><span class="n">oid</span><span class="p">,</span>
<span class="w">            </span><span class="n">au</span><span class="p">.</span><span class="n">oid</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">owneroid</span><span class="p">,</span>
<span class="w">            </span><span class="n">au</span><span class="p">.</span><span class="n">rolname</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ownername</span><span class="p">,</span>
<span class="w">            </span><span class="n">s_1</span><span class="p">.</span><span class="n">depth</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="c1">-- on ajoute 1 pour chaque dépendance trouvée</span>
<span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="n">s_1</span>
<span class="w">            </span><span class="k">JOIN</span><span class="w"> </span><span class="n">pg_depend</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">s_1</span><span class="p">.</span><span class="n">reloid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">refobjid</span>
<span class="w">            </span><span class="k">JOIN</span><span class="w"> </span><span class="n">pg_rewrite</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">objid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">oid</span>
<span class="w">            </span><span class="k">JOIN</span><span class="w"> </span><span class="n">pg_class</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">ev_class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c2</span><span class="p">.</span><span class="n">oid</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="p">(</span><span class="n">c2</span><span class="p">.</span><span class="n">relkind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">ANY</span><span class="w"> </span><span class="p">(</span><span class="nb">ARRAY</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">::</span><span class="ss">&quot;char&quot;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;v&#39;</span><span class="p">::</span><span class="ss">&quot;char&quot;</span><span class="p">]))</span><span class="w"> </span><span class="c1">--- on limite les dependances aux vues et vues materialisées</span>
<span class="w">            </span><span class="k">JOIN</span><span class="w"> </span><span class="n">pg_namespace</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="n">oid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c2</span><span class="p">.</span><span class="n">relnamespace</span>
<span class="w">            </span><span class="k">JOIN</span><span class="w"> </span><span class="n">pg_authid</span><span class="w"> </span><span class="n">au</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">au</span><span class="p">.</span><span class="n">oid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c2</span><span class="p">.</span><span class="n">relowner</span>
<span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">s_1</span><span class="p">.</span><span class="n">reloid</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">c2</span><span class="p">.</span><span class="n">oid</span><span class="w"> </span><span class="c1">--- on joint les dépendance au niveau de l&#39;oid</span>
<span class="w">        </span><span class="p">)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="c1">-- lancement de la recursive</span>
<span class="w">    </span><span class="n">s</span><span class="p">.</span><span class="n">schemaname</span><span class="p">::</span><span class="nb">varchar</span><span class="p">,</span>
<span class="w">    </span><span class="n">s</span><span class="p">.</span><span class="n">relname</span><span class="p">::</span><span class="nb">varchar</span><span class="p">,</span>
<span class="w">    </span><span class="n">s</span><span class="p">.</span><span class="n">relkind</span><span class="p">,</span>
<span class="w">    </span><span class="k">sum</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">depth</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">depth</span><span class="p">,</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">relkind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;v&#39;</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;VIEW&#39;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;MATERIALIZED VIEW&#39;</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">kind</span><span class="w"> </span><span class="c1">-- on précise les acronymes view et matview</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">s</span>
<span class="w">        </span><span class="k">group</span><span class="w"> </span><span class="k">by</span>
<span class="w">    </span><span class="n">s</span><span class="p">.</span><span class="n">schemaname</span><span class="p">,</span>
<span class="w">    </span><span class="n">s</span><span class="p">.</span><span class="n">relname</span><span class="p">,</span>
<span class="w">    </span><span class="n">s</span><span class="p">.</span><span class="n">relkind</span><span class="p">,</span>
<span class="w">    </span><span class="n">s</span><span class="p">.</span><span class="n">depth</span>
<span class="w">    </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">depth</span><span class="p">),</span>

<span class="n">z</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="o">*</span><span class="p">,</span>
<span class="k">case</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">relkind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;m&#39;</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">definition</span><span class="w"> </span><span class="c1">-- on ajoute les requêtes sql dans un champs</span>
<span class="k">ELSE</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">view_definition</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">query</span><span class="p">,</span>
<span class="n">i</span><span class="p">.</span><span class="n">indexdef</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">queryndex</span><span class="w"> </span><span class="c1">-- on ajoute les requêtes d&#39;indexe dans un champs</span>
<span class="k">from</span><span class="w"> </span><span class="n">a</span>
<span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w">  </span><span class="n">pg_matviews</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">schemaname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">schemaname</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">matviewname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">relname</span>
<span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w">  </span><span class="n">information_schema</span><span class="p">.</span><span class="n">views</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">table_schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">schemaname</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="k">table_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">relname</span>
<span class="k">left</span><span class="w"> </span><span class="k">join</span>
<span class="w">    </span><span class="n">pg_indexes</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">schemaname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">schemaname</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">tablename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">relname</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">depth</span><span class="p">)</span>


<span class="k">select</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">schemaname</span><span class="p">::</span><span class="nb">varchar</span><span class="p">,</span>
<span class="w">    </span><span class="n">z</span><span class="p">.</span><span class="n">relname</span><span class="p">::</span><span class="nb">varchar</span><span class="p">,</span>
<span class="w">    </span><span class="n">z</span><span class="p">.</span><span class="n">relkind</span><span class="p">,</span>
<span class="w">    </span><span class="n">z</span><span class="p">.</span><span class="n">kind</span><span class="p">,</span>
<span class="w">    </span><span class="k">sum</span><span class="p">(</span><span class="n">z</span><span class="p">.</span><span class="n">depth</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">depth</span><span class="p">,</span><span class="w"> </span><span class="c1">--on somme les dépendances pour ordoner le futur rafraichissemnt en focntion du nume de dépendance</span>
<span class="w">    </span><span class="n">z</span><span class="p">.</span><span class="n">query</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">queryndex</span>
<span class="k">from</span><span class="w"> </span><span class="n">z</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span>
<span class="w">    </span><span class="n">z</span><span class="p">.</span><span class="n">schemaname</span><span class="p">,</span>
<span class="w">    </span><span class="n">z</span><span class="p">.</span><span class="n">relname</span><span class="p">,</span>
<span class="w">    </span><span class="n">z</span><span class="p">.</span><span class="n">relkind</span><span class="p">,</span>
<span class="w">    </span><span class="n">z</span><span class="p">.</span><span class="n">kind</span><span class="p">,</span>
<span class="w">    </span><span class="n">z</span><span class="p">.</span><span class="n">query</span><span class="p">,</span>
<span class="n">z</span><span class="p">.</span><span class="n">queryndex</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">depth</span><span class="p">;</span>
<span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>Le code de la table se trouve <a class="reference external" href="https://github.com/sig14/sig14.github.io/blob/master/cadastre/sql/_maj_view_annuelle.sql">par ici</a></p>
<a class="reference internal image-reference" href="_images/2_table_dependances_cadastre.png"><img alt="_images/2_table_dependances_cadastre.png" src="_images/2_table_dependances_cadastre.png" style="width: 659.0px; height: 210.0px;" /></a>
</div>
<div class="section" id="import-des-donnees-cadastre">
<h3>4- Import des données cadastre<a class="headerlink" href="#import-des-donnees-cadastre" title="Permalink to this heading"></a></h3>
<ul class="simple">
<li><p>Modifier le nom du schema cadastre en schéma cadastre2 sur pgadmin, afin, par sécurité, de conserver la précédente version du schéma cadastre.</p></li>
<li><p>Paramètrer le plugin en sélectionnant <em>configuration</em>. Sélectionner les bons noms et types de fichiers.</p></li>
</ul>
<a class="reference internal image-reference" href="_images/3_conf_plugin.png"><img alt="_images/3_conf_plugin.png" src="_images/3_conf_plugin.png" style="width: 492.0px; height: 231.5px;" /></a>
<a class="reference internal image-reference" href="_images/4_conf_plugin_2.png"><img alt="_images/4_conf_plugin_2.png" src="_images/4_conf_plugin_2.png" style="width: 323.0px; height: 384.0px;" /></a>
<ul class="simple">
<li><p>Lancer l’import postgis avec les paramètres suivant :</p></li>
</ul>
<ul class="simple">
<li><p>Base de données : Postgis, lizmap</p></li>
<li><p>Schémas : taper cadastre et créer</p></li>
<li><p>Fichiers EDIGEO : charger le dossier déposé sur APW65</p></li>
<li><p>scr source : 2154</p></li>
<li><p>scr cible : 2154</p></li>
<li><p>Fichiers MAJIC: charger le dossier déposé sur APW65</p></li>
<li><p>Département  : 14</p></li>
<li><p>Lot : “donner un nom pour l’import”</p></li>
</ul>
<a class="reference internal image-reference" href="_images/5_import_plugin.png"><img alt="_images/5_import_plugin.png" src="_images/5_import_plugin.png" style="width: 478.0px; height: 268.5px;" /></a>
<a class="reference internal image-reference" href="_images/6_import_plugin_2.png"><img alt="_images/6_import_plugin_2.png" src="_images/6_import_plugin_2.png" style="width: 361.0px; height: 363.0px;" /></a>
</div>
<div class="section" id="relancer-les-vues-et-vm-dependantes-du-cadastre">
<h3>5- Relancer les vues et VM dépendantes du cadastre<a class="headerlink" href="#relancer-les-vues-et-vm-dependantes-du-cadastre" title="Permalink to this heading"></a></h3>
<p>Pour relancer les vues et vm dépendantes, lancer la requête suivante :</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">create_v_vm_cadastre</span><span class="p">()</span>
</pre></div>
</div>
</div></blockquote>
<p>Cette requête appelle la fonction dont le code se trouve <a class="reference external" href="https://github.com/sig14/sig14.github.io/blob/master/cadastre/sql/refresh_dependances_vues_vm_cadastre.sql">là</a></p>
</div>
<div class="section" id="actualiser-les-fiches-html-de-la-table-parcelle-info">
<h3>7- Actualiser les fiches HTML de la table parcelle_info<a class="headerlink" href="#actualiser-les-fiches-html-de-la-table-parcelle-info" title="Permalink to this heading"></a></h3>
<p>Des champs HTML ont été développés par l’équipe SIG du Département afin de renseigner des informations complémentaires à la parcelle : Règlementation GPU par parcelle, historique des filiations de parcelle, historique des mutations immobilières.</p>
<p>Le processus de construction des champs est décrit en partie II, III et IV.</p>
<p>A chaque réimport du cadastre il est nécessaire de recréer et mettre à jour ces champs.</p>
<div class="section" id="documents-d-urbanisme">
<h4>7.1 - Documents d’urbanisme<a class="headerlink" href="#documents-d-urbanisme" title="Permalink to this heading"></a></h4>
<ul>
<li><p>Créer le champ contenant l’html de la table contenant les informations GPU par parcelle</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">cadastre</span><span class="p">.</span><span class="n">parcelle_info</span>
<span class="k">ADD</span><span class="w"> </span><span class="n">tab_doc_urba</span><span class="w"> </span><span class="nb">varchar</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Créer les champs contenant l’html des déroulants détaillant les informations contenues dans le tableau</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">cadastre</span><span class="p">.</span><span class="n">parcelle_info</span>
<span class="k">ADD</span><span class="w"> </span><span class="n">deroulant_zonage</span><span class="w"> </span><span class="nb">varchar</span><span class="p">;</span>

<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">cadastre</span><span class="p">.</span><span class="n">parcelle_info</span>
<span class="k">ADD</span><span class="w"> </span><span class="n">deroulant_secteur</span><span class="w"> </span><span class="nb">varchar</span><span class="p">;</span>

<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">cadastre</span><span class="p">.</span><span class="n">parcelle_info</span>
<span class="k">ADD</span><span class="w"> </span><span class="n">deroulant_prescription</span><span class="w"> </span><span class="nb">varchar</span><span class="p">;</span>

<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">cadastre</span><span class="p">.</span><span class="n">parcelle_info</span>
<span class="k">ADD</span><span class="w"> </span><span class="n">deroulant_info</span><span class="w"> </span><span class="nb">varchar</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Lancer la fonction mettant à jour les champs (1 heure environ)</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">ref_urbanisme</span><span class="p">.</span><span class="n">fiches_parcelles_lizmap</span><span class="p">();</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="filiations-parcellaires">
<h4>7.2 - Filiations parcellaires<a class="headerlink" href="#filiations-parcellaires" title="Permalink to this heading"></a></h4>
<ul>
<li><p>Créer les champs contenant l’html des déroulants détaillant l’historique de filiation par parcelle</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">cadastre</span><span class="p">.</span><span class="n">parcelle_info</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">column</span><span class="w"> </span><span class="n">tab_filiation</span><span class="w"> </span><span class="nb">text</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Lancer la fonction mettant à jour les champs</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">ref_foncier</span><span class="p">.</span><span class="n">tab_filiation_lizmap</span><span class="p">()</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="mutations-immobilieres">
<h4>7.3 - Mutations immobilières<a class="headerlink" href="#mutations-immobilieres" title="Permalink to this heading"></a></h4>
<ul>
<li><p>Créer les champs contenant l’html des déroulants détaillant les mutations immobilières</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">cadastre</span><span class="p">.</span><span class="n">parcelle_info</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">column</span><span class="w"> </span><span class="n">deroulant_dvf</span><span class="w"> </span><span class="nb">varchar</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Lancer la fonction mettant à jour les champs</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">ref_foncier</span><span class="p">.</span><span class="n">parcelles_valeur_fonciere_lizmap</span><span class="p">()</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</div>
</div>
</div>
<span id="document-cadastre/II_gpu_docs_urba"></span><div class="section" id="ii-ajouter-un-onglet-documents-d-urbanisme-gpu-a-la-pop-up-cadastre-de-lizmap">
<h2>II- Ajouter un onglet “Documents d’urbanisme GPU” à la pop-up cadastre de Lizmap<a class="headerlink" href="#ii-ajouter-un-onglet-documents-d-urbanisme-gpu-a-la-pop-up-cadastre-de-lizmap" title="Permalink to this heading"></a></h2>
<p>Le service d’interrogation du GPU permet d’obtenir les différentes informations d’urbanisme intersectant une géométrie (ponctuelle ou surfacique). Ces informations sont disponibles en consultation et en téléchargement sur le <a class="reference external" href="https://www.geoportail-urbanisme.gouv.fr/">Géoportail de l’urbanisme</a></p>
<p>Le Département met à disposition des communes l’ensemble de ces informations, ainsi que celles du cadastre sur son portail cartographique.
Afin de faciliter la lecture des informations, l’ensemble des données du GPU sont collectées dans la base de données du Département à chaque mise à jour sur le GPU par les colectivités et agglomérées à l’echelle de la parcelle.</p>
<a class="reference internal image-reference" href="_images/7_schema_fiches_dosc_urba.png"><img alt="_images/7_schema_fiches_dosc_urba.png" src="_images/7_schema_fiches_dosc_urba.png" style="width: 1196.0px; height: 595.0px;" /></a>
<p>Cela permet aux partenaires du CD14 de pouvoir consulter rapidement les informations du GPU liées à chaque parcelle : impact des zonages sur la parcelle, documents pdf associés, etc.</p>
<a class="reference internal image-reference" href="_images/docs_urba.gif"><img alt="_images/docs_urba.gif" src="_images/docs_urba.gif" style="width: 802.0px; height: 499.0px;" /></a>
<div class="section" id="import-fme-des-donnees-gpu">
<h3>1- Import FME des données GPU<a class="headerlink" href="#import-fme-des-donnees-gpu" title="Permalink to this heading"></a></h3>
<p>L’import des données de l’API GPU se fait via le logiciel ETL FME.</p>
<p>Dans un premier temps les données GPU sont chargées dans la base de données du CD14 à l’échelle du Calvados.</p>
<p>Les données du GPU sont segmentées par collectivité via un code partition formé :</p>
<ul class="simple">
<li><p>du prefixe “DU _”</p></li>
<li><p>du code insee commune ou siren epci (en fonction du type de document : carte communale, PLU, PLUI)</p></li>
<li><p>D’un code optionnel de secteur pour les EPCI (A, B, C, D)</p></li>
</ul>
<p>Pour le Calvados, les codes insee des communes correspondent aux codes insee des communes historiques (avant loi NOTRE).</p>
<p>Pour finir, certaines communes sont soumises au RNU (Réglement National d’Urbanisme) et n’ont donc pas de documents d’urbanisme enregistrés sur le GPU.</p>
<div class="section" id="zonages-et-cartes-communales">
<h4>1.1 - Zonages et cartes communales<a class="headerlink" href="#zonages-et-cartes-communales" title="Permalink to this heading"></a></h4>
<p>Un premier projet FME récupère les données d’emprise de document ainsi que les zonages PLU et secteurs de cartes communales.</p>
<p>Le workbench FME chargeant les données depuis l’API, réalisant le traitement et l’intégration des données en base se trouve <a class="reference external" href="https://github.com/sig14/sig14.github.io/releases/tag/FME_api_zonage_gpu">par ici</a></p>
<ul class="simple">
<li><p>Récupération des codes siren EPCI et ajout des potentiels suffixes (code optionnel secteur)</p></li>
</ul>
<a class="reference internal image-reference" href="_images/9_siren_epci_dosc_urba.png"><img alt="_images/9_siren_epci_dosc_urba.png" src="_images/9_siren_epci_dosc_urba.png" style="width: 454.0px; height: 206.5px;" /></a>
<ul class="simple">
<li><p>Récupération des codes insee des communes historiques</p></li>
</ul>
<a class="reference internal image-reference" href="_images/10_insee_communes_doc_urba.png"><img alt="_images/10_insee_communes_doc_urba.png" src="_images/10_insee_communes_doc_urba.png" style="width: 161.0px; height: 117.0px;" /></a>
<ul class="simple">
<li><p>Interrogation de l’API pour connaître les communes au RNU ou non</p></li>
</ul>
<p>On interroge l’API avec les paramètres suivant :</p>
<p>URL : <a class="reference external" href="http://apicarto.ign.fr/api/gpu/municipality?insee=&#64;Value(insee">http://apicarto.ign.fr/api/gpu/municipality?insee=&#64;Value(insee</a>)</p>
<p>HTTP method : GET</p>
<p>response body : Attribute</p>
<a class="reference internal image-reference" href="_images/11_api_rnu_doc_urba.png"><img alt="_images/11_api_rnu_doc_urba.png" src="_images/11_api_rnu_doc_urba.png" style="width: 137.0px; height: 274.0px;" /></a>
<ul class="simple">
<li><p>Filtrer les communes qui ne sont pas au RNU et stocker les valeurs (rnu = true/flase) dans une table à part (pour information)</p></li>
</ul>
<a class="reference internal image-reference" href="_images/12_filtre_rnu_doc_urba.png"><img alt="_images/12_filtre_rnu_doc_urba.png" src="_images/12_filtre_rnu_doc_urba.png" style="width: 359.0px; height: 295.0px;" /></a>
<ul class="simple">
<li><p>Récupération des données depuis l’API avec les “DU _” précédemments créés : données emprise, zonage et secteur carte communale</p></li>
</ul>
<p>On interroge l’API avec les paramètres suivant :</p>
<p><strong>emprise</strong> :</p>
<p>URL : “<a class="reference external" href="https://apicarto.ign.fr/api/gpu/document?partition=DU_&#64;Value(siren">https://apicarto.ign.fr/api/gpu/document?partition=DU_&#64;Value(siren</a>)”</p>
<p>HTTP method : GET</p>
<p>response body : Attribute</p>
<p><strong>zonage</strong> :</p>
<p>Interrogation de l’API avec les DU_partition précédemment créés</p>
<p>URL : “<a class="reference external" href="https://apicarto.ign.fr/api/gpu/zone-urba?partition=DU_&#64;Value(siren">https://apicarto.ign.fr/api/gpu/zone-urba?partition=DU_&#64;Value(siren</a>)”</p>
<p>HTTP method : GET</p>
<p>response body : Attribute</p>
<p><strong>secteur carte communale</strong> :</p>
<p>URL : “<a class="reference external" href="https://apicarto.ign.fr/api/gpu/secteur-cc?partition=DU_&#64;Value(siren">https://apicarto.ign.fr/api/gpu/secteur-cc?partition=DU_&#64;Value(siren</a>)”</p>
<p>HTTP method : GET</p>
<p>response body : Attribute</p>
<a class="reference internal image-reference" href="_images/13_get_data_doc_urba.png"><img alt="_images/13_get_data_doc_urba.png" src="_images/13_get_data_doc_urba.png" style="width: 141.5px; height: 230.5px;" /></a>
<ul class="simple">
<li><p>Filtrer les données à partir de la réponse JSON : Expression régulière conservant le chiffre après ‘totalFeatures’ et conservation des lignes dont la valeur est différente de 0.</p></li>
</ul>
<a class="reference internal image-reference" href="_images/14_numb_feature_filter_doc_urba.png"><img alt="_images/14_numb_feature_filter_doc_urba.png" src="_images/14_numb_feature_filter_doc_urba.png" style="width: 221.0px; height: 127.5px;" /></a>
<ul class="simple">
<li><p>Extraction des données du JSON : exposer les attributs et la géométrie</p></li>
</ul>
<a class="reference internal image-reference" href="_images/15_expose_attributes_doc_urba.png"><img alt="_images/15_expose_attributes_doc_urba.png" src="_images/15_expose_attributes_doc_urba.png" style="width: 428.0px; height: 163.5px;" /></a>
<ul class="simple">
<li><p>Retraitement des données : supression des prefixes de champs et reprojection de la géométrie (de 4326 à 2154)</p></li>
</ul>
<a class="reference internal image-reference" href="_images/16_reprojection_doc_urba.png"><img alt="_images/16_reprojection_doc_urba.png" src="_images/16_reprojection_doc_urba.png" style="width: 250.0px; height: 95.0px;" /></a>
</div>
<div class="section" id="prescriptions">
<h4>1.2 - Prescriptions<a class="headerlink" href="#prescriptions" title="Permalink to this heading"></a></h4>
<p>Un second projet FME récupère les données de prescriptions linéaires, surfaciques et ponctuels sur le même modèle que précédemment :</p>
<p>Le workbench FME se trouve <a class="reference external" href="https://github.com/sig14/sig14.github.io/releases/tag/api_prescription_gpu">ICI</a></p>
<ul class="simple">
<li><p>Récupération des codes insee des communes historiques qui ne sont pas classées au rnu depuis la table créée dans la partie précédente</p></li>
</ul>
<a class="reference internal image-reference" href="_images/17_rnu_doc_urba.png"><img alt="_images/17_rnu_doc_urba.png" src="_images/17_rnu_doc_urba.png" style="width: 113.0px; height: 77.0px;" /></a>
<ul class="simple">
<li><p>Récupération des données depuis l’API avec les “DU _” précédemment créés : données linéaires, surfaces et ponctuels</p></li>
</ul>
<p>On interroge l’API avec les paramètres suivant :</p>
<p><strong>surface</strong> :</p>
<p>URL : “<a class="reference external" href="https://apicarto.ign.fr/api/gpu/info-surf?partition=DU_&#64;Value(siren">https://apicarto.ign.fr/api/gpu/info-surf?partition=DU_&#64;Value(siren</a>)”</p>
<p>HTPP method : GET</p>
<p>response body : Attribute</p>
<p><strong>linéaire</strong> :</p>
<p>URL : “<a class="reference external" href="https://apicarto.ign.fr/api/gpu/info-lin?partition=DU_&#64;Value(siren">https://apicarto.ign.fr/api/gpu/info-lin?partition=DU_&#64;Value(siren</a>)”</p>
<p>HTTP method : GET</p>
<p>response body : Attribute</p>
<p><strong>ponctuel</strong> :</p>
<p>URL : “<a class="reference external" href="https://apicarto.ign.fr/api/gpu/info-pct?partition=DU_&#64;Value(siren">https://apicarto.ign.fr/api/gpu/info-pct?partition=DU_&#64;Value(siren</a>)”</p>
<p>HTTP method : GET</p>
<p>response body : Attribute</p>
</div>
<div class="section" id="infos-prescriptions">
<h4>1.3- Infos prescriptions<a class="headerlink" href="#infos-prescriptions" title="Permalink to this heading"></a></h4>
<p>Un dernier projet FME récupère les données informations prescriptions linéaires, surfaciques et ponctuels sur le même modèle que précédemment.</p>
<p>Le workbench FME se trouve <a class="reference external" href="https://github.com/sig14/sig14.github.io/releases/tag/api_info_prescriptions_gpu">à cet endroit</a></p>
<ul class="simple">
<li><p>Récupération des données depuis l’API avec les “DU _” précédemments créés : données linéaires, surfaces et ponctuels</p></li>
</ul>
<p>On interroge l’API avec les paramètres suivant :</p>
<p><strong>surfaces</strong> :</p>
<p>URL : “<a class="reference external" href="https://apicarto.ign.fr/api/gpu/info-surf?partition=DU_&#64;Value(siren">https://apicarto.ign.fr/api/gpu/info-surf?partition=DU_&#64;Value(siren</a>)”</p>
<p>HTTP method : GET</p>
<p>response body : Attribute</p>
<p><strong>linéaires</strong> :</p>
<p>URL : “<a class="reference external" href="https://apicarto.ign.fr/api/gpu/info-lin?partition=DU_&#64;Value(siren">https://apicarto.ign.fr/api/gpu/info-lin?partition=DU_&#64;Value(siren</a>)”</p>
<p>HTTP method : GET</p>
<p>response body : Attribute</p>
<p><strong>ponctuels</strong> :</p>
<p>URL : “<a class="reference external" href="https://apicarto.ign.fr/api/gpu/info-pct?partition=DU_&#64;Value(siren">https://apicarto.ign.fr/api/gpu/info-pct?partition=DU_&#64;Value(siren</a>)”</p>
<p>HTTP method : GET</p>
<p>response body : Attribute</p>
</div>
</div>
<div class="section" id="champ-html-gpu-par-parcelle-du-cadastre">
<h3>2- Champ HTML GPU par parcelle du cadastre<a class="headerlink" href="#champ-html-gpu-par-parcelle-du-cadastre" title="Permalink to this heading"></a></h3>
<p>L’objectif est ici de pouvoir consulter les données du GPU à l’échelle de la parcelle.</p>
<p>L’utilisateur peut en cliquant sur une parcelle, consulter les données du GPU qui intersectent la parcelle, ouvrir les documents pdf associés sur le portail du GPU et connaître l’impact des réglements sur la parcelle.</p>
<p>Pour cela on utilise une fonction postgresql/gis pour alimenter la table parcelle_info du cadastre et une mise en forme du formulaire QGIS en HTML pour publication sur le portail cartographique Lizmap.</p>
<div class="section" id="fonction-postgresql-gis">
<h4>2.1 - Fonction postgresql/gis<a class="headerlink" href="#fonction-postgresql-gis" title="Permalink to this heading"></a></h4>
<ul>
<li><p>En premier lieu, on corrige les géométries invalides des données GPU intégrées à la base de données CD14</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">update</span><span class="w"> </span><span class="n">ref_urbanisme</span><span class="p">.</span><span class="n">gpu_api_zonages</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">geom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ST_MakeValid</span><span class="p">(</span><span class="n">geom</span><span class="p">);</span>

<span class="k">update</span><span class="w"> </span><span class="n">ref_urbanisme</span><span class="p">.</span><span class="n">gpu_api_secteur_cc</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">geom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ST_MakeValid</span><span class="p">(</span><span class="n">geom</span><span class="p">);</span>

<span class="k">update</span><span class="w"> </span><span class="n">ref_urbanisme</span><span class="p">.</span><span class="n">gpu_api_prescription_surf</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">geom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ST_MakeValid</span><span class="p">(</span><span class="n">geom</span><span class="p">);</span>

<span class="k">update</span><span class="w"> </span><span class="n">ref_urbanisme</span><span class="p">.</span><span class="n">gpu_api_prescription_lin</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">geom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ST_MakeValid</span><span class="p">(</span><span class="n">geom</span><span class="p">);</span>

<span class="k">update</span><span class="w"> </span><span class="n">ref_urbanisme</span><span class="p">.</span><span class="n">gpu_api_info_prescription_surf</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">geom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ST_MakeValid</span><span class="p">(</span><span class="n">geom</span><span class="p">);</span>

<span class="k">update</span><span class="w"> </span><span class="n">ref_urbanisme</span><span class="p">.</span><span class="n">gpu_api_info_prescription_lin</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">geom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ST_MakeValid</span><span class="p">(</span><span class="n">geom</span><span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>On crée le champ contenant l’html de table contenant les informations GPU par parcelle</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">cadastre</span><span class="p">.</span><span class="n">parcelle_info</span>
<span class="k">ADD</span><span class="w"> </span><span class="n">tab_doc_urba</span><span class="w"> </span><span class="nb">varchar</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>On crée ensuite les champs contenant l’html des déroulants détaillant les informations contenues dans le tableau</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">cadastre</span><span class="p">.</span><span class="n">parcelle_info</span>
<span class="k">ADD</span><span class="w"> </span><span class="n">deroulant_zonage</span><span class="w"> </span><span class="nb">varchar</span><span class="p">;</span>

<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">cadastre</span><span class="p">.</span><span class="n">parcelle_info</span>
<span class="k">ADD</span><span class="w"> </span><span class="n">deroulant_secteur</span><span class="w"> </span><span class="nb">varchar</span><span class="p">;</span>

<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">cadastre</span><span class="p">.</span><span class="n">parcelle_info</span>
<span class="k">ADD</span><span class="w"> </span><span class="n">deroulant_prescription</span><span class="w"> </span><span class="nb">varchar</span><span class="p">;</span>

<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">cadastre</span><span class="p">.</span><span class="n">parcelle_info</span>
<span class="k">ADD</span><span class="w"> </span><span class="n">deroulant_info</span><span class="w"> </span><span class="nb">varchar</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<p>On lance ensuite une fonction postgresql/gis dont le code SQL se trouve <a class="reference external" href="https://github.com/sig14/sig14.github.io/blob/master/cadastre/sql/fiche_parcelle_doc_urba.sql">ici</a></p>
<ul class="simple">
<li><p>Dans un premier temps, la fonction met en place des tables temporaires rapprochant les parcelles du cadastre avec les données du GPU. L’objectif est également de pouvoir indexer ces tables temporaires pour accélerer la suite des traitements.</p></li>
</ul>
<p><em>exemple de rapprochement des zonages PLU</em></p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="n">UNLOGGED</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">temp_parcelle_zonage_ref_urbanisme</span><span class="w"> </span><span class="k">as</span>
<span class="w">   </span><span class="k">select</span><span class="w">  </span><span class="n">p</span><span class="p">.</span><span class="n">geo_parcelle</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="o">*</span>
<span class="w">   </span><span class="k">FROM</span><span class="w"> </span><span class="n">cadastre</span><span class="p">.</span><span class="n">parcelle_info</span><span class="w"> </span><span class="n">p</span>
<span class="w">   </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">ref_urbanisme</span><span class="p">.</span><span class="n">gpu_api_zonages</span><span class="w"> </span><span class="n">z</span>
<span class="w">   </span><span class="k">on</span><span class="w">  </span><span class="n">st_intersects</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="o">&amp;&amp;</span><span class="n">z</span><span class="p">.</span><span class="n">geom</span><span class="p">;</span>

<span class="c1">-- Indexation de la table temporaire</span>
<span class="w">      </span><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">index_temp_parcelle_zonage_ref_urbanisme</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">temp_parcelle_zonage_ref_urbanisme</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="n">btree</span><span class="w"> </span><span class="p">(</span><span class="n">geo_parcelle</span><span class="p">);</span>
<span class="w">      </span><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">index2_temp_parcelle_zonage_ref_urbanisme</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">temp_parcelle_zonage_ref_urbanisme</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="n">btree</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">);</span>


<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">index_geom_temp_parcelle_zonage_ref_urbanisme</span>
<span class="k">ON</span><span class="w"> </span><span class="n">temp_parcelle_zonage_ref_urbanisme</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="n">gist</span><span class="w"> </span><span class="p">(</span><span class="n">geom</span><span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>Dans un second temps, on réalise l’union des tables temporaires, on calcule l’impact des zonages GPU par parcelle (par intersection) ainsi que la surface totale de chaque zonage.</p></li>
</ul>
<p><em>exemple d’UNION des zonages PLU et secteurs cartes communales</em></p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">with</span><span class="w"> </span><span class="n">parcelle_ref_urbanisme</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">   </span><span class="c1">--- selection des infos parcelles et zonages + impact zonage sur parcelle (intersection) + surface zonage total en metres carré</span>
<span class="w">   </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">geo_parcelle</span><span class="p">,</span><span class="n">z</span><span class="p">.</span><span class="n">partition</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">nomfic</span><span class="p">,</span><span class="n">z</span><span class="p">.</span><span class="n">datappro</span><span class="p">::</span><span class="nb">date</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">destdomi</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">datvalid</span><span class="p">::</span><span class="nb">date</span><span class="p">,</span><span class="w"> </span><span class="n">concat</span><span class="p">(</span><span class="n">round</span><span class="p">(</span><span class="n">st_area</span><span class="p">(</span><span class="n">z</span><span class="p">.</span><span class="n">geom</span><span class="p">)::</span><span class="nb">numeric</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)::</span><span class="nb">text</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; m²&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">surface</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Zonages&#39;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">type_doc</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">libelle</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">nom</span><span class="p">,</span><span class="w"> </span><span class="n">st_area</span><span class="p">(</span><span class="n">ST_CollectionExtract</span><span class="p">(</span><span class="n">st_intersection</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">geom</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">impact</span><span class="p">,</span>

<span class="w">            </span><span class="s1">&#39;surf&#39;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">impact_txt</span><span class="p">,</span>
<span class="w">            </span><span class="n">z</span><span class="p">.</span><span class="n">libelong</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">commentaire</span><span class="p">,</span><span class="w"> </span><span class="n">st_area</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">area_parcelle</span>
<span class="w">   </span><span class="k">FROM</span><span class="w"> </span><span class="n">cadastre</span><span class="p">.</span><span class="n">parcelle_info</span><span class="w"> </span><span class="n">p</span>
<span class="w">   </span><span class="k">join</span><span class="w"> </span><span class="n">temp_parcelle_zonage_ref_urbanisme</span><span class="w">  </span><span class="n">z</span>
<span class="w">   </span><span class="k">on</span><span class="w">  </span><span class="n">z</span><span class="p">.</span><span class="n">geo_parcelle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">geo_parcelle</span>
<span class="w">   </span><span class="p">)</span>
<span class="w">   </span><span class="k">UNION</span>
<span class="w">   </span><span class="c1">--- selection des infos parcelles et secteurs cartes communales + impact secteur sur parcelle (intersection) + surface secteure total en metres carré</span>
<span class="w">   </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">geo_parcelle</span><span class="p">,</span><span class="n">z</span><span class="p">.</span><span class="n">partition</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">nomfic</span><span class="p">,</span><span class="n">z</span><span class="p">.</span><span class="n">datappro</span><span class="p">::</span><span class="nb">date</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">destdomi</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">datvalid</span><span class="p">::</span><span class="nb">date</span><span class="p">,</span><span class="w"> </span><span class="n">concat</span><span class="p">(</span><span class="n">round</span><span class="p">(</span><span class="n">st_area</span><span class="p">(</span><span class="n">z</span><span class="p">.</span><span class="n">geom</span><span class="p">)::</span><span class="nb">numeric</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)::</span><span class="nb">text</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; m²&#39;</span><span class="p">)</span><span class="w">  </span><span class="k">as</span><span class="w"> </span><span class="n">surface</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Secteurs&#39;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">type_doc</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">libelle</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">nom</span><span class="p">,</span><span class="w"> </span><span class="n">st_area</span><span class="p">(</span><span class="n">ST_CollectionExtract</span><span class="p">(</span><span class="n">st_intersection</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">geom</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">impact</span><span class="p">,</span>
<span class="w">                        </span><span class="s1">&#39;surf&#39;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">impact_txt</span><span class="p">,</span>
<span class="w">            </span><span class="n">z</span><span class="p">.</span><span class="n">libelong</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">commentaire</span><span class="p">,</span><span class="w"> </span><span class="n">st_area</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">area_parcelle</span>
<span class="w">   </span><span class="k">FROM</span><span class="w"> </span><span class="n">cadastre</span><span class="p">.</span><span class="n">parcelle_info</span><span class="w"> </span><span class="n">p</span>
<span class="w">   </span><span class="k">join</span><span class="w"> </span><span class="n">temp_parcelle_secteurs_ref_urbanisme</span><span class="w"> </span><span class="n">z</span>
<span class="w">   </span><span class="k">on</span><span class="w">   </span><span class="n">z</span><span class="p">.</span><span class="n">geo_parcelle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">geo_parcelle</span>
<span class="w">   </span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<ul>
<li><p>On ne conserve que les entités dont l’impact sur la parcelle est supérieur à 1 ou qui sont des ponctuels et on construit les liens html pour consultation des documents pdf sur le GPU (concatenation de blocs html + num partition + clé dossier pdf emprise + nom de fichier)</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">geo_parcelle</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">parcelle</span><span class="p">,</span><span class="w"> </span><span class="n">type_doc</span><span class="p">,</span><span class="w"> </span><span class="n">destdomi</span><span class="p">,</span><span class="w"> </span><span class="n">nom</span><span class="p">,</span><span class="w"> </span><span class="n">datappro</span><span class="p">,</span><span class="w"> </span><span class="n">datvalid</span><span class="p">,</span><span class="w"> </span><span class="n">surface</span><span class="p">,</span><span class="w"> </span><span class="n">impact</span><span class="p">,</span>
<span class="k">case</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">impact_txt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;surf&#39;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="n">concat</span><span class="p">(</span><span class="n">round</span><span class="p">(</span><span class="n">impact</span><span class="p">::</span><span class="nb">numeric</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)::</span><span class="nb">text</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; m²&#39;</span><span class="p">)</span>
<span class="w">            </span><span class="k">when</span><span class="w"> </span><span class="n">impact_txt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;lin&#39;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="n">concat</span><span class="p">(</span><span class="n">impact</span><span class="p">::</span><span class="nb">text</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="n">impact_txt</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="c1">-- creation de l&#39;impact en text avec suffixe m² si surf, m si lineaire, sinon pas de suffixe</span>
<span class="w">            </span><span class="k">as</span><span class="w"> </span><span class="n">impact_text</span><span class="w"> </span><span class="p">,</span>
<span class="k">case</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">parcelle_ref_urbanisme</span><span class="p">.</span><span class="n">nomfic</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w">  </span><span class="k">then</span><span class="w"> </span><span class="n">concat</span><span class="p">(</span><span class="s1">&#39;&lt;a href=&quot;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;https://wxs-gpu.mongeoportail.ign.fr/externe/documents/&#39;</span><span class="p">,</span><span class="n">parcelle_ref_urbanisme</span><span class="p">.</span><span class="n">partition</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">,</span>
<span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">parcelle_ref_urbanisme</span><span class="p">.</span><span class="n">nomfic</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&quot; target=&quot;_blank&quot;&gt;Règlement&lt;/a&gt;&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;no data&#39;</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">reglement</span><span class="p">,</span>

<span class="n">commentaire</span><span class="p">,</span><span class="w"> </span><span class="n">round</span><span class="p">(</span><span class="n">impact</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">area_parcelle</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">taux_inclusion</span><span class="w"> </span><span class="c1">-- création taux d&#39;inclusion : pourcentage de l&#39;impact sur la surface de la parcelle</span>
<span class="k">from</span><span class="w"> </span><span class="n">parcelle_ref_urbanisme</span>
<span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">ref_urbanisme</span><span class="p">.</span><span class="n">gpu_api_emprise</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">parcelle_ref_urbanisme</span><span class="p">.</span><span class="n">partition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">partition</span><span class="w"> </span><span class="c1">-- jointure  de l&#39;emprise pour selection de la clé dossier pdf</span>
<span class="k">where</span><span class="w">  </span><span class="p">(</span><span class="n">parcelle_ref_urbanisme</span><span class="p">.</span><span class="n">impact</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">parcelle_ref_urbanisme</span><span class="p">.</span><span class="n">impact_txt</span><span class="w"> </span><span class="o">=</span><span class="s1">&#39;ponctuel&#39;</span><span class="p">)</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">geo_parcelle</span><span class="p">,</span><span class="w"> </span><span class="n">type_doc</span><span class="w"> </span><span class="k">DESC</span><span class="p">,</span><span class="w"> </span><span class="n">nom</span><span class="w"> </span><span class="k">ASC</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>On construit ensuite les déroulants de détail en html(en accordéon) : concatenation de blocs html et des champs d’informations. On concatène seulement les valeurs non nulles.</p></li>
</ul>
<p><em>exemple de création de déroulant accordéon zonage PLU</em></p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">parcelle</span><span class="p">,</span><span class="w"> </span><span class="c1">-- création d&#39;un déroulant &quot;accordion html&quot; zonage pour détail du zonage par parcelle</span>
<span class="w">      </span><span class="n">string_agg</span><span class="p">(</span>
<span class="w">                  </span><span class="p">(</span><span class="s1">&#39;&lt;br&gt;&lt;details class=&quot;accordion_urba&quot;&gt;&lt;summary&gt; Zone &#39;</span><span class="o">||</span><span class="k">coalesce</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">nom</span><span class="p">,</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">||</span><span class="s1">&#39;&lt;/summary&gt;&lt;b&gt;DestDomi&lt;/b&gt;      &#39;</span><span class="o">||</span><span class="k">coalesce</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">destdomi</span><span class="p">,</span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">||</span><span class="s1">&#39;&lt;br&gt;&lt;b&gt;Description&lt;/b&gt;     &#39;</span><span class="o">||</span><span class="k">coalesce</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">commentaire</span><span class="p">,</span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">||</span><span class="s1">&#39; &lt;br&gt;&lt;b&gt;Approbation&lt;/b&gt;     &#39;</span><span class="o">||</span><span class="k">coalesce</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">datappro</span><span class="p">::</span><span class="nb">text</span><span class="p">,</span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">||</span><span class="s1">&#39; &lt;br&gt;&lt;b&gt;Validité&lt;/b&gt;     &#39;</span><span class="o">||</span><span class="k">coalesce</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">datvalid</span><span class="p">::</span><span class="nb">text</span><span class="p">,</span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">||</span><span class="s1">&#39; &lt;br&gt;&lt;b&gt;Surface &lt;/b&gt;     &#39;</span><span class="o">||</span><span class="k">coalesce</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">surface</span><span class="p">::</span><span class="nb">text</span><span class="p">,</span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">||</span><span class="s1">&#39; &lt;/details&gt;&#39;</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">      </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">type_doc</span><span class="w"> </span><span class="k">DESC</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">nom</span><span class="w"> </span><span class="k">ASC</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">deroulant_zonage</span><span class="w"> </span><span class="c1">-- ordonne par type de document descendant et par nom de document acsendant</span>
<span class="w">            </span><span class="k">from</span><span class="w"> </span><span class="n">pre_fiche</span><span class="w"> </span><span class="n">a</span>
<span class="w">            </span><span class="k">where</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">type_doc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Zonages&#39;</span>
<span class="w">            </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">parcelle</span>
</pre></div>
</div>
</div></blockquote>
<ul>
<li><p>création du tableau HTML principal détaillant le zonage ou carte communale, les prescriptions et les infos prescriptions et ajout des déroulants de détails précédemment créés</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">geo_parcelle</span><span class="p">::</span><span class="nb">varchar</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">parcelle</span><span class="p">,</span><span class="w"> </span><span class="n">concat</span><span class="p">(</span><span class="c1">-- creation du tableau HTML principal détaillant le zonage ou carte communale, les prescriptions et les infos prescriptions</span>
<span class="w">      </span><span class="s1">&#39;&lt;table class = &quot;t1&quot; &gt;</span>
<span class="s1">&lt;tr&gt;</span>
<span class="s1">   &lt;th&gt; Types &lt;/th&gt;</span>
<span class="s1">   &lt;th&gt; Nom &lt;/th&gt;</span>
<span class="s1">   &lt;th&gt; Règlement &lt;/th&gt;</span>
<span class="s1">   &lt;th&gt; Impact &lt;/th&gt;</span>
<span class="s1">   &lt;th&gt; Commentaire &lt;/th&gt;</span>
<span class="s1">   &lt;th&gt; Taux d&#39;&#39;inclusion &lt;/th&gt;</span>
<span class="s1">&lt;/tr&gt;</span>
<span class="s1">&lt;tr&gt;&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">string_agg</span><span class="p">(</span><span class="w"> </span><span class="c1">-- concatenation bloc html + aggregation des champs d&#39;informations</span>
<span class="w">   </span><span class="p">(</span><span class="s1">&#39;&lt;td&gt; &#39;</span><span class="w">  </span><span class="o">||</span><span class="k">coalesce</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">type_doc</span><span class="p">,</span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">||</span><span class="w">  </span><span class="s1">&#39;  &lt;/td&gt;&lt;td&gt; &#39;</span><span class="w"> </span><span class="o">||</span><span class="k">coalesce</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">nom</span><span class="p">,</span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;  &lt;/td&gt;&lt;td&gt; &#39;</span><span class="w"> </span><span class="o">||</span><span class="k">coalesce</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">reglement</span><span class="p">,</span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;  &lt;/td&gt;&lt;td&gt;  &#39;</span><span class="w"> </span><span class="o">||</span><span class="k">coalesce</span><span class="p">(</span><span class="n">impact_text</span><span class="p">,</span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;  &lt;/td&gt;&lt;td&gt;  &#39;</span><span class="o">||</span><span class="k">coalesce</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">commentaire</span><span class="p">,</span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">||</span><span class="s1">&#39;  &lt;/td&gt;&lt;td&gt;  &#39;</span><span class="w"> </span><span class="o">||</span><span class="k">coalesce</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">taux_inclusion</span><span class="p">::</span><span class="nb">text</span><span class="p">,</span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">||</span><span class="w">  </span><span class="s1">&#39;  &lt;/td&gt;&#39;</span><span class="w"> </span><span class="p">),</span><span class="s1">&#39;&lt;/tr&gt;</span>
<span class="s1">      &lt;tr&gt;&#39;</span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">type_doc</span><span class="w"> </span><span class="k">DESC</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">nom</span><span class="w"> </span><span class="k">ASC</span><span class="p">),</span><span class="w"> </span><span class="c1">-- ordonne par type de document descendant et par nom de document acsendant</span>
<span class="w">      </span><span class="s1">&#39;&lt;/tr&gt;</span>
<span class="s1">      &lt;/table&gt;&#39;</span><span class="p">)::</span><span class="nb">varchar</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">tab_doc_urba</span><span class="p">,</span><span class="w"> </span><span class="n">deroulant_zonages</span><span class="p">.</span><span class="n">deroulant_zonage</span><span class="p">::</span><span class="nb">varchar</span><span class="w"> </span><span class="p">,</span><span class="n">deroulant_secteurs</span><span class="p">.</span><span class="n">deroulant_secteur</span><span class="p">::</span><span class="nb">varchar</span><span class="p">,</span><span class="w"> </span><span class="c1">-- ajout des champs html déroulants</span>
<span class="w">         </span><span class="n">deroulant_prescriptions</span><span class="p">.</span><span class="n">deroulant_prescription</span><span class="p">::</span><span class="nb">varchar</span><span class="p">,</span><span class="w"> </span><span class="n">deroulant_infos</span><span class="p">.</span><span class="n">deroulant_info</span><span class="p">::</span><span class="nb">varchar</span><span class="p">,</span>
<span class="n">a</span><span class="p">.</span><span class="n">geom</span>
<span class="k">from</span>
<span class="n">cadastre</span><span class="p">.</span><span class="n">parcelle_info</span><span class="w"> </span><span class="n">a</span>
<span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">pre_fiche</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">parcelle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">geo_parcelle</span>
<span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">deroulant_zonages</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">deroulant_zonages</span><span class="p">.</span><span class="n">parcelle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">geo_parcelle</span>
<span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">deroulant_secteurs</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">deroulant_secteurs</span><span class="p">.</span><span class="n">parcelle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">geo_parcelle</span>
<span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">deroulant_prescriptions</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">deroulant_prescriptions</span><span class="p">.</span><span class="n">parcelle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">geo_parcelle</span>
<span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">deroulant_infos</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">deroulant_infos</span><span class="p">.</span><span class="n">parcelle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">geo_parcelle</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">geo_parcelle</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">deroulant_zonages</span><span class="p">.</span><span class="n">deroulant_zonage</span><span class="p">,</span><span class="n">deroulant_secteurs</span><span class="p">.</span><span class="n">deroulant_secteur</span><span class="p">,</span>
<span class="n">deroulant_prescriptions</span><span class="p">.</span><span class="n">deroulant_prescription</span><span class="p">,</span><span class="w"> </span><span class="n">deroulant_infos</span><span class="p">.</span><span class="n">deroulant_info</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>création d’un index sur la table temporaire et update des champs html de la table parcelle info</p></li>
</ul>
<p><em>exemple de mise à jour du champs tableau html</em></p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">update</span><span class="w"> </span><span class="n">cadastre</span><span class="p">.</span><span class="n">parcelle_info</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">tab_doc_urba</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">tab_doc_urba</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">temp_fiche</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">parcelle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parcelle_info</span><span class="p">.</span><span class="n">geo_parcelle</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="parametrage-qgis-plugin-lizmap">
<h4>2.2 - Paramètrage Qgis/plugin Lizmap<a class="headerlink" href="#parametrage-qgis-plugin-lizmap" title="Permalink to this heading"></a></h4>
<ul class="simple">
<li><p>Mise à jour de l’info bulle HTML dans les propriétés de la couche QGIS</p></li>
</ul>
<a class="reference internal image-reference" href="_images/18_info_bulle_html.png"><img alt="_images/18_info_bulle_html.png" src="_images/18_info_bulle_html.png" style="width: 957.0px; height: 511.0px;" /></a>
<p>Le code HTML (Onglet Urbanisme + parties tab_doc_urba + deroulant : secteurs, zonages, prescriptions, info) se trouve <a class="reference external" href="https://github.com/sig14/sig14.github.io/blob/master/cadastre/html/popup_cadastre.html">ici</a></p>
</div>
<div class="section" id="rendu-lizmap">
<h4>2.3 - Rendu lizmap<a class="headerlink" href="#rendu-lizmap" title="Permalink to this heading"></a></h4>
<ul class="simple">
<li><p>Mise à jour du CSS dans le panneau de configuration Lizmap</p></li>
</ul>
<p>Le code CSS se trouve <a class="reference external" href="https://github.com/sig14/sig14.github.io/blob/master/cadastre/css/docs_urba_cadastre.css">en suivant ce lien</a></p>
<a class="reference internal image-reference" href="_images/19_config_css.png"><img alt="_images/19_config_css.png" src="_images/19_config_css.png" style="width: 891.0px; height: 407.0px;" /></a>
</div>
</div>
<div class="section" id="mise-a-jour-quotidienne-des-donnees">
<h3>3- Mise à jour quotidienne des données<a class="headerlink" href="#mise-a-jour-quotidienne-des-donnees" title="Permalink to this heading"></a></h3>
<p>A chaque modification d’un document ou ajout par une collectivité sur le GPU, le pôle SIG du Département met à jour les données issues du GPU dans la base de données CD14 et met également à jour les fiches HTML de la table parcelle_info du cadastre.</p>
<div class="section" id="mailing-auto">
<h4>3.1 - Mailing auto<a class="headerlink" href="#mailing-auto" title="Permalink to this heading"></a></h4>
<p>Le Géoportail de l’Urbanisme met à disposition un flux ATOM permettant de connaître les dernières mises à jour de documents sur le GPU.</p>
<p>La documentation suivante décrit comment exploiter ce flux : <a class="reference external" href="https://www.geoportail-urbanisme.gouv.fr/image/UtilisationATOM_GPU_1-0.pdf">https://www.geoportail-urbanisme.gouv.fr/image/UtilisationATOM_GPU_1-0.pdf</a></p>
<p>Le pôle SIG utilise un site dédié qui exploite ce flux afin d’envoyer un mail à l’équipe SIG à chaque ajout d’une commmune du Département du calvados.</p>
<p>A la réception de ce mail, un membre de l’équipe déclenche un fichier batch, permettant d’indiquer le numéro de partition et lançant 3 workbench FME de suppression, d’intégration des données GPU dans la BD CD14 et de mise à jour des champs HTML des parcelles du cadastre.</p>
<blockquote>
<div><div class="highlight-batch notranslate"><div class="highlight"><pre><span></span><span class="k">set</span> <span class="k">/p</span> <span class="nv">siren</span><span class="p">=</span> <span class="s2">&quot; Saisir l&#39;INSEE de la commune ou le Siren de l&#39;EPCI entre guillemets &quot;</span>

D<span class="p">:</span><span class="nl">/apps/FME2022/fme.exe</span><span class="c1"> &quot;D:/_FME/DOC_URBA/api_gpu2postgis/Commune_epci/1_DROP_DATA.fmw&quot; --siren %siren%</span>

D<span class="p">:</span><span class="nl">/apps/FME2022/fme.exe</span><span class="c1"> &quot;D:/_FME/DOC_URBA/api_gpu2postgis/Commune_epci/2_INSERT_DATA.fmw&quot; --siren %siren%</span>

D<span class="p">:</span><span class="nl">/apps/FME2022/fme.exe</span><span class="c1"> &quot;D:/_FME/DOC_URBA/api_gpu2postgis/Commune_epci/3_FICHE_DOC_URBA_CADASTRE.fmw&quot; --siren %siren%</span>

<span class="k">pause</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="fme-import-de-l-emprise-et-supression-des-donnees">
<h4>3.2 - FME : Import de l’emprise et supression des données<a class="headerlink" href="#fme-import-de-l-emprise-et-supression-des-donnees" title="Permalink to this heading"></a></h4>
<p>Le premier worbench FME supprime les données GPU de la base sur le périmètre des nouvelles données importées.</p>
<p>Le workbench FME se <a class="reference external" href="https://github.com/sig14/sig14.github.io/releases/tag/FME_drop_data_gpu">télécharge ici</a></p>
<ul class="simple">
<li><p>Récupération du code siren EPCI ou insee commune entré dans le batch et ajout des potentiels suffixes (code optionnel secteur)</p></li>
</ul>
<a class="reference internal image-reference" href="_images/20_partition_maj_.png"><img alt="_images/20_partition_maj_.png" src="_images/20_partition_maj_.png" style="width: 344.0px; height: 300.0px;" /></a>
<ul class="simple">
<li><p>Interrogation de l’API avec code partition pour récupérer l’emprise</p></li>
</ul>
<a class="reference internal image-reference" href="_images/21_emprise_maj_.png"><img alt="_images/21_emprise_maj_.png" src="_images/21_emprise_maj_.png" style="width: 221.0px; height: 272.0px;" /></a>
<p><em>Paramètres interrogation API</em> :</p>
<p>Interrogation de l’API avec les DU_partition précédemment créés</p>
<p>URL : <a class="reference external" href="https://apicarto.ign.fr/api/gpu/document?partition=DU_&#64;Value(siren">https://apicarto.ign.fr/api/gpu/document?partition=DU_&#64;Value(siren</a>)</p>
<p>HTTP method : GET</p>
<p>response body : Attribute</p>
<ul class="simple">
<li><p>Interrogation de l’API avec code partition pour récupérer l’emprise</p></li>
</ul>
<a class="reference internal image-reference" href="_images/21_emprise_maj_.png"><img alt="_images/21_emprise_maj_.png" src="_images/21_emprise_maj_.png" style="width: 221.0px; height: 272.0px;" /></a>
<ul class="simple">
<li><p>Filtrer les données à partir de la réponse JSON : Expression régulière conservant le chiffre après ‘totalFeatures’ et conservation des lignes dont la valeur est différente de 0.</p></li>
</ul>
<a class="reference internal image-reference" href="_images/14_numb_feature_filter_doc_urba.png"><img alt="_images/14_numb_feature_filter_doc_urba.png" src="_images/14_numb_feature_filter_doc_urba.png" style="width: 221.0px; height: 127.5px;" /></a>
<ul class="simple">
<li><p>Extraction des données du JSON : exposer les attributs et la géométrie</p></li>
</ul>
<a class="reference internal image-reference" href="_images/15_expose_attributes_doc_urba.png"><img alt="_images/15_expose_attributes_doc_urba.png" src="_images/15_expose_attributes_doc_urba.png" style="width: 428.0px; height: 163.5px;" /></a>
<ul class="simple">
<li><p>Retraitement des données : supression des prefixes de champs et reprojection de la géométrie (de 4326 à 2154)</p></li>
</ul>
<a class="reference internal image-reference" href="_images/16_reprojection_doc_urba.png"><img alt="_images/16_reprojection_doc_urba.png" src="_images/16_reprojection_doc_urba.png" style="width: 250.0px; height: 95.0px;" /></a>
<ul class="simple">
<li><p>Insertion des données dans la table historique_import_donnees et lancement d’une requête SQL supprimant les données GPU dont le “DU _” est égal au “DU _” de leur emprise intersectant le buffer de - 500 mètres de la nouvelle emprise insérée.</p></li>
</ul>
<a class="reference internal image-reference" href="_images/22_supression_partition_.png"><img alt="_images/22_supression_partition_.png" src="_images/22_supression_partition_.png" style="width: 294.0px; height: 271.5px;" /></a>
<p><em>Exemple SQL de supression de zonages PLU</em></p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">delete</span>
<span class="k">from</span><span class="w"> </span><span class="n">ref_urbanisme</span><span class="p">.</span><span class="n">gpu_api_zonages</span><span class="w"> </span><span class="k">g</span>
<span class="k">where</span><span class="w"> </span><span class="k">g</span><span class="p">.</span><span class="n">partition</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="p">(</span>
<span class="w">   </span><span class="k">select</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">partition</span>
<span class="w">   </span><span class="k">from</span><span class="w"> </span><span class="n">ref_urbanisme</span><span class="p">.</span><span class="n">historique_imports_du</span><span class="w"> </span><span class="n">a</span>
<span class="w">   </span><span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">ref_urbanisme</span><span class="p">.</span><span class="n">gpu_api_emprise</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">st_intersects</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">st_buffer</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">500</span><span class="p">))</span>
<span class="k">where</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">date_import</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="p">()::</span><span class="nb">date</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">partition</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;DU_$(siren)%&#39;</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">partition</span><span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="fme-import-des-donnees-en-fonction-de-l-emprise">
<h4>3.3 - FME : Import des données en fonction de l’emprise<a class="headerlink" href="#fme-import-des-donnees-en-fonction-de-l-emprise" title="Permalink to this heading"></a></h4>
<p>Le second worbench FME insère les nouvelles données GPU au niveau du code partition “DU _” entré dans le batch sur le modèle décrit dans la partie 1.</p>
<p>Le workbench FME se  <a class="reference external" href="https://github.com/sig14/sig14.github.io/releases/tag/FME_insert_data_gpu_on_du">trouve ici</a></p>
</div>
<div class="section" id="fme-postgresql-gis-mise-a-jour-des-champs-html-gpu-du-cadastre">
<h4>3.4 - FME/PostgreSQL,GIS : Mise à jour des champs html GPU du cadastre<a class="headerlink" href="#fme-postgresql-gis-mise-a-jour-des-champs-html-gpu-du-cadastre" title="Permalink to this heading"></a></h4>
<p>Le dernier worbench FME lance une fonction mettant à jour les champs HTML du cadastre au niveau du nouveau “DU _ partition” renseigné dans le batch.</p>
<p>Le workbench FME  <a class="reference external" href="https://github.com/sig14/sig14.github.io/releases/tag/FME_fiches_cadastre_docs_urba_gpu">se télécharge ici</a></p>
<p>Ce workbench fonctionne comme le premier workbench récupérant l’emprise, mais avec une dernière requête qui corrige les géométries invalides des documents GPU et qui lance une fonction postgresql de mise à jour des champs HTML de la table parcelle_info du cadastre.</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">update</span><span class="w"> </span><span class="n">ref_urbanisme</span><span class="p">.</span><span class="n">gpu_api_zonages</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">geom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ST_MakeValid</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">gpu_api_zonages</span><span class="p">.</span><span class="n">partition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">Value</span><span class="p">(</span><span class="n">partition</span><span class="p">);</span>

<span class="k">update</span><span class="w"> </span><span class="n">ref_urbanisme</span><span class="p">.</span><span class="n">gpu_api_secteur_cc</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">geom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ST_MakeValid</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">gpu_api_secteur_cc</span><span class="p">.</span><span class="n">partition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">Value</span><span class="p">(</span><span class="n">partition</span><span class="p">);</span>

<span class="k">update</span><span class="w"> </span><span class="n">ref_urbanisme</span><span class="p">.</span><span class="n">gpu_api_prescription_surf</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">geom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ST_MakeValid</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">gpu_api_prescription_surf</span><span class="p">.</span><span class="n">partition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">Value</span><span class="p">(</span><span class="n">partition</span><span class="p">);</span>

<span class="k">update</span><span class="w"> </span><span class="n">ref_urbanisme</span><span class="p">.</span><span class="n">gpu_api_prescription_lin</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">geom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ST_MakeValid</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">gpu_api_prescription_lin</span><span class="p">.</span><span class="n">partition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">Value</span><span class="p">(</span><span class="n">partition</span><span class="p">);</span>

<span class="k">update</span><span class="w"> </span><span class="n">ref_urbanisme</span><span class="p">.</span><span class="n">gpu_api_info_prescription_surf</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">geom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ST_MakeValid</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">gpu_api_info_prescription_surf</span><span class="p">.</span><span class="n">partition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">Value</span><span class="p">(</span><span class="n">partition</span><span class="p">);</span>
<span class="k">update</span><span class="w"> </span><span class="n">ref_urbanisme</span><span class="p">.</span><span class="n">gpu_api_info_prescription_lin</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">geom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ST_MakeValid</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">gpu_api_info_prescription_lin</span><span class="p">.</span><span class="n">partition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">Value</span><span class="p">(</span><span class="n">partition</span><span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
<p>Une requête à part permet de mettre à jour le html :</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">ref_urbanisme</span><span class="p">.</span><span class="n">fiches_parcelles_lizmap</span><span class="p">(</span><span class="o">@</span><span class="n">Value</span><span class="p">(</span><span class="n">partition</span><span class="p">));</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
</div>
<span id="document-cadastre/III_filiation_parcelles"></span><div class="section" id="iii-ajouter-un-onglet-filiation-parcellaire-a-la-pop-up-cadastre-de-lizmap">
<h2>III- Ajouter un onglet “Filiation parcellaire” à la pop-up cadastre de Lizmap<a class="headerlink" href="#iii-ajouter-un-onglet-filiation-parcellaire-a-la-pop-up-cadastre-de-lizmap" title="Permalink to this heading"></a></h2>
<a class="reference internal image-reference" href="_images/schema_dfi_cadastre.png"><img alt="_images/schema_dfi_cadastre.png" src="_images/schema_dfi_cadastre.png" style="width: 1196.0px; height: 595.0px;" /></a>
<p>Les fichiers départementaux des documents de filiation informatisés (DFI) des parcelles permettent de consulter l’historique des parcelles cadastrales.</p>
<p>Ce fichier recense les modifications parcellaires réalisées depuis l’informatisation de leur procédure de mise à jour qui, selon les départements, est intervenue entre les années 1980 à 1990. L’origine des différentes mises à jour (documents d’arpentage, croquis de conservation, remaniement…) ainsi que leurs dates sont renseignées.</p>
<p>Ce fichier sont disponibles sur le site <a class="reference external" href="https://www.data.gouv.fr/fr/datasets/documents-de-filiation-informatises-dfi-des-parcelles/">datagouv.fr</a></p>
<p>Le fichier est au format txt. Le point-virgule est le caractère séparateur. La taille des champs est fixe.</p>
<p>Chaque lot d’analyse d’un même document de filiation fait l’objet de deux lignes successives :</p>
<ul class="simple">
<li><p>celle de type 1 pour toutes ses parcelles mères (il peut n’y en avoir aucune dans le cas d’extraction du domaine non cadastré) ;</p></li>
<li><p>celle de type 2 pour toutes ses parcelles filles (il peut n’y en avoir aucune dans le cas de passage au domaine public).</p></li>
</ul>
<a class="reference internal image-reference" href="_images/filiation_parcelles.gif"><img alt="_images/filiation_parcelles.gif" src="_images/filiation_parcelles.gif" style="width: 806.0px; height: 491.0px;" /></a>
<p>A partir de ce fichier, le pôle SIG du Département du Calvados, propose de consulter la généalogie d’une parcelle.</p>
<div class="section" id="traitement-et-import-fme-des-donnees">
<h3>1- Traitement et import FME des données<a class="headerlink" href="#traitement-et-import-fme-des-donnees" title="Permalink to this heading"></a></h3>
<p>Le fichier DFI est difficilement exploitable en brut.</p>
<p>Le fichier sépare chaque valeur par un ; .</p>
<p>Le nombre de valeurs de parcelles est variable, ce qui implique un nombre de champ variable.</p>
<p>Le workbench FME se trouve <a class="reference external" href="https://github.com/sig14/sig14.github.io/releases/tag/FME_filiation_parcelles_dfi">ici</a></p>
<div class="section" id="regexp-correction-du-fichier">
<h4>1.1 Regexp : correction du fichier<a class="headerlink" href="#regexp-correction-du-fichier" title="Permalink to this heading"></a></h4>
<p>Dans un premier temps, afin de pouvoir correcetement lire le fichier, les données parcelles sont réunies en listes dans un seul champ à l’aide d’expression régulière et de l’ETL FME.</p>
<p>140;001;000;0000299;1;19900305;XXXXXREDACTEURDUDOCUMENTXXXX;00001;2;A0297;A0298;</p>
<ul>
<li><p>Identifier les listes de parcelles après le 9e <strong>;</strong></p>
<blockquote>
<div><p>(?:[^;]*;){9}(.*)</p>
</div></blockquote>
</li>
</ul>
<p>match1 : <strong>140;001;000;0000299;1;19900305;XXXXXREDACTEURDUDOCUMENTXXXX;00001;2;A0297;A0298;</strong></p>
<p>group1 : <strong>A0297;A0298;</strong></p>
<ul>
<li><p>Extraire le résultat du group1 dans un attribute creator</p>
<blockquote>
<div><p><strong>&#64;Value(list_parcelles{0}.part)</strong></p>
</div></blockquote>
</li>
<li><p>Supprimer les valeurs du group du premier match</p></li>
</ul>
<p>match1 : <strong>140;001;000;0000299;1;19900305;XXXXXREDACTEURDUDOCUMENTXXXX;00001;2</strong></p>
<ul class="simple">
<li><p>Remplacer les <strong>;</strong> du resultat de liste de parcelles extrait par des <strong>,</strong></p></li>
</ul>
<p>group1 : <strong>A0297,A0298,</strong></p>
<ul class="simple">
<li><p>Concatener le match 1 et les résultas extraits</p></li>
</ul>
<p><strong>140;001;000;0000299;1;19900305;XXXXXREDACTEURDUDOCUMENTXXXX;00001;2;A0297, A0298,</strong></p>
<ul class="simple">
<li><p>On ajoute ensuite une ligne avec la liste des nom de champ</p></li>
</ul>
<a class="reference internal image-reference" href="_images/23_add_name_fiel_.png"><img alt="_images/23_add_name_fiel_.png" src="_images/23_add_name_fiel_.png" style="width: 783.5px; height: 226.5px;" /></a>
</div>
<div class="section" id="lecture-du-csv">
<h4>1.2 Lecture du CSV<a class="headerlink" href="#lecture-du-csv" title="Permalink to this heading"></a></h4>
<p>Après écriture du fichier, on lit le fichier CSV en exposant la liste des attributs souhaités.</p>
<a class="reference internal image-reference" href="_images/24_expose_attribute.png"><img alt="_images/24_expose_attribute.png" src="_images/24_expose_attribute.png" style="width: 269.5px; height: 222.0px;" /></a>
</div>
<div class="section" id="remplacer-seconde-correction-du-fichier">
<h4>1.3 Remplacer : seconde correction du fichier<a class="headerlink" href="#remplacer-seconde-correction-du-fichier" title="Permalink to this heading"></a></h4>
<p>On effectue une dernière correction du fichier avant intégration dans la base de données.</p>
<a class="reference internal image-reference" href="_images/25_retraitement_dfi.png"><img alt="_images/25_retraitement_dfi.png" src="_images/25_retraitement_dfi.png" style="width: 369.0px; height: 201.0px;" /></a>
<ul class="simple">
<li><p>Ajout des préfixes 0 aux sections et codecom en fonction de la longueur des variables (un 0 si length() = 2,  deux 0 si length() =1 .</p></li>
<li><p>supprimmer les espaces dans le champ list parcelle</p></li>
<li><p>supprimmer la dernière virgule en trop dans le champ list parcelle</p></li>
</ul>
</div>
</div>
<div class="section" id="champ-html-historique-deroulant">
<h3>2- Champ HTML historique déroulant<a class="headerlink" href="#champ-html-historique-deroulant" title="Permalink to this heading"></a></h3>
<p>L’objectif est ici de pouvoir consulter l’historique des filiations à l’échelle de la parcelle.</p>
<p>L’utilisateur peut, en cliquant sur une parcelle, consulter la généalogie de sa parcelle, connaitre sa/ses parcelles méres (antérieur), ses parcelles soeurs (issues de la/des même(s) parcelle(s) mère(s)) et connaître la nature de la filiation.</p>
<p>Pour cela on utilise une fonction postgresql/gis pour alimenter la table parcelle_info du cadastre et une mise en forme du formulaire QGIS en HTML pour publication sur le portail cartographique Lizmap.</p>
<div class="section" id="fonction-postgresql-gis">
<h4>2.1 - Fonction postgresql/gis<a class="headerlink" href="#fonction-postgresql-gis" title="Permalink to this heading"></a></h4>
<ul>
<li><p>On crée le champ contenant l’html des déroulants détaillant les filiations du plus récent au plus ancien</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">cadastre</span><span class="p">.</span><span class="n">parcelle_info</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">column</span><span class="w"> </span><span class="n">tab_filiation</span><span class="w"> </span><span class="nb">text</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<p>On lance ensuite une fonction postgresql/gis dont le code SQL se trouve <a class="reference external" href="https://github.com/sig14/sig14.github.io/blob/master/cadastre/sql/fonction_filiation_parcelles_cadastre.sql">ICI</a></p>
<ul>
<li><p>Dans un premier temps, la fonction met en place une table temporaire (que l’on va indexer) regroupant ligne par ligne les infos dfi, la nature détaillée des dfi, la liste des parcelles mères et la liste des parcelles filles associées (filiation)</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">create</span><span class="w"> </span><span class="n">UNLOGGED</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">temp_parcelles_dfi</span><span class="w"> </span><span class="k">as</span>
<span class="k">SELECT</span>
<span class="n">a</span><span class="p">.</span><span class="n">code_com</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">code_com</span><span class="p">,</span>
<span class="w">   </span><span class="n">a</span><span class="p">.</span><span class="n">pref_section</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">pref_section</span><span class="p">,</span>
<span class="w">   </span><span class="n">a</span><span class="p">.</span><span class="n">id_dfi</span><span class="p">,</span>
<span class="w">   </span><span class="n">a</span><span class="p">.</span><span class="n">num_analyse</span><span class="p">,</span>
<span class="w">   </span><span class="n">a</span><span class="p">.</span><span class="n">date_valid</span><span class="p">,</span>
<span class="w">   </span><span class="k">case</span><span class="w"> </span><span class="k">when</span>
<span class="w">   </span><span class="n">a</span><span class="p">.</span><span class="n">nature_dfi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;arpentage&#39;</span>
<span class="w">   </span><span class="k">when</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">nature_dfi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;2&#39;</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;croquis de conservation&#39;</span>
<span class="w">   </span><span class="k">when</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">nature_dfi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;4&#39;</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;remaniement&#39;</span>
<span class="w">   </span><span class="k">when</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">nature_dfi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;5&#39;</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;arpentage numerique&#39;</span>
<span class="w">      </span><span class="k">when</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">nature_dfi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;6&#39;</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;lotissement numérique&#39;</span>
<span class="w">      </span><span class="k">when</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">nature_dfi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;7&#39;</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;lotissement&#39;</span>
<span class="w">            </span><span class="k">when</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">nature_dfi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;8&#39;</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;rénovation&#39;</span><span class="k">end</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">nature_dfi</span><span class="p">,</span><span class="c1">-- détail de la nature en fonction du code_nature</span>
<span class="w">   </span><span class="n">a</span><span class="p">.</span><span class="n">list_parcelle</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">parcelles_meres</span><span class="p">,</span><span class="w"> </span><span class="c1">-- liste des parcelles mères quand type_ligne = 1</span>
<span class="w">   </span><span class="n">b</span><span class="p">.</span><span class="n">list_parcelle</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">parcelles_filles</span><span class="w"> </span><span class="c1">--liste des parcelles filles associées aux parcelles mères quand type_ligne = 2 (jointure sur date, code com, section, id_dfi et numero d&#39;analyse)</span>
<span class="w">   </span><span class="k">FROM</span><span class="w"> </span><span class="n">ref_foncier</span><span class="p">.</span><span class="n">parcelles_dfi</span><span class="w"> </span><span class="n">a</span><span class="p">,</span>
<span class="w">   </span><span class="n">ref_foncier</span><span class="p">.</span><span class="n">parcelles_dfi</span><span class="w"> </span><span class="n">b</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">type_ligne</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="p">::</span><span class="nb">text</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">type_ligne</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;2&#39;</span><span class="p">::</span><span class="nb">text</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">concat</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">date_valid</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">code_com</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">pref_section</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id_dfi</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">num_analyse</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">concat</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">date_valid</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">code_com</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">pref_section</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id_dfi</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">num_analyse</span><span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Création d’une table temporaire listant les premières filiations liées aux parcelles actuelles du cadastre</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">create</span><span class="w"> </span><span class="n">UNLOGGED</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">temp_parcelles_init</span><span class="w"> </span><span class="k">as</span>
<span class="k">with</span><span class="w"> </span><span class="n">parcelle_init</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="w">     </span><span class="c1">-- liste des parcelles du cadastre qui sont comprises dans les parcelles filles dfi</span>
<span class="w">         </span><span class="k">select</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">code_com</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">date_valid</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">nature_dfi</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">pref_section</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id_dfi</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">num_analyse</span><span class="p">,</span>
<span class="w">      </span><span class="n">a</span><span class="p">.</span><span class="n">parcelles_meres</span><span class="p">,</span><span class="w"> </span><span class="c1">-- Conservation des parcelles mères dfi dont les filles comprennent une parcelle du cadastre</span>
<span class="w">      </span><span class="n">concat</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">ccosec</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">dnupla</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;}&#39;</span><span class="p">)::</span><span class="nb">text</span><span class="p">[]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">parcelles_filles</span><span class="p">,</span><span class="w"> </span><span class="c1">-- Parcelle du cadastre associée aux parcelles filles dfi</span>
<span class="w">      </span><span class="k">replace</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">parcelles_filles</span><span class="p">::</span><span class="nb">text</span><span class="p">,</span><span class="n">concat</span><span class="p">(</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">ccosec</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">dnupla</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w">  </span><span class="k">as</span><span class="w"> </span><span class="n">parcelles_soeurs</span><span class="w"> </span><span class="c1">-- Supprimer (remplacer par &#39;&#39;) la parcelle du cadastre associée de la liste des parcelles filles pour trouver les parcelles soeurs</span>
<span class="w">            </span><span class="k">from</span><span class="w"> </span><span class="n">temp_parcelles_dfi</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">cadastre</span><span class="p">.</span><span class="n">parcelle</span><span class="w"> </span><span class="n">b</span>
<span class="w">            </span><span class="k">where</span><span class="w">  </span><span class="n">concat</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">ccosec</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">dnupla</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">ANY</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">parcelles_filles</span><span class="p">::</span><span class="nb">text</span><span class="p">[])</span><span class="w"> </span><span class="c1">-- jointure sur les num parcelle et section cadastre dans les parcelles filles dfi</span>
<span class="w">            </span><span class="k">and</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">code_com</span><span class="p">::</span><span class="nb">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">ccocom</span><span class="w"> </span><span class="c1">-- et sur une même commune</span>
<span class="w">            </span><span class="k">and</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">pref_section</span><span class="p">::</span><span class="nb">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">translate</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">ccopre</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">)</span><span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="c1">-- et sur un même prefixe de séction</span>

<span class="w">   </span><span class="k">select</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">code_com</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">date_valid</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">nature_dfi</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">pref_section</span><span class="p">,</span>
<span class="w">   </span><span class="n">a</span><span class="p">.</span><span class="n">parcelles_meres</span><span class="p">::</span><span class="nb">text</span><span class="p">[],</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">parcelles_filles</span><span class="p">::</span><span class="nb">text</span><span class="p">[]</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="k">replace</span><span class="p">(</span><span class="k">translate</span><span class="p">(</span><span class="n">parcelles_soeurs</span><span class="p">::</span><span class="nb">text</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;{}&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">parcelles_soeurs</span><span class="p">,</span><span class="w"> </span><span class="c1">-- transformation en format liste des listes de parcelles</span>
<span class="w">   </span><span class="mi">1</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num_filiation</span><span class="p">,</span><span class="w"> </span><span class="c1">-- création d&#39;un numéro de filiation</span>
<span class="w">   </span><span class="n">concat</span><span class="p">(</span><span class="k">translate</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">parcelles_filles</span><span class="p">::</span><span class="nb">text</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;{}&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">id_filiation</span><span class="w"> </span><span class="c1">---conserver le numéro de parcelle fille initial en format txt</span>
<span class="w">   </span><span class="k">from</span><span class="w"> </span><span class="n">parcelle_init</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Création d’une table temporaire rapprochant les parcelles filles aux listes de parcelles mères (récursive)</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="w">         </span><span class="k">CREATE</span><span class="w"> </span><span class="n">UNLOGGED</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">temp_parcelle_filiation</span><span class="w"> </span><span class="k">as</span>

<span class="w">   </span><span class="k">with</span><span class="w"> </span><span class="k">recursive</span><span class="w"> </span><span class="n">search_meres</span><span class="w"> </span><span class="p">(</span><span class="n">code_com</span><span class="p">,</span><span class="w"> </span><span class="n">date_valid</span><span class="p">,</span><span class="w"> </span><span class="n">nature_dfi</span><span class="p">,</span><span class="w"> </span><span class="n">pref_section</span><span class="p">,</span><span class="w">  </span><span class="n">parcelles_meres</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">parcelles_filles</span><span class="p">,</span><span class="w"> </span><span class="n">parcelles_soeurs</span><span class="p">,</span><span class="w">  </span><span class="n">num_filiation</span><span class="p">,</span><span class="w"> </span><span class="n">id_filiation</span><span class="p">)</span><span class="w">  </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="c1">-- paramètres récursive</span>


<span class="w">   </span><span class="k">select</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="o">*</span><span class="w"> </span><span class="c1">--selection des filiations initiales au cadastre</span>
<span class="w">   </span><span class="k">from</span><span class="w"> </span><span class="n">temp_parcelles_init</span><span class="w"> </span><span class="n">a</span>

<span class="w">      </span><span class="k">UNION</span><span class="w"> </span><span class="c1">-- union pour la recursivité</span>

<span class="w">            </span><span class="k">select</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">code_com</span><span class="p">,</span><span class="k">c</span><span class="p">.</span><span class="n">date_valid</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">nature_dfi</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">pref_section</span><span class="p">,</span>
<span class="w">            </span><span class="k">c</span><span class="p">.</span><span class="n">parcelles_meres</span><span class="p">::</span><span class="nb">text</span><span class="p">[],</span><span class="w"> </span><span class="c1">-- Conservation des parcelles mères dfi dont les filles comprennent d&#39;autres parcelles filles dfi</span>
<span class="w">            </span><span class="nb">array</span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">unnest</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">parcelles_filles</span><span class="p">::</span><span class="nb">text</span><span class="p">[])</span>
<span class="w">            </span><span class="k">intersect</span>
<span class="w">            </span><span class="k">select</span><span class="w"> </span><span class="k">unnest</span><span class="p">(</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">parcelles_meres</span><span class="p">::</span><span class="nb">text</span><span class="p">[]))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">parcelles_filles</span><span class="w"> </span><span class="p">,</span><span class="c1">---- selectionner les parcelles filles dfi comprises dans les listes de parcelles mères initiales</span>

<span class="w">            </span><span class="nb">array</span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">unnest</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">parcelles_filles</span><span class="p">::</span><span class="nb">text</span><span class="p">[])</span>
<span class="w">            </span><span class="k">except</span>
<span class="w">            </span><span class="k">select</span><span class="w"> </span><span class="k">unnest</span><span class="p">(</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">parcelles_meres</span><span class="p">::</span><span class="nb">text</span><span class="p">[]))::</span><span class="nb">text</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">parcelles_soeurs</span><span class="p">,</span><span class="w"> </span><span class="c1">---- selectionner les parcelles filles dfi non comprises dans les listes de parcelles mères initiales pour trouver les parcelles soeurs</span>

<span class="w">            </span><span class="n">d</span><span class="p">.</span><span class="n">num_filiation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num_filiation</span><span class="p">,</span><span class="w"> </span><span class="c1">-- ajout de 1 au numéro de filiation</span>

<span class="w">            </span><span class="n">d</span><span class="p">.</span><span class="n">id_filiation</span><span class="w"> </span><span class="c1">--- conserver le numéro de parcelle cadastre initial en txt</span>

<span class="w">            </span><span class="k">from</span><span class="w"> </span><span class="n">temp_parcelles_dfi</span><span class="w"> </span><span class="k">c</span><span class="p">,</span><span class="w"> </span><span class="n">search_meres</span><span class="w"> </span><span class="n">d</span>
<span class="w">            </span><span class="k">where</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">parcelles_meres</span><span class="p">::</span><span class="nb">text</span><span class="p">[]</span><span class="w">  </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">parcelles_filles</span><span class="p">::</span><span class="nb">text</span><span class="p">[]</span><span class="w"> </span><span class="c1">-- jointure des parcelles dfi aux parcelles initiales quand au moins une parcelle de la liste parcelle mère initiale est comprise dans la liste parcelle fille dfi</span>
<span class="w">            </span><span class="k">AND</span><span class="w"> </span><span class="n">concat</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">code_com</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">pref_section</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">concat</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">code_com</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">pref_section</span><span class="p">)),</span><span class="w"> </span><span class="c1">-- et sur le code commune et prefixe de section</span>

<span class="k">result</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">row_number</span><span class="p">()</span><span class="w"> </span><span class="n">over</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">fid</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">search_meres</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="c1">--- selectionner le resultat de la recursive et ajouter un id unique</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>… Suite de la table : création du bloc déroulant HTML avec historique des filiations de parcelles dans un champ text avec num parcelle associé</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">row_number</span><span class="p">()</span><span class="w"> </span><span class="n">over</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="c1">--- creation du html</span>
<span class="w">   </span><span class="n">concat</span><span class="p">(</span><span class="c1">-- bloc html creant la table deroulante</span>
<span class="w">   </span><span class="s1">&#39;&lt;table class = &quot;t2&quot;&gt;</span>
<span class="s1">&lt;thead&gt;</span>
<span class="s1">   &lt;tr&gt;</span>
<span class="s1">      &lt;th&gt;date de filiation &lt;/th&gt;</span>
<span class="s1">      &lt;th&gt;nature de la filiation&lt;/th&gt;</span>
<span class="s1">   &lt;/tr&gt;</span>
<span class="s1">&lt;/thead&gt;</span>
<span class="s1">&lt;tbody&gt;&#39;</span><span class="p">,</span>


<span class="n">string_agg</span><span class="p">(</span><span class="c1">-- aggregation des infos  dfi filles, meres et soeurs : date, parcelles ordonnées par le numéro de filiation</span>
<span class="w">   </span><span class="p">(</span><span class="s1">&#39;&lt;tr&gt;</span>
<span class="s1">      &lt;td&gt;&lt;label for=&quot;row&#39;</span><span class="o">||</span><span class="n">fid</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&quot;&gt;&lt;/label&gt;&#39;</span><span class="w"> </span><span class="o">||</span><span class="w">  </span><span class="n">date_valid</span><span class="p">::</span><span class="nb">text</span><span class="p">::</span><span class="nb">date</span><span class="w"> </span><span class="o">||</span>
<span class="w">      </span><span class="s1">&#39;&lt;/td&gt;</span>
<span class="s1">      &lt;td&gt;&#39;</span><span class="o">||</span><span class="w"> </span><span class="n">nature_dfi</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&lt;/td&gt;</span>
<span class="s1">   &lt;/tr&gt;&lt;tr&gt;</span>
<span class="s1">      &lt;td colspan=&quot;6&quot;&gt;</span>
<span class="s1">      &lt;input id=&quot;row&#39;</span><span class="o">||</span><span class="n">fid</span><span class="o">||</span><span class="s1">&#39;&quot; type=&quot;checkbox&quot;&gt;</span>
<span class="s1">      &lt;table&gt;</span>
<span class="s1">         &lt;tr&gt;</span>
<span class="s1">            &lt;th&gt;Nouvelle(s) parcelle(s)&lt;/th&gt;</span>
<span class="s1">            &lt;th&gt;Parcelle(s) soeur(s)&lt;/th&gt;</span>
<span class="s1">            &lt;td&gt;Ancienne(s) parcelle(s)&lt;/td&gt;</span>
<span class="s1">      &lt;/tr&gt;</span>
<span class="s1">         &lt;tr&gt;</span>
<span class="s1">            &lt;th&gt;&#39;</span><span class="o">||</span><span class="k">translate</span><span class="p">(</span><span class="n">parcelles_filles</span><span class="p">::</span><span class="nb">text</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;{}&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">||</span><span class="s1">&#39;&lt;/th&gt;</span>
<span class="s1">            &lt;th&gt;&#39;</span><span class="o">||</span><span class="k">translate</span><span class="p">(</span><span class="n">parcelles_soeurs</span><span class="p">::</span><span class="nb">text</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;{}&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">||</span><span class="s1">&#39;&lt;/th&gt;</span>
<span class="s1">            &lt;td&gt;&#39;</span><span class="o">||</span><span class="k">translate</span><span class="p">(</span><span class="n">parcelles_meres</span><span class="p">::</span><span class="nb">text</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;{}&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">||</span><span class="s1">&#39;&lt;/td&gt;</span>
<span class="s1">         &lt;/tr&gt;</span>
<span class="s1">      &lt;/table&gt;&#39;</span>
<span class="w">      </span><span class="p">)</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&lt;/td&gt;</span>
<span class="s1">   &lt;/tr&gt;&#39;</span>
<span class="w">      </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">num_filiation</span><span class="w"> </span><span class="k">asc</span><span class="p">),</span><span class="s1">&#39;&lt;/tbody&gt;</span>
<span class="s1">&lt;/table&gt;&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">tab_filiation</span><span class="p">,</span><span class="w"> </span><span class="n">concat</span><span class="p">(</span><span class="s1">&#39;140&#39;</span><span class="p">,</span><span class="n">code_com</span><span class="p">,</span><span class="w"> </span><span class="n">pref_section</span><span class="p">,</span><span class="w"> </span><span class="n">id_filiation</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num_parcelle</span><span class="w"> </span><span class="c1">-- creation du num parcelle : cod dep + codcom + pref_section + num_parcelle cadastre initial</span>
<span class="w">   </span><span class="k">from</span><span class="w"> </span><span class="k">result</span><span class="w"> </span><span class="n">a</span>
<span class="w">   </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">code_com</span><span class="p">,</span><span class="w"> </span><span class="n">pref_section</span><span class="p">,</span><span class="w"> </span><span class="n">id_filiation</span><span class="p">;</span><span class="w"> </span><span class="c1">-- grouper par parcelle, pref section et num parcelle cadastre initial</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Mise à jour des champs  HTML de la table parcelle_info grâce aux identifiants parcelles de la table précédement créée.</p></li>
</ul>
</div>
<div class="section" id="parametrage-qgis-plugin-lizmap">
<h4>2.2 - Paramètrage Qgis/plugin Lizmap<a class="headerlink" href="#parametrage-qgis-plugin-lizmap" title="Permalink to this heading"></a></h4>
<ul class="simple">
<li><p>Mise à jour de l’info bulle HTML dans les propriété de la couche QGIS</p></li>
</ul>
<a class="reference internal image-reference" href="_images/18_info_bulle_html.png"><img alt="_images/18_info_bulle_html.png" src="_images/18_info_bulle_html.png" style="width: 957.0px; height: 511.0px;" /></a>
<p>Le code HTML (Onglet Filiations + partie tab_filiation) se trouve <a class="reference external" href="https://github.com/sig14/sig14.github.io/blob/master/cadastre/html/popup_cadastre.html">Par ici</a></p>
</div>
<div class="section" id="rendu-lizmap">
<h4>2.3 - Rendu lizmap<a class="headerlink" href="#rendu-lizmap" title="Permalink to this heading"></a></h4>
<ul class="simple">
<li><p>Mise à jour du CSS dans le panneau de configuration Lizmap</p></li>
</ul>
<p>Le code CSS se trouve <a class="reference external" href="https://github.com/sig14/sig14.github.io/blob/master/cadastre/css/dfi_cadastre">ici</a></p>
<a class="reference internal image-reference" href="_images/19_config_css.png"><img alt="_images/19_config_css.png" src="_images/19_config_css.png" style="width: 891.0px; height: 407.0px;" /></a>
</div>
</div>
</div>
<span id="document-cadastre/IV_mutation_immo"></span><div class="section" id="iv-ajouter-un-onglet-mutations-immobilieres-a-la-pop-up-cadastre-de-lizmap">
<h2>IV- Ajouter un onglet “Mutations immobilières” à la pop-up cadastre de Lizmap<a class="headerlink" href="#iv-ajouter-un-onglet-mutations-immobilieres-a-la-pop-up-cadastre-de-lizmap" title="Permalink to this heading"></a></h2>
<a class="reference internal image-reference" href="_images/schema_dvf_cadastre.png"><img alt="_images/schema_dvf_cadastre.png" src="_images/schema_dvf_cadastre.png" style="width: 1121.0px; height: 595.0px;" /></a>
<p>Le jeu de données « Demandes de valeurs foncières », publié et produit par la direction générale des finances publiques, permet de connaître les transactions immobilières intervenues au cours des cinq dernières années. Les données contenues sont issues des actes notariés et des informations cadastrales.</p>
<p>Il est disponible sur le site <a class="reference external" href="https://www.data.gouv.fr/fr/datasets/5c4ae55a634f4117716d5656/">datagouv.fr</a></p>
<p>Les fichiers correspondant chacun à un millésime sont mis à disposition au format.txt. sur cinq ans.</p>
<p>Les fichiers mis à disposition font l’objet d’une mise à jour <strong>semestrielle, en avril et en octobre</strong>.</p>
<p>A partir de ce fichier, le pôle SIG du Département du Calvados, propose de consulter l’historique des mutations immobilières et leurs valeures foncières à l’échelle d’une parcelle.</p>
<a class="reference internal image-reference" href="_images/mutation_immo.gif"><img alt="_images/mutation_immo.gif" src="_images/mutation_immo.gif" style="width: 902.0px; height: 458.0px;" /></a>
<div class="section" id="champ-html-historique-deroulant">
<h3>1- Champ HTML historique déroulant<a class="headerlink" href="#champ-html-historique-deroulant" title="Permalink to this heading"></a></h3>
<p>L’objectif est ici de pouvoir consulter l’historique des mutations immobilières et les valeurs foncières à l’échelle de la parcelle.</p>
<p>L’utilisateur peut en cliquant sur une parcelle, consulter les différentes mutations immobilières opérées sur la parcelle ces 5 dernières années.</p>
<p>Pour cela on utilise une fonction postgresql/gis pour alimenter la table parcelle_info du cadastre et une mise en forme du formulaire QGIS en HTML pour publication sur le portail cartographique Lizmap.</p>
<div class="section" id="fonction-postgresql-gis">
<h4>1.1 - Fonction postgresql/gis<a class="headerlink" href="#fonction-postgresql-gis" title="Permalink to this heading"></a></h4>
<ul>
<li><p>On créé le champ contenant l’html des déroulants détaillant les filiations du plus récent au plus ancien</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">cadastre</span><span class="p">.</span><span class="n">parcelle_info</span>
<span class="k">ADD</span><span class="w"> </span><span class="k">column</span><span class="w"> </span><span class="n">deroulant_dvf</span><span class="w"> </span><span class="nb">varchar</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<p>On lance ensuite une fonction postgresql/gis dont le code SQL se trouve <a class="reference external" href="https://github.com/sig14/sig14.github.io/blob/master/cadastre/sql/fonction_dvf_cadastre.sql">à cet endroit</a></p>
<ul>
<li><p>Dans un premier temps, on sélectionne des valeurs de champs distincts pour éviter les doublons</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w">  </span><span class="k">distinct</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="n">a</span><span class="p">.</span><span class="n">code_ch</span><span class="p">,</span>
<span class="w">            </span><span class="n">a</span><span class="p">.</span><span class="n">ref_doct</span><span class="p">,</span>
<span class="w">            </span><span class="n">a</span><span class="p">.</span><span class="n">no_disposition</span><span class="p">,...</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>On joint les natures de cultures et cultures spéciales (créer une table à partir de la notice descriptive disponible sur le site <a class="reference external" href="https://www.data.gouv.fr/fr/datasets/5c4ae55a634f4117716d5656/">datagouv.fr</a> ), ainsi que les numéros de parcelles du cadastre.</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">row_number</span><span class="p">()</span><span class="w"> </span><span class="n">over</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="c1">-- creation d&#39;un id unique</span>
<span class="w">     </span><span class="n">b</span><span class="p">.</span><span class="n">geo_parcelle</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">date_mutation</span><span class="p">,</span><span class="w"> </span><span class="n">nature_mutation</span><span class="p">,</span><span class="w"> </span><span class="n">valeur_fonciere</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">concat</span><span class="p">(</span><span class="n">no_voie</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">type_de_voie</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">voie</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">code_postal</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">adresse</span><span class="w"> </span><span class="p">,</span>
<span class="w">     </span><span class="n">type_local</span><span class="p">,</span><span class="w"> </span><span class="n">nb_piece_princ</span><span class="p">,</span><span class="w">  </span><span class="n">surf_reelle_bati</span><span class="p">,</span><span class="w"> </span><span class="n">surf_terrain</span><span class="p">,</span>
<span class="w">        </span><span class="k">c</span><span class="p">.</span><span class="n">libelle</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">nature_culture</span><span class="p">,</span><span class="w"> </span><span class="c1">-- ajout de la nature culture</span>
<span class="w">        </span><span class="n">d</span><span class="p">.</span><span class="n">libelle</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">nature_culture_speciale</span><span class="w"> </span><span class="c1">-- ajout de la nature culture spéciale</span>
<span class="w">  </span><span class="k">from</span><span class="w"> </span><span class="n">cadastre</span><span class="p">.</span><span class="n">parcelle_info</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="c1">--- jointure de la tbale parcelle_info</span>
<span class="w">  </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w">  </span><span class="n">ref_foncier</span><span class="p">.</span><span class="n">valeurs_foncieres</span><span class="w"> </span><span class="n">a</span>
<span class="w">  </span><span class="k">on</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">geo_parcelle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">concat</span><span class="p">(</span><span class="n">concat</span><span class="p">(</span><span class="n">code_dep</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="k">length</span><span class="p">(</span><span class="n">code_com</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="n">concat</span><span class="p">(</span><span class="s1">&#39;00&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">code_com</span><span class="p">)</span>
<span class="w">  </span><span class="k">when</span><span class="w"> </span><span class="k">length</span><span class="p">(</span><span class="n">code_com</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="n">concat</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">code_com</span><span class="p">)</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="n">code_com</span><span class="w"> </span><span class="k">end</span><span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">pref_section</span><span class="p">,</span>
<span class="k">case</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="k">length</span><span class="p">(</span><span class="n">section</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="n">concat</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">section</span><span class="p">)</span>
<span class="w">   </span><span class="k">else</span><span class="w">  </span><span class="n">section</span><span class="w"> </span><span class="k">end</span><span class="p">,</span><span class="w"> </span><span class="n">no_plan</span><span class="p">)</span>
<span class="w">  </span><span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">ref_foncier</span><span class="p">.</span><span class="n">valeurs_foncieres_cultures</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">nature_culture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">code</span>
<span class="w">  </span><span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">ref_foncier</span><span class="p">.</span><span class="n">valeurs_foncieres_cultures_speciales</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">nature_culture_speciale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">code</span><span class="p">)</span>

<span class="w">  </span><span class="n">pars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">geo_parcelle</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">date_mutation</span><span class="p">,</span><span class="w"> </span><span class="n">valeur_fonciere</span><span class="p">,</span><span class="w"> </span><span class="n">nature_mutation</span><span class="p">,</span><span class="w"> </span><span class="n">adresse</span><span class="p">,</span><span class="n">surf_terrain</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">type_local</span><span class="p">,</span><span class="n">a</span><span class="p">.</span><span class="n">nb_piece_princ</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">surf_reelle_bati</span><span class="p">,</span><span class="w">   </span><span class="n">a</span><span class="p">.</span><span class="n">nature_culture</span><span class="p">,</span><span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">nature_culture_speciale</span>
<span class="w">      </span><span class="k">from</span><span class="w">    </span><span class="n">parcelles_dvf</span><span class="w"> </span><span class="n">a</span>
<span class="w">      </span><span class="k">group</span><span class="w"> </span><span class="k">by</span>
<span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">geo_parcelle</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">date_mutation</span><span class="p">,</span><span class="w"> </span><span class="n">valeur_fonciere</span><span class="p">,</span><span class="w"> </span><span class="n">nature_mutation</span><span class="p">,</span><span class="w"> </span><span class="n">adresse</span><span class="p">,</span><span class="n">surf_terrain</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">type_local</span><span class="p">,</span><span class="n">a</span><span class="p">.</span><span class="n">nb_piece_princ</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">surf_reelle_bati</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">nature_culture</span><span class="p">,</span><span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">nature_culture_speciale</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">surf_terrain</span>

<span class="w">  </span><span class="p">),</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Création du champ html : bloc html + info mutation, décomposition type local + nature culture</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="w">     </span><span class="n">group_parcelle</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="c1">--- creation du champ html : bloc html + info mutation, decomposition type local + nature culture</span>
<span class="w">         </span><span class="k">select</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">geo_parcelle</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">date_mutation</span><span class="p">,</span>

<span class="w">         </span><span class="n">concat</span><span class="p">(</span><span class="s1">&#39;&lt;br&gt;&lt;details class=&quot;accordion_valeur_fonc&quot;&gt;&lt;summary&gt;&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">nature_mutation</span><span class="p">,</span><span class="s1">&#39; / &#39;</span><span class="p">,</span><span class="w"> </span><span class="k">coalesce</span><span class="p">(</span><span class="n">valeur_fonciere</span><span class="p">,</span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;xx&#39;</span><span class="p">),</span><span class="s1">&#39; euros &lt;br&gt;&#39;</span><span class="p">,</span>
<span class="w">         </span><span class="n">date_mutation</span><span class="p">,</span><span class="s1">&#39;&lt;br&gt;&#39;</span><span class="p">,</span><span class="k">coalesce</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">adresse</span><span class="p">,</span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;&lt;/summary&gt;&#39;</span><span class="p">,</span>
<span class="w">         </span><span class="n">string_agg</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;&lt;br&gt; &#39;</span><span class="o">||</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">type_local</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Maison&#39;</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;&lt;img class=&quot;fit-picture&quot; src=&quot;https://raw.githubusercontent.com/sig14/sig14.github.io/main/img/house.png&quot; width=&quot;20&quot;&#39;</span>
<span class="w">                           </span><span class="k">when</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">type_local</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Appartement&#39;</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;&lt;img class=&quot;fit-picture&quot; src=&quot;https://raw.githubusercontent.com/sig14/sig14.github.io/main/img/apartment-xxl.png&quot; width=&quot;20&quot;&#39;</span>
<span class="w">                           </span><span class="k">when</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">type_local</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Local industriel. commercial ou assimilé&#39;</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;&lt;img class=&quot;fit-picture&quot; src=&quot;https://raw.githubusercontent.com/sig14/sig14.github.io/main/img/shop.png&quot; width=&quot;20&quot;&#39;</span>
<span class="w">                           </span><span class="k">when</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">type_local</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Dépendance&#39;</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;&lt;img class=&quot;fit-picture&quot; src=&quot;https://raw.githubusercontent.com/sig14/sig14.github.io/main/img/dependance.png&quot; width=&quot;20&quot;&#39;</span>
<span class="w">                           </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&lt;/img&gt;     &#39;</span><span class="o">||</span><span class="c1">-- decompostion du type de local : ajout d&#39;un lien vers image github associé selon le type</span>

<span class="w">           </span><span class="n">concat</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">type_local</span><span class="p">,</span><span class="s1">&#39; &lt;br&gt;     &#39;</span><span class="p">)</span>
<span class="w">           </span><span class="o">||</span><span class="k">case</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">nb_piece_princ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">nb_piece_princ</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">null</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="n">concat</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">nb_piece_princ</span><span class="p">::</span><span class="nb">text</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; pièces&lt;br&gt;     &#39;</span><span class="p">)</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="o">||</span>
<span class="w">           </span><span class="k">case</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">surf_reelle_bati</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">surf_reelle_bati</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">null</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">concat</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">surf_reelle_bati</span><span class="p">::</span><span class="nb">text</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;m²&lt;br&gt;&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">end</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">date_mutation</span><span class="p">::</span><span class="nb">date</span><span class="w"> </span><span class="k">DESC</span>
<span class="w">           </span><span class="p">))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">html_general</span><span class="p">,</span>


<span class="w">       </span><span class="n">concat</span><span class="p">(</span>
<span class="w">           </span><span class="c1">--- ajout de la nature terrain si present : surface terrain avec image terrain associé , null si pas de valeur de surface</span>
<span class="w">      </span><span class="k">nullif</span><span class="p">(</span><span class="n">concat</span><span class="p">(</span><span class="w"> </span><span class="s1">&#39;&lt;br&gt;&lt;br&gt;&lt;img class=&quot;fit-picture&quot; src=&quot;https://raw.githubusercontent.com/sig14/sig14.github.io/main/img/grass.png&quot; width=&quot;20&quot; &lt;/img&gt; Terrain&lt;br&gt;&#39;</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">surf_terrain</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; m² &lt;br&gt;&#39;</span><span class="p">),</span>
<span class="w">   </span><span class="s1">&#39;&lt;br&gt;&lt;br&gt;&lt;img class=&quot;fit-picture&quot; src=&quot;https://raw.githubusercontent.com/sig14/sig14.github.io/main/img/grass.png&quot; width=&quot;20&quot; &lt;/img&gt; Terrain&lt;br&gt; m² &lt;br&gt;&#39;</span><span class="p">),</span>

<span class="w">    </span><span class="k">nullif</span><span class="p">(</span><span class="k">translate</span><span class="p">(</span><span class="n">array_agg</span><span class="p">(</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">nature_culture</span><span class="p">::</span><span class="nb">text</span><span class="w"> </span><span class="p">)::</span><span class="nb">text</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;{}&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;NULL&#39;</span><span class="p">),</span><span class="s1">&#39;&lt;br&gt;&#39;</span><span class="w"> </span><span class="c1">--- aggregation des natures de cultures, null si pas de valeur</span>
<span class="w">   </span><span class="p">,</span><span class="w"> </span><span class="k">nullif</span><span class="p">(</span><span class="k">replace</span><span class="p">(</span><span class="k">translate</span><span class="p">(</span><span class="n">array_agg</span><span class="p">(</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">nature_culture_speciale</span><span class="p">::</span><span class="nb">text</span><span class="p">)::</span><span class="nb">text</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;{}&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;NULL&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w">  </span><span class="c1">--- aggregation des natures de cultures    spéciales, null si pas de valeur</span>
<span class="w">      </span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">html_terrain</span>
<span class="w">   </span><span class="k">from</span><span class="w"> </span><span class="n">pars</span><span class="w"> </span><span class="n">a</span>
<span class="w">   </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">geo_parcelle</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">date_mutation</span><span class="p">,</span><span class="w"> </span><span class="n">valeur_fonciere</span><span class="p">,</span><span class="w"> </span><span class="n">nature_mutation</span><span class="p">,</span><span class="w"> </span><span class="n">adresse</span><span class="p">,</span><span class="n">surf_terrain</span>
<span class="w">      </span><span class="p">),</span>

<span class="n">concatenation</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">geo_parcelle</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">date_mutation</span><span class="p">,</span><span class="w"> </span><span class="n">concat</span><span class="p">(</span><span class="n">html_general</span><span class="p">,</span><span class="w"> </span><span class="n">string_agg</span><span class="p">((</span><span class="n">html_terrain</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;&lt;/details&gt;&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">deroulant_dvf</span>
<span class="k">from</span><span class="w"> </span><span class="n">group_parcelle</span><span class="w"> </span><span class="n">a</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">geo_parcelle</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">date_mutation</span><span class="p">,</span><span class="w"> </span><span class="n">html_general</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Agréger les déroulants par parcelle et les ordonner par date de mutation</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">geo_parcelle</span><span class="p">,</span><span class="w"> </span><span class="n">string_agg</span><span class="p">((</span><span class="n">deroulant_dvf</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">date_mutation</span><span class="p">::</span><span class="nb">date</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">deroulant_dvf</span>
<span class="k">from</span><span class="w"> </span><span class="n">concatenation</span><span class="w"> </span><span class="n">a</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">geo_parcelle</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>indexation de la table, vider et updater le champ déroulant html de cadastre.parcelle_info au niveau du numéro de parcelle</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">index_temp_dvf</span><span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="n">temp_dvf</span><span class="w">  </span><span class="k">USING</span><span class="w"> </span><span class="n">btree</span><span class="w"> </span><span class="p">(</span><span class="n">geo_parcelle</span><span class="p">);</span>

<span class="k">update</span><span class="w"> </span><span class="n">cadastre</span><span class="p">.</span><span class="n">parcelle_info</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">deroulant_dvf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">null</span><span class="p">;</span>

<span class="k">update</span><span class="w"> </span><span class="n">cadastre</span><span class="p">.</span><span class="n">parcelle_info</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">deroulant_dvf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">deroulant_dvf</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">temp_dvf</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">geo_parcelle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parcelle_info</span><span class="p">.</span><span class="n">geo_parcelle</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="parametrage-qgis-plugin-lizmap">
<h4>2.2 - Paramètrage Qgis/plugin Lizmap<a class="headerlink" href="#parametrage-qgis-plugin-lizmap" title="Permalink to this heading"></a></h4>
<ul class="simple">
<li><p>Mise à jour de l’info bulle HTML dans les propriétés de la couche QGIS</p></li>
</ul>
<a class="reference internal image-reference" href="_images/18_info_bulle_html.png"><img alt="_images/18_info_bulle_html.png" src="_images/18_info_bulle_html.png" style="width: 957.0px; height: 511.0px;" /></a>
<p>Le code HTML (onglet mutation immobilière + partie deroulant_dvf) se trouve <a class="reference external" href="https://github.com/sig14/sig14.github.io/blob/master/cadastre/html/popup_cadastre.html">par ici</a></p>
</div>
<div class="section" id="rendu-lizmap">
<h4>1.3 - Rendu lizmap<a class="headerlink" href="#rendu-lizmap" title="Permalink to this heading"></a></h4>
<ul class="simple">
<li><p>Mise à jour du CSS dans le panneau de configuration Lizmap</p></li>
</ul>
<p>Le code CSS se <a class="reference external" href="https://github.com/sig14/sig14.github.io/blob/master/cadastre/css/dvf_cadastre.css">trouve ici</a></p>
<a class="reference internal image-reference" href="_images/19_config_css.png"><img alt="_images/19_config_css.png" src="_images/19_config_css.png" style="width: 891.0px; height: 407.0px;" /></a>
</div>
</div>
</div>
</div>
<div class="toctree-wrapper compound">
<span id="document-deci/I_perimetres_pei"></span><div class="section" id="i-perimetres-des-bornes-incendies">
<h2>I- Périmètres des bornes incendies<a class="headerlink" href="#i-perimetres-des-bornes-incendies" title="Permalink to this heading"></a></h2>
<a class="reference internal image-reference" href="_images/Intro.png"><img alt="_images/Intro.png" src="_images/Intro.png" style="width: 880px;" /></a>
<p>Dans le cadre du partenariat entre le CD14 et les Services Départementaux d’Incendie et de Secours (SDIS), une application a été développée à destination des communes et partenaires afin de répertorier les points d’eau incendie (<strong>PEI</strong>) du Département.</p>
<p>La mise à disposition de ces sources d’eau relève de la responsabilité du maire.</p>
<p>Ainsi, où que les pompiers interviennent en zone habitée, ils devraient disposer d’un accès à l’eau à moins de <strong>200 mètres</strong> et d’une distance maximale de <strong>400 mètres</strong> entre les points d’eau incendie.</p>
<p>Ainsi, une réfléxion a été menée pour calculer automatiquement ces 2 périmètres le long des routes à chaque création de borne incendie.</p>
<p>L’approche developpée consiste donc à éxploiter la localisation des <strong>PEI</strong>, créer des linéaires d’isodistances et les périmètres de <strong>200</strong> et <strong>400</strong> mètres via la route.</p>
<a class="reference internal image-reference" href="_images/schema_part_I.png"><img alt="_images/schema_part_I.png" src="_images/schema_part_I.png" style="width: 580px;" /></a>
<div class="section" id="referentiels-de-donnees">
<h3>1- Référentiels de données<a class="headerlink" href="#referentiels-de-donnees" title="Permalink to this heading"></a></h3>
<div class="section" id="bd-topo-troncons-de-routes">
<h4>1.1 BD Topo tronçons de routes<a class="headerlink" href="#bd-topo-troncons-de-routes" title="Permalink to this heading"></a></h4>
<p><strong>Caractéristiques</strong> :
*       Source : IGN
*       Réseau routier
*       Format : vecteurs Multilinestring</p>
</div>
<div class="section" id="points-eau-incendie-deci">
<h4>1.2 Points Eau incendie DECI<a class="headerlink" href="#points-eau-incendie-deci" title="Permalink to this heading"></a></h4>
<p><strong>Caractéristiques</strong> :
-       Source : SDIS
-       Poteaux ou bouches d’incendie, raccordés au réseau d’eau potable
-       Format : vecteur point</p>
</div>
</div>
<div class="section" id="creation-du-lineaire-routier-de-reference">
<h3>2- Création du linéaire routier de référence<a class="headerlink" href="#creation-du-lineaire-routier-de-reference" title="Permalink to this heading"></a></h3>
<p>La première étape consiste à créer une table miroir de données routes, en y indéxant les points de départ et d’arrivée de chaque tronçon.</p>
<p>Le bornage de ces tronçons permettra par la suite de fixer le parcours de réseau et de mesurer les distances parcourues.</p>
<p>Le code sql de la fonction se trouve ici : <a class="reference external" href="https://github.com/sig14/sig14.github.io/blob/master/deci/sql/fonction_network_deci.sql">Fonction référentiel bornage routes DECI</a></p>
<div class="section" id="isoler-les-segments-de-route">
<h4>2.1 Isoler les segments de route<a class="headerlink" href="#isoler-les-segments-de-route" title="Permalink to this heading"></a></h4>
<p>Dumper la géométrie des routes pour obtenir les segments de routes.</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">sdis</span><span class="p">.</span><span class="n">route_deci_segments</span><span class="w"> </span><span class="k">as</span>
<span class="k">select</span>
<span class="n">row_number</span><span class="p">()</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">id</span><span class="p">,</span>
<span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">oid</span><span class="p">,</span>
<span class="n">dump</span><span class="p">.</span><span class="n">geom</span>
<span class="k">from</span>
<span class="n">sdis</span><span class="p">.</span><span class="ss">&quot;2d_deci_bdtopo&quot;</span><span class="w"> </span><span class="n">a</span><span class="p">,</span>
<span class="n">st_dump</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">dump</span>

<span class="w"> </span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="indexer-les-startpoints-des-segments">
<h4>2.2 Indexer les startpoints des segments<a class="headerlink" href="#indexer-les-startpoints-des-segments" title="Permalink to this heading"></a></h4>
<ul>
<li><p>On boucle sur les géométries de segments pour alimenter un champs n1.</p></li>
<li><p>On débute par la valeur 1 et on ajoute 1 à chaque nouvelle géometrie de startpoint dans une liste (indexe).</p></li>
<li><p>On garde également en mémoire la géométrie dans une liste (points).</p></li>
<li><p>A chaque création d’entité, on vérifie la position du startpoint dans la liste (points).
Si aucune position dans la liste on ajoute une valeur n1 (n+n1).
Sinon, on donne la valeur de n de la liste (indexe) selon la position du startpoint dans la liste (points) au champs n1.</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="w">         </span><span class="k">for</span><span class="w"> </span><span class="n">rec</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">sdis</span><span class="p">.</span><span class="n">route_deci_segments</span><span class="w"> </span><span class="n">loop</span>
<span class="c1">-- Première extrémité</span>
<span class="w">         </span><span class="n">pt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">st_startpoint</span><span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">geom</span><span class="p">);</span>
<span class="c1">-- On cherche si ce point a déjà un numéro de noeud</span>
<span class="w">         </span><span class="n">pos</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">array_position</span><span class="p">(</span><span class="n">points</span><span class="p">,</span><span class="w"> </span><span class="n">pt</span><span class="p">);</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="c1">-- le point n&#39;est pas encore indexé</span>
<span class="c1">-- on crée un numéro et on l&#39;insère</span>
<span class="w">               </span><span class="k">update</span><span class="w"> </span><span class="n">sdis</span><span class="p">.</span><span class="n">route_deci_segments</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">n1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rec</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
<span class="w">               </span><span class="n">points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array_append</span><span class="p">(</span><span class="n">points</span><span class="p">,</span><span class="w"> </span><span class="n">pt</span><span class="p">);</span>
<span class="w">               </span><span class="n">indexe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array_append</span><span class="p">(</span><span class="n">indexe</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
<span class="w">               </span><span class="n">n</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">          </span><span class="k">else</span>
<span class="w"> </span><span class="c1">-- on prend le numéro existant</span>
<span class="w">               </span><span class="n">pos</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">array_position</span><span class="p">(</span><span class="n">points</span><span class="p">,</span><span class="w"> </span><span class="n">pt</span><span class="p">);</span>
<span class="w">               </span><span class="k">update</span><span class="w"> </span><span class="n">sdis</span><span class="p">.</span><span class="n">route_deci_segments</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">n1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">indexe</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rec</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<a class="reference internal image-reference" href="_images/1_start_point.png"><img alt="_images/1_start_point.png" src="_images/1_start_point.png" style="width: 480px;" /></a>
</div>
<div class="section" id="indexer-les-endpoints-des-segments">
<h4>2.3 Indexer les endpoints des segments<a class="headerlink" href="#indexer-les-endpoints-des-segments" title="Permalink to this heading"></a></h4>
<ul>
<li><p>On applique la même méthode sur les endpoints</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">-- Seconde extrémité</span>
<span class="w">        </span><span class="n">pt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">st_endpoint</span><span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">geom</span><span class="p">);</span>
<span class="w">        </span><span class="n">pos</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">array_position</span><span class="p">(</span><span class="n">points</span><span class="p">,</span><span class="w"> </span><span class="n">pt</span><span class="p">);</span>
<span class="w">  </span><span class="c1">-- On cherche si ce point a déjà un numéro de noeud</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="c1">-- le point n&#39;est pas encore indexé</span>
<span class="w">       </span><span class="c1">-- on crée un numéro et on l&#39;insère</span>
<span class="w">                </span><span class="k">update</span><span class="w"> </span><span class="n">sdis</span><span class="p">.</span><span class="n">route_deci_segments</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">n2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rec</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
<span class="w">                </span><span class="n">points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array_append</span><span class="p">(</span><span class="n">points</span><span class="p">,</span><span class="w"> </span><span class="n">pt</span><span class="p">);</span>
<span class="w">                </span><span class="n">indexe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array_append</span><span class="p">(</span><span class="n">indexe</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
<span class="w">                </span><span class="n">n</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">       </span><span class="c1">-- on prend le numéro existant</span>
<span class="w">                </span><span class="n">pos</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">array_position</span><span class="p">(</span><span class="n">points</span><span class="p">,</span><span class="w"> </span><span class="n">pt</span><span class="p">);</span>
<span class="w">                </span><span class="k">update</span><span class="w"> </span><span class="n">sdis</span><span class="p">.</span><span class="n">route_deci_segments</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">n2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">indexe</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rec</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="p">;</span>
<span class="k">end</span><span class="w"> </span><span class="n">loop</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<a class="reference internal image-reference" href="_images/2_end_point.png"><img alt="_images/2_end_point.png" src="_images/2_end_point.png" style="width: 480px;" /></a>
</div>
</div>
<div class="section" id="automatisation-de-la-creation-des-perimetres">
<h3>3- Automatisation de la création des pèrimètres<a class="headerlink" href="#automatisation-de-la-creation-des-perimetres" title="Permalink to this heading"></a></h3>
<p>La seconde étape consiste à la mise en place d’une fonction déclenchée par un trigger, pour calcul automatique des périmètres 200 et 400 mètres
à partir de la projection sur le référentiel routier du PEI nouvellement créé.</p>
<p>Le code sql de la fonction se trouve ici : <a class="reference external" href="https://github.com/sig14/sig14.github.io/blob/master/deci/sql/trigger_perimetre_bornes_incendie.sql">Fonction calcul automatique perimètre PEI</a></p>
<div class="section" id="restreindre-la-zone-de-calcul">
<h4>3.1 Restreindre la zone de calcul<a class="headerlink" href="#restreindre-la-zone-de-calcul" title="Permalink to this heading"></a></h4>
<p>Afin d’optimiser le temps de calcul, on sélectionne uniquement les routes à 500 mètres du PEI créé.</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="n">UNLOGGED</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">route_deci</span><span class="w"> </span><span class="c1">--- création d&#39;une table temporaire qui sélectionne les segments_deci dans un buffer de 500 mètre autour du nouveau point créé</span>
<span class="k">as</span>
<span class="w">   </span><span class="k">select</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="o">*</span>
<span class="w">   </span><span class="k">from</span><span class="w"> </span><span class="n">sdis</span><span class="p">.</span><span class="n">route_deci_segments</span><span class="w"> </span><span class="n">r</span>
<span class="w">   </span><span class="k">where</span><span class="w"> </span><span class="n">st_intersects</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">st_buffer</span><span class="p">(</span><span class="k">NEW</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="mi">500</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;quad_segs=8&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">;</span>

<span class="k">CREATE</span><span class="w">  </span><span class="k">INDEX</span><span class="w"> </span><span class="n">route_deci_idx</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">route_deci</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">);</span><span class="c1">---création d&#39;un indexe sur l&#39;id de la table</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="recursive-parcourir-le-lineaire-a-400-metres">
<h4>3.2 Récursive : parcourir le linéaire à 400 mètres<a class="headerlink" href="#recursive-parcourir-le-lineaire-a-400-metres" title="Permalink to this heading"></a></h4>
<p>Nous utilserons ici l’expression récursive de postgresql.</p>
<ul>
<li><p>On localise d’abords le segment le plus proche à moins de 40 mètres du nouveau PEI créé.</p></li>
<li><p>On identifie la fraction du segment au niveau du point projeté (ST_LineLocatePoint)</p></li>
<li><p>On calcul la longueur de la fraction du segment (longeur segment X fraction)</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">st_length</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ST_LineLocatePoint</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">st_closestpoint</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">geom</span><span class="p">))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">longueur_depart</span><span class="p">,</span><span class="w"> </span><span class="c1">---fraction de la longeur du segment de départ au niveau du point projeté sur le segment le plus proche</span>
<span class="n">ST_LineLocatePoint</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">st_closestpoint</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">geom</span><span class="p">))</span><span class="w">  </span><span class="k">as</span><span class="w"> </span><span class="n">fraction</span><span class="w"> </span><span class="c1">--- fraction du segment de départ au niveau du point projeté sur le segment le plus proche</span>
<span class="k">from</span><span class="w"> </span><span class="n">route_deci</span><span class="w"> </span><span class="n">r</span>
<span class="k">where</span><span class="w"> </span><span class="n">st_intersects</span><span class="p">(</span><span class="n">st_buffer</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">),</span><span class="k">NEW</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="c1">-- segment de départ à 40 mètre du point créé</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">st_distance</span><span class="w"> </span><span class="p">(</span><span class="k">NEW</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">1</span><span class="c1">-- On garde seulement un segment (le plus proche)</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<a class="reference internal image-reference" href="_images/3_calcul_dist.png"><img alt="_images/3_calcul_dist.png" src="_images/3_calcul_dist.png" style="width: 480px;" /></a>
<ul>
<li><p>On crée ensuite les géométries correspondantes aux deux fractions du segment</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">n1_distance</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">   </span><span class="c1">-- on récupère pour le premier segement, juste une fraction (car la borne n&#39;est pas située</span>
<span class="w">   </span><span class="c1">-- pile à une extrémité</span>
<span class="w">                  </span><span class="k">select</span><span class="w"> </span><span class="n">longueur_depart</span><span class="w">  </span><span class="k">as</span><span class="w"> </span><span class="n">dist_n1</span><span class="p">,</span><span class="w"> </span><span class="n">st_linesubstring</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">fraction</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">n1_geom</span><span class="w"> </span><span class="c1">-- ici on stocke la fraction de geom à parcourir</span>
<span class="w">                  </span><span class="k">from</span><span class="w"> </span><span class="n">premier_troncon</span><span class="w"> </span><span class="n">p</span>
<span class="w">                         </span><span class="p">),</span>
<span class="w">          </span><span class="n">n2_distance</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">   </span><span class="c1">-- idem pour le deuxième noeud</span>
<span class="w">                  </span><span class="k">select</span><span class="w"> </span><span class="n">st_length</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">longueur_depart</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">dist_n2</span><span class="p">,</span><span class="w"> </span><span class="n">st_linesubstring</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">fraction</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">n2_geom</span><span class="w"> </span><span class="c1">-- On calcul la longeur 2e fraction du segement en soustrayant la longeur de la 1ere fraction à la longeur du segment . On stocke également la geom à parcourir</span>
<span class="w">                  </span><span class="k">from</span><span class="w"> </span><span class="n">premier_troncon</span><span class="w"> </span><span class="n">p</span>
<span class="w">                         </span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<a class="reference internal image-reference" href="_images/4_geom_fractions.png"><img alt="_images/4_geom_fractions.png" src="_images/4_geom_fractions.png" style="width: 480px;" /></a>
<ul>
<li><dl>
<dt>On prépare ensuite la requête initiale de la récursive. Union des deux fractions de segment :</dt><dd><ul>
<li><p>On récupère l’identifiant du segment</p></li>
<li><p>La valeur de n1 pour la première fraction de segment (startpoint)</p></li>
<li><p>La valeur de n2 pour la deuxième fraction de segment (endpoint)</p></li>
<li><p>On attribue la valeur null pour le n2 du premier segment et le n1 du deuxième segment.</p></li>
<li><p>On récupère la longueur des fractions de segment (dist_n1 et dist_n2)</p></li>
<li><p>On stocke l’dentifiant dans une liste (array)</p></li>
<li><p>On récupère la géométrie des fractions de segment (n1_geom et n2_geom)</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">n1_distance</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="k">select</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w">   </span><span class="n">n1</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">n2</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">dist_n1</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">meters</span><span class="p">,</span><span class="w"> </span><span class="nb">ARRAY</span><span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">path_id</span><span class="p">,</span><span class="w">  </span><span class="n">n1_geom</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">geom_initiale</span><span class="w"> </span><span class="c1">-- on récupérer la valeur du noeud 1, null pour noeud 2 pour ne pas associer des segment du mauvais coté dans la recursive. On stocke également l&#39;id (array)</span>
<span class="w">                </span><span class="k">from</span><span class="w"> </span><span class="n">n1_distance</span><span class="p">,</span><span class="w"> </span><span class="n">premier_troncon</span><span class="w"> </span><span class="n">p</span>
<span class="w">             </span><span class="k">union</span><span class="w"> </span><span class="c1">-- pour partir dans les deux direction (noeud 1 et noeud 2)</span>
<span class="w">                </span><span class="k">select</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w">  </span><span class="k">null</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">n1</span><span class="p">,</span><span class="w"> </span><span class="n">n2</span><span class="w"> </span><span class="p">,</span><span class="w">  </span><span class="n">dist_n2</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">meters</span><span class="p">,</span><span class="w"> </span><span class="nb">ARRAY</span><span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">path_id</span><span class="p">,</span><span class="w"> </span><span class="n">n2_geom</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">geom_initiale</span><span class="c1">-- idem que pour la première direction. null au n1 pour ne pas associer des segments de ce coté.</span>
<span class="w">                </span><span class="k">from</span><span class="w"> </span><span class="n">n2_distance</span><span class="p">,</span><span class="w"> </span><span class="n">premier_troncon</span><span class="w"> </span><span class="n">p</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</dd>
</dl>
</li>
</ul>
<a class="reference internal image-reference" href="_images/5_requête_initiale.png"><img alt="_images/5_requ%C3%AAte_initiale.png" src="_images/5_requ%C3%AAte_initiale.png" style="width: 680px;" /></a>
<ul>
<li><dl>
<dt>On sélectionne les segments de routes qui ont les mêmes noeuds que les segments de la requête initiale:</dt><dd><ul>
<li><p>On séléctionne les segments de routes DECI dont le n2 ou le n1 correspond au n2 ou n1 de la requête initiale</p></li>
<li><p>On récupère leur identifiant</p></li>
<li><p>On récupère leur n1</p></li>
<li><p>On récupère la geom de la fraction de segment associée</p></li>
<li><p>On récupère la liste d’identifiants gardée en mémoire de la fraction de segment associée</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">ng</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
<span class="w">                           </span><span class="n">r</span><span class="p">.</span><span class="n">n1</span>
<span class="w">                           </span><span class="k">as</span><span class="w"> </span><span class="n">_n1</span><span class="p">,</span>
<span class="w">                           </span><span class="n">r</span><span class="p">.</span><span class="n">n2</span><span class="w">  </span><span class="k">as</span><span class="w"> </span><span class="n">_n2</span><span class="p">,</span>
<span class="w">                           </span><span class="n">sg</span><span class="p">.</span><span class="n">meters</span><span class="p">,</span><span class="w"> </span><span class="c1">-- distance cumulée</span>
<span class="w">                           </span><span class="n">sg</span><span class="p">.</span><span class="n">path_id</span><span class="p">,</span>
<span class="w">                           </span><span class="n">r</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="c1">-- geométrie du segment en cours de parcours</span>
<span class="w">                           </span><span class="n">sg</span><span class="p">.</span><span class="n">geom_initiale</span><span class="w"> </span><span class="c1">-- géométrie de départ (fraction du premie rsegement, en fonction de la projection de la borne dessus)</span>
<span class="w">                      </span><span class="k">from</span><span class="w"> </span><span class="n">search_graph</span><span class="w"> </span><span class="n">sg</span><span class="p">,</span><span class="w"> </span><span class="n">route_deci</span><span class="w"> </span><span class="n">r</span>
<span class="w">                      </span><span class="k">where</span><span class="w"> </span><span class="p">(</span>
<span class="w">                                   </span><span class="n">sg</span><span class="p">.</span><span class="n">_n2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">n1</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">sg</span><span class="p">.</span><span class="n">_n1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">n2</span><span class="w">  </span><span class="c1">-- on cherche tout n1 ou n2 qui correspond à la fin de notre segment courant</span>
<span class="w">                                   </span><span class="k">or</span><span class="w"> </span><span class="n">sg</span><span class="p">.</span><span class="n">_n1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">n1</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">sg</span><span class="p">.</span><span class="n">_n2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">n2</span><span class="p">))</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</dd>
</dl>
</li>
<li><dl>
<dt>On ajoute une UNION entre ces résultats et la requête initiale pour la récursivité:</dt><dd><ul class="simple">
<li><p>On sélectionne les id, les nœuds et les géometries de segments de routes rapprochés</p></li>
<li><p>On aditionne la longueur de la geometrie rapprochée à la longueur de fraction du segment</p></li>
<li><p>On stocke l’id du segment rapproché dans la liste d’identifiants gardée en mémoire</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="p">(</span><span class="n">ng</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
<span class="w">                    </span><span class="n">ng</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
<span class="w">                    </span><span class="n">ng</span><span class="p">.</span><span class="n">_n1</span><span class="p">,</span>
<span class="w">                    </span><span class="n">ng</span><span class="p">.</span><span class="n">_n2</span><span class="p">,</span>
<span class="w">                    </span><span class="n">ng</span><span class="p">.</span><span class="n">meters</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">st_length</span><span class="p">(</span><span class="n">ng</span><span class="p">.</span><span class="n">geom</span><span class="p">),</span><span class="c1">-- on ajoute la longeur du nouveau segment associé à la distance cumulée</span>
<span class="w">                    </span><span class="n">ng</span><span class="p">.</span><span class="n">path_id</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">ng</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
<span class="w">                    </span><span class="n">ng</span><span class="p">.</span><span class="n">geom_initiale</span>
<span class="w">               </span><span class="k">from</span><span class="w"> </span><span class="n">ng</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt>On termine la recursive :</dt><dd><ul class="simple">
<li><p>On conditionne l’ajout de segments (arrête de la recursive) à une distance cumulée de 360 mètres</p></li>
<li><p>On ferme la recursive, on la lance</p></li>
<li><p>On récupère au passage les géométrie de segments DECI qui ont le même id que l’ensemble des segments rapprochés.</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">ng</span>
<span class="w">      </span><span class="k">where</span>
<span class="w">         </span><span class="n">ng</span><span class="p">.</span><span class="n">meters</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">360</span><span class="w">  </span><span class="c1">-- filtre sur la distance max</span>
<span class="p">)</span>
<span class="k">select</span><span class="w"> </span><span class="n">sg</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">sg</span><span class="p">.</span><span class="n">_n1</span><span class="p">,</span><span class="w"> </span><span class="n">sg</span><span class="p">.</span><span class="n">_n2</span><span class="p">,</span><span class="w"> </span><span class="n">sg</span><span class="p">.</span><span class="n">meters</span><span class="p">,</span><span class="w">  </span><span class="n">r</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">sg</span><span class="p">.</span><span class="n">geom_initiale</span>
<span class="k">from</span><span class="w"> </span><span class="n">search_graph</span><span class="w"> </span><span class="n">sg</span>
<span class="k">join</span><span class="w"> </span><span class="n">route_deci</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sg</span><span class="p">.</span><span class="n">id</span>
</pre></div>
</div>
</dd>
</dl>
</li>
</ul>
<a class="reference internal image-reference" href="_images/6_recursive.png"><img alt="_images/6_recursive.png" src="_images/6_recursive.png" style="width: 880px;" /></a>
</div>
<div class="section" id="fractionner-les-segments-trop-longs">
<h4>3.3 Fractionner les segments trop longs<a class="headerlink" href="#fractionner-les-segments-trop-longs" title="Permalink to this heading"></a></h4>
<ul>
<li><dl>
<dt>Pour la suite du traitement, on conserve les résultats dont la longueur cumulée est égale ou inférieure à 360 mètres.</dt><dd><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">troncons_valides</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">     </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">resultat</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">meters</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">360</span>
<span class="w">                     </span><span class="p">),</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><p>On sélectionne ensuite les résultats dont la longueur cumulée est supérieure à 360 mètres, on joint les routes DECI en n1 ou n2.</p></li>
</ul>
<p><strong>si le segment joint en n_2 n’est pas un segment initial (pas de noeuds null)</strong></p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">st_linesubstring</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">st_length</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">meters</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">360</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">st_length</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">geom</span><span class="p">))</span>
</pre></div>
</div>
</div></blockquote>
<a class="reference internal image-reference" href="_images/7_fraction_cas_1.png"><img alt="_images/7_fraction_cas_1.png" src="_images/7_fraction_cas_1.png" style="width: 880px;" /></a>
<p><strong>si le segment joint en n_2 n’est pas un segment initial  (pas de noeuds null)</strong></p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">st_linesubstring</span><span class="p">(</span><span class="n">st_reverse</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">geom</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">   </span><span class="p">(</span><span class="n">st_length</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">meters</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">360</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">st_length</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">geom</span><span class="p">))</span>
</pre></div>
</div>
</div></blockquote>
<a class="reference internal image-reference" href="_images/8_fraction_cas_2.png"><img alt="_images/8_fraction_cas_2.png" src="_images/8_fraction_cas_2.png" style="width: 880px;" /></a>
<p><strong>si le segment est le segment initial fraction 1 (noeud 2 est null)</strong></p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">st_linesubstring</span><span class="p">(</span><span class="n">st_reverse</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">geom_initiale</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">   </span><span class="p">(</span><span class="n">st_length</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">geom_initiale</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">meters</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">360</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">st_length</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">geom_initiale</span><span class="p">))</span>
</pre></div>
</div>
</div></blockquote>
<a class="reference internal image-reference" href="_images/9_fraction_cas_3.png"><img alt="_images/9_fraction_cas_3.png" src="_images/9_fraction_cas_3.png" style="width: 380px;" /></a>
<p><strong>si le segment est le segment initial fraction 2 (noeud 1 est null)</strong></p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">st_linesubstring</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">geom_initiale</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">st_length</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">geom_initiale</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">meters</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">360</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">st_length</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">geom_initiale</span><span class="p">))</span>
</pre></div>
</div>
</div></blockquote>
<a class="reference internal image-reference" href="_images/10_fraction_cas_4.png"><img alt="_images/10_fraction_cas_4.png" src="_images/10_fraction_cas_4.png" style="width: 480px;" /></a>
<ul>
<li><dl>
<dt>Pour finir, on insère dans la table de données à 400 mètres l’UNION des données suivantes :</dt><dd><blockquote>
<div><ul class="simple">
<li><p>Buffer de 40 mètres de la géométrie des résultats dont la longueur cumulée est égale ou inférieure à 360 mètres.</p></li>
<li><p>Buffer de 40 mètres de la géométrie des fractions de segment dont la longueur est égale ou inférieure à 360 mètres.</p></li>
<li><p>Buffer de 40 mètres de la géométrie des fractions de segment dont la longueur était supérieure à 360 mètres.</p></li>
</ul>
</div></blockquote>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">final</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">              </span><span class="k">select</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="p">,</span><span class="w">  </span><span class="n">st_buffer</span><span class="p">(</span><span class="n">geom_initiale</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">geom</span><span class="w">  </span><span class="k">from</span><span class="w"> </span><span class="n">troncons_valides</span><span class="w"> </span><span class="c1">-- on récupere le buffer 40m de la geom des fraction de segments initiale</span>
<span class="w">                   </span><span class="k">union</span>
<span class="w">                   </span><span class="k">select</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="p">,</span><span class="w">  </span><span class="n">st_buffer</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">geom</span><span class="w">  </span><span class="k">from</span><span class="w"> </span><span class="n">troncons_valides</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">st_length</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">360</span><span class="w"> </span><span class="c1">-- on récupere le buffer 40m  de la geom des segments qui font moins de 400 mètres</span>
<span class="w">                   </span><span class="k">union</span>
<span class="w">              </span><span class="k">select</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="p">,</span><span class="w">  </span><span class="n">st_buffer</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">geom</span><span class="w">   </span><span class="k">from</span><span class="w"> </span><span class="n">fractions</span><span class="w"> </span><span class="c1">-- on récupère le buffer 40m des geom des fractions de segments qui dépassent 400 mètres</span>
<span class="w">         </span><span class="p">)</span>
<span class="w">         </span><span class="k">select</span><span class="w"> </span><span class="n">ST_Multi</span><span class="p">(</span><span class="n">st_union</span><span class="p">(</span><span class="n">geom</span><span class="p">))</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">geom_buffer_400</span><span class="w"> </span><span class="c1">-- on unie les geom buffer en MULTI* geometry collection</span>
<span class="w">         </span><span class="k">from</span><span class="w"> </span><span class="k">final</span><span class="p">;</span>
</pre></div>
</div>
</dd>
</dl>
</li>
</ul>
</div>
</div>
</div>
<span id="document-deci/II_rapproch_ign"></span><div class="section" id="ii-rapprochement-adresse-bdtopo-ign">
<h2>II- Rapprochement adresse BDtopo IGN<a class="headerlink" href="#ii-rapprochement-adresse-bdtopo-ign" title="Permalink to this heading"></a></h2>
<p>Afin de faciliter le travail d’intervention des secours, le pôle SIg à répondu à une demande de rapprochement des adresses BAL dont dispose le Département avec les tronçons de voies IGN.</p>
<p>L’objectif étant de déterminer pour chaque tronçon de BDtopo :
* Le nom de la voie
* Le premier numéro à droite
* Le premier numéro à gauche
* Le dernier numéro à droite
* Le dernier numéro à gauche</p>
<a class="reference internal image-reference" href="_images/schema_part_II.png"><img alt="_images/schema_part_II.png" src="_images/schema_part_II.png" style="width: 580px;" /></a>
<div class="section" id="rapprochement-des-voies-adresses-avec-les-troncons-routes">
<h3>1- Rapprochement des voies adresses avec les tronçons routes<a class="headerlink" href="#rapprochement-des-voies-adresses-avec-les-troncons-routes" title="Permalink to this heading"></a></h3>
<p>Cette première étape vise à associer pour chaque voie tracée et enregistrée par les communes dans la base de données adresse du Département un tronçon BDtopo IGN.</p>
<p>Pour cela nous faisons appel à la fonction <em>adresse.id_voie_bdtopo_sdis()</em> qui se trouve ici : <a class="reference external" href="https://github.com/sig14/sig14.github.io/blob/master/deci/sql/fonction_rapproche_adresses_voies_ign.sql">fonction sql</a></p>
<div class="section" id="segmenter-les-troncons-bdtopo">
<h4>1.1 Segmenter les tronçons Bdtopo<a class="headerlink" href="#segmenter-les-troncons-bdtopo" title="Permalink to this heading"></a></h4>
<p>Dans un premier temps, la fonction crée une table temporaire des nœuds de BDtopo que l’on va pouvoir indexer pour accélérer le traitement :</p>
<blockquote>
<div><p><strong>1 - Sélection des périmètres communes bdtopo correspondant aux périmètres des communes adresses publiées</strong> (pour circonscrire les tronçons sur les bons périmètres)</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">with</span><span class="w"> </span><span class="n">commune_pub</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">   </span><span class="k">select</span><span class="w"> </span><span class="n">st_buffer</span><span class="p">(</span><span class="n">bc</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">geom</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">v_communes_publiees</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">ign</span><span class="p">.</span><span class="n">bdtopo_commune</span><span class="w"> </span><span class="n">bc</span><span class="w"> </span><span class="c1">-- buffer de 100 mètres des communes ign du au décalage ign osm</span>
<span class="w">         </span><span class="k">where</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">insee_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bc</span><span class="p">.</span><span class="n">insee_com</span>
<span class="w">   </span><span class="p">),</span>
<span class="n">troncon_com_pub</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="c1">--- selection des tronçon sur les communes bdtopo sléctionnées plus haut</span>
<span class="w">   </span><span class="k">select</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">ign</span><span class="p">.</span><span class="n">bdtopo_troncon_de_route</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">commune_pub</span>
<span class="w">   </span><span class="k">where</span><span class="w"> </span><span class="n">st_intersects</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="n">commune_pub</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
<span class="w">   </span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p><strong>2 - Création de noeuds bdtopo</strong> : segmentation des tronçons tous les 10 mètres, transformation des segments en multipoints, dump pour avoir des géométries uniques.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">ROW_NUMBER</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">id_pt</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
<span class="p">(</span><span class="n">ST_Dump</span><span class="p">(</span><span class="n">ST_AsMultiPoint</span><span class="p">(</span><span class="n">st_segmentize</span><span class="p">(</span><span class="n">ST_Force2D</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="p">,</span><span class="mi">10</span><span class="p">))::</span><span class="n">geometry</span><span class="p">(</span><span class="n">MULTIPOINT</span><span class="p">,</span><span class="mi">2154</span><span class="p">))).</span><span class="n">geom</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">geom</span><span class="w"> </span><span class="c1">--- création de noeuds multipoints bdtopo à partir de la segmentisation des tronçons(3D)</span>
<span class="k">from</span><span class="w"> </span><span class="n">troncon_com_pub</span><span class="w">  </span><span class="k">c</span><span class="p">;</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">node_bd_topo_geom</span><span class="w"> </span><span class="c1">--- création d&#39;un indexe sur la geom de la table</span>
<span class="k">ON</span><span class="w"> </span><span class="n">node_bd_topo</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="n">gist</span><span class="w"> </span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
<span class="n">TABLESPACE</span><span class="w"> </span><span class="n">pg_default</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<a class="reference internal image-reference" href="_images/II_1_1_segemnt_bdtopo.png"><img alt="_images/II_1_1_segemnt_bdtopo.png" src="_images/II_1_1_segemnt_bdtopo.png" style="width: 380px;" /></a>
</div>
<div class="section" id="id1">
<h4>1.2 Segmenter les tronçons Bdtopo<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h4>
<p>Dans un second temps on rapproche les tronçons dont la majorité des noeuds se trouve sur une voie adresse.</p>
<blockquote>
<div><p><strong>1 - Buffer des voies adresses</strong></p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">commune_pub</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="c1">------ selection des communes bd_topo correspondant aux communes publiées adresse</span>
<span class="w">  </span><span class="k">select</span><span class="w"> </span><span class="n">st_buffer</span><span class="p">(</span><span class="n">bc</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">geom</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">v_communes_publiees</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">ign</span><span class="p">.</span><span class="n">bdtopo_commune</span><span class="w"> </span><span class="n">bc</span><span class="w"> </span><span class="c1">-- buffer de 100 mètres des communes ign du au décalage ign osm</span>
<span class="w">                                </span><span class="k">where</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">insee_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bc</span><span class="p">.</span><span class="n">insee_com</span>
<span class="w">  </span><span class="p">),</span>
<span class="n">voie</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="c1">------ selection des voies adresses bufferisées sur les communes publiées adresse</span>
<span class="w">  </span><span class="k">select</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">id_voie</span><span class="p">,</span><span class="w"> </span><span class="n">ST_Buffer</span><span class="p">(</span><span class="n">ST_Buffer</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;endcap=flat join=round&#39;</span><span class="p">),</span><span class="w"> </span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;endcap=flat join=round&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">geom</span><span class="w"> </span><span class="c1">-- on aura besoin du buffer pour collecter les noeuds (on créé un buffer de 10 mètres et on raccourci les bords de 5 mètres)</span>
<span class="w">  </span><span class="k">from</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">voie</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">commune_pub</span><span class="w"> </span><span class="n">a</span>
<span class="w">  </span><span class="k">where</span><span class="w"> </span><span class="n">st_intersects</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="n">v</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
<span class="w">  </span><span class="p">),</span>
</pre></div>
</div>
</div></blockquote>
<p><strong>2 - Compter le nombre de noeuds par tronçon de route</strong></p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">pt_count_troncon</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="c1">------ Compte le nombre de noeuds par tronçon</span>
<span class="w">  </span><span class="k">select</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="n">id_pt</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ct</span>
<span class="w">  </span><span class="k">from</span><span class="w"> </span><span class="n">node_bd_topo</span>
<span class="w">  </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">id</span><span class="p">),</span>
</pre></div>
</div>
</div></blockquote>
<p><strong>4 - Rapprocher les noeuds bdtopo qui intersectent le buffer des voies adresses</strong></p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="c1">------ rapprochement des id_voies et des noeuds à l&#39;intérieur du buffer des voies précédemment créé</span>
<span class="w">  </span><span class="k">select</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id_pt</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">voie</span><span class="p">.</span><span class="n">id_voie</span>
<span class="w">  </span><span class="k">from</span><span class="w"> </span><span class="n">node_bd_topo</span><span class="w">  </span><span class="n">b</span>
<span class="w">  </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">voie</span>
<span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="n">ST_Within</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">voie</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
<span class="w">  </span><span class="p">),</span>
</pre></div>
</div>
</div></blockquote>
<p><strong>5 - Compter le nombre de noeuds bdtopo par voie adresse</strong></p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">l</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="c1">------ Compte le nombre de noeud pour chaque id_voie</span>
<span class="w">  </span><span class="k">select</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">id_voie</span><span class="p">,</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">id_voie</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ct</span>
<span class="w">  </span><span class="k">from</span><span class="w"> </span><span class="n">f</span>
<span class="w">  </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">id_voie</span>
<span class="w">  </span><span class="p">),</span>
</pre></div>
</div>
</div></blockquote>
<p><strong>6 - Rapprochement des tronçons à une voie adresse si la majorité de ses nœuds est comprise dans son buffer</strong></p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">troncon_node</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="c1">------ Séléctionne les id_tronçon dont la majorité des noeuds intersecte le buffer des voies</span>
<span class="w">  </span><span class="k">select</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="p">(</span><span class="n">l</span><span class="p">.</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="n">l</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">l</span><span class="p">.</span><span class="n">id_voie</span><span class="p">,</span><span class="w"> </span><span class="n">l</span><span class="p">.</span><span class="n">ct</span>
<span class="w">  </span><span class="k">from</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">pt_count_troncon</span>
<span class="w">  </span><span class="k">where</span><span class="w"> </span><span class="n">pt_count_troncon</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">pt_count_troncon</span><span class="p">.</span><span class="n">ct</span><span class="o">/</span><span class="n">l</span><span class="p">.</span><span class="n">ct</span><span class="p">)</span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="c1">-- division du total des noeuds tronçon/le nombre de noeuds pour un même id_voie, si moins de 2, on conserve l&#39;id-tronçon et l&#39;id_voie associé</span>
<span class="w">  </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">l</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">l</span><span class="p">.</span><span class="n">ct</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span>

<span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">troncon_node</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">troncon_node</span><span class="p">.</span><span class="n">id_voie</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">.</span><span class="n">geom</span><span class="w"> </span><span class="c1">------ Rapprochement des géométrie de la bd_topo grâce à l&#39;id tronçon des noeuds précédemment sélectionnés</span>
<span class="w"> </span><span class="k">from</span><span class="w">  </span><span class="n">troncon_node</span><span class="p">,</span><span class="w"> </span><span class="n">ign</span><span class="p">.</span><span class="n">bdtopo_troncon_de_route</span><span class="w"> </span><span class="n">k</span>
<span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">k</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">troncon_node</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</div></blockquote>
<a class="reference internal image-reference" href="_images/II_1_2_buffer_voie_adresse.png"><img alt="_images/II_1_2_buffer_voie_adresse.png" src="_images/II_1_2_buffer_voie_adresse.png" style="width: 380px;" /></a>
</div>
</div>
<div class="section" id="raprochement-des-adresses">
<h3>2- Raprochement des adresses<a class="headerlink" href="#raprochement-des-adresses" title="Permalink to this heading"></a></h3>
<p>Cette seconde étape vise à associer pour chaque tronçon, les points adresses dépendant de la voie qui lui a été attribué.</p>
<p>Pour cela nous créons une vue matérialisée <em>adresse.vm_sdis_pts_adresse_bdtopo</em> dont le code se trouve ici : <a class="reference external" href="https://github.com/sig14/sig14.github.io/blob/master/deci/sql/vm_rapproch_adresses_point_voie_ign.sql">vm sql</a></p>
<div class="section" id="projeter-les-points-adresses-sur-les-troncons">
<h4>2.1 Projeter les points adresses sur les tronçons<a class="headerlink" href="#projeter-les-points-adresses-sur-les-troncons" title="Permalink to this heading"></a></h4>
<p>On projete le point sur le tronçon le plus prohce associé à la voie dont dépend le point adresse.</p>
<blockquote>
<div><p><strong>1 - Projection des points adresse sur les tronçon ayant le même id_voie</strong></p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">with</span><span class="w"> </span><span class="n">bdtopo_idvoie</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w">  </span><span class="n">adresse</span><span class="p">.</span><span class="n">id_voie_bdtopo_sdis</span><span class="p">()</span><span class="w"> </span><span class="c1">--- Fonction donnant la séléction des id_tronçons bdtopo et des id_voies adresse</span>
<span class="w">   </span><span class="p">),</span>
<span class="w">   </span><span class="n">distance_troncon</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="k">select</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id_point</span><span class="p">,</span><span class="w"> </span><span class="n">troncon</span><span class="p">.</span><span class="n">id_troncon</span><span class="p">,</span><span class="w"> </span><span class="n">troncon</span><span class="p">.</span><span class="n">id_voie</span><span class="p">,</span><span class="w"> </span><span class="n">troncon</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">numero</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">suffixe</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">geom_pt_adresse</span><span class="p">,</span>
<span class="w">      </span><span class="n">ST_LineInterpolatePoint</span><span class="p">(</span><span class="n">ST_LineMerge</span><span class="p">(</span><span class="n">troncon</span><span class="p">.</span><span class="n">geom</span><span class="p">),</span><span class="w"> </span><span class="n">ST_LineLocatePoint</span><span class="p">(</span><span class="n">ST_AsEWKT</span><span class="p">(</span><span class="n">ST_LineMerge</span><span class="p">(</span><span class="n">troncon</span><span class="p">.</span><span class="n">geom</span><span class="p">)),</span><span class="w"> </span><span class="n">ST_AsEWKT</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">)))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">geom_pt_proj</span><span class="p">,</span><span class="w"> </span><span class="c1">--- Projection des points adresses sur les tronçon ayant le même id_voie</span>
<span class="w">      </span><span class="n">st_distance</span><span class="p">(</span><span class="n">troncon</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="c1">--- distance entre le point et la voie</span>
<span class="w">      </span><span class="k">FROM</span><span class="w"> </span><span class="n">bdtopo_idvoie</span><span class="w">  </span><span class="n">troncon</span>
<span class="w">      </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">point_adresse</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">troncon</span><span class="p">.</span><span class="n">id_voie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id_voie</span>
<span class="w">      </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">v_communes_publiees</span><span class="w"> </span><span class="n">l</span><span class="w">  </span><span class="k">on</span><span class="w"> </span><span class="n">st_intersects</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="n">l</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
<span class="w">   </span><span class="p">),</span>
</pre></div>
</div>
</div></blockquote>
<p><strong>2 - Sélection unique des id_points avec id tronçon associés dont la distance est la plus courte</strong> : pour une voie comprenant plusieurs tronçons bdtopo on associe les points adresses aux tronçon le plus proche)</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">point_proj</span><span class="w"> </span><span class="k">as</span><span class="p">(</span><span class="w"> </span><span class="c1">---</span>
<span class="w">   </span><span class="k">select</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="p">(</span><span class="n">distance_troncon</span><span class="p">.</span><span class="n">id_point</span><span class="p">)</span><span class="w"> </span><span class="n">distance_troncon</span><span class="p">.</span><span class="n">id_point</span><span class="p">,</span><span class="w"> </span><span class="n">distance_troncon</span><span class="p">.</span><span class="n">id_troncon</span><span class="p">,</span><span class="w"> </span><span class="n">distance_troncon</span><span class="p">.</span><span class="n">id_voie</span><span class="p">,</span><span class="w"> </span><span class="c1">-- selection distinct d&#39;id_point adresse</span>
<span class="w">   </span><span class="n">distance_troncon</span><span class="p">.</span><span class="n">numero</span><span class="p">,</span><span class="w"> </span><span class="n">distance_troncon</span><span class="p">.</span><span class="n">suffixe</span><span class="p">,</span><span class="w"> </span><span class="n">distance_troncon</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">geom_pt_adresse</span><span class="p">,</span><span class="w"> </span><span class="n">geom_pt_proj</span>
<span class="w">   </span><span class="k">from</span><span class="w"> </span><span class="n">distance_troncon</span>
<span class="w">   </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">id_point</span><span class="p">,</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="k">ASC</span><span class="w"> </span><span class="c1">--- ordonner de la plus petite distance à la plus grande pour que distinct sélectionne la première entité avec la plus courte distance</span>
<span class="p">),</span>
</pre></div>
</div>
</div></blockquote>
</div></blockquote>
<a class="reference internal image-reference" href="_images/II_2_1_point_proj.png"><img alt="_images/II_2_1_point_proj.png" src="_images/II_2_1_point_proj.png" style="width: 380px;" /></a>
</div>
<div class="section" id="determiner-de-quels-cotes-se-trouve-les-points-adresse">
<h4>2.2 Determiner de quels côtés se trouve les points adresse<a class="headerlink" href="#determiner-de-quels-cotes-se-trouve-les-points-adresse" title="Permalink to this heading"></a></h4>
<p>Pour identifier le côté du point adresse par rapport au tronçon.</p>
<blockquote>
<div><p><strong>1 - Tracer une ligne prolongée entre le point adresse et son point projeté sur le tronçon</strong></p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="w">            </span><span class="n">line_cross</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="c1">---</span>
<span class="w">   </span><span class="k">select</span><span class="w"> </span><span class="n">point_proj</span><span class="p">.</span><span class="n">id_point</span><span class="p">,</span><span class="w"> </span><span class="n">point_proj</span><span class="p">.</span><span class="n">id_troncon</span><span class="p">,</span><span class="w"> </span><span class="n">point_proj</span><span class="p">.</span><span class="n">id_voie</span><span class="p">,</span><span class="w"> </span><span class="n">point_proj</span><span class="p">.</span><span class="n">numero</span><span class="p">,</span><span class="w"> </span><span class="n">point_proj</span><span class="p">.</span><span class="n">suffixe</span><span class="p">,</span><span class="w"> </span><span class="n">point_proj</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">geom_pt_adresse</span><span class="p">,</span><span class="w"> </span><span class="n">geom_pt_proj</span><span class="p">,</span>
<span class="w">   </span><span class="n">ST_MakeLine</span><span class="p">(</span><span class="n">geom_pt_adresse</span><span class="p">,</span><span class="w"> </span><span class="n">ST_TRANSLATE</span><span class="p">(</span><span class="n">geom_pt_adresse</span><span class="p">,</span><span class="w"> </span><span class="n">sin</span><span class="p">(</span><span class="n">ST_AZIMUTH</span><span class="p">(</span><span class="n">geom_pt_adresse</span><span class="p">,</span><span class="n">geom_pt_proj</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">ST_DISTANCE</span><span class="p">(</span><span class="n">geom_pt_adresse</span><span class="p">,</span><span class="n">geom_pt_proj</span><span class="p">)</span>
<span class="w">   </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">ST_DISTANCE</span><span class="p">(</span><span class="n">geom_pt_adresse</span><span class="p">,</span><span class="n">geom_pt_proj</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">50</span><span class="o">/</span><span class="mi">49</span><span class="p">))),</span><span class="w"> </span><span class="n">cos</span><span class="p">(</span><span class="n">ST_AZIMUTH</span><span class="p">(</span><span class="n">geom_pt_adresse</span><span class="p">,</span><span class="n">geom_pt_proj</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">ST_DISTANCE</span><span class="p">(</span><span class="n">geom_pt_adresse</span><span class="p">,</span><span class="n">geom_pt_proj</span><span class="p">)</span>
<span class="w">   </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">ST_DISTANCE</span><span class="p">(</span><span class="n">geom_pt_adresse</span><span class="p">,</span><span class="n">geom_pt_proj</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">50</span><span class="o">/</span><span class="mi">49</span><span class="p">)))))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">geom_segment</span>
<span class="w">   </span><span class="k">from</span><span class="w"> </span><span class="n">point_proj</span>
<span class="p">),</span>
</pre></div>
</div>
</div></blockquote>
<p><strong>2 - Definir le coté de du point adresse par rapport au tronçon grâce au sens de croisement du segment précédemment créé</strong></p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">point_cote</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="c1">---</span>
<span class="w">   </span><span class="k">select</span><span class="w"> </span><span class="n">line_cross</span><span class="p">.</span><span class="n">id_point</span><span class="p">,</span><span class="w"> </span><span class="n">line_cross</span><span class="p">.</span><span class="n">id_troncon</span><span class="p">,</span><span class="w"> </span><span class="n">line_cross</span><span class="p">.</span><span class="n">id_voie</span><span class="p">,</span><span class="w"> </span><span class="n">line_cross</span><span class="p">.</span><span class="n">numero</span><span class="p">,</span><span class="w"> </span><span class="n">line_cross</span><span class="p">.</span><span class="n">suffixe</span><span class="p">,</span>
<span class="w">   </span><span class="k">case</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">ST_LineCrossingDirection</span><span class="p">(</span><span class="n">geom_segment</span><span class="p">,</span><span class="w"> </span><span class="n">ST_LineMerge</span><span class="p">(</span><span class="n">geom</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;gauche&#39;</span>
<span class="w">      </span><span class="k">WHEN</span><span class="w"> </span><span class="n">ST_LineCrossingDirection</span><span class="p">(</span><span class="n">geom_segment</span><span class="p">,</span><span class="w"> </span><span class="n">ST_LineMerge</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;droite&#39;</span>
<span class="w">      </span><span class="k">WHEN</span><span class="w"> </span><span class="n">ST_LineCrossingDirection</span><span class="p">(</span><span class="n">geom_segment</span><span class="p">,</span><span class="w"> </span><span class="n">ST_LineMerge</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;indefini&#39;</span><span class="w"> </span><span class="c1">--- Si croise ni à gauche ni à droite</span>
<span class="w">      </span><span class="k">ELSE</span><span class="w"> </span><span class="s1">&#39;probleme&#39;</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">cote_voie</span><span class="p">,</span><span class="w">  </span><span class="c1">--- croise plusieurs fois, donc problème de tracé du tronçon ou cas particulier (rare)</span>
<span class="w">   </span><span class="n">geom_segment</span><span class="p">,</span><span class="w"> </span><span class="n">geom_pt_adresse</span><span class="p">,</span><span class="w"> </span><span class="n">geom_pt_proj</span>
<span class="w">   </span><span class="k">from</span><span class="w"> </span><span class="n">line_cross</span>
<span class="p">),</span>
</pre></div>
</div>
</div></blockquote>
</div></blockquote>
<a class="reference internal image-reference" href="_images/II_2_2_sens_croisement.png"><img alt="_images/II_2_2_sens_croisement.png" src="_images/II_2_2_sens_croisement.png" style="width: 380px;" /></a>
</div>
<div class="section" id="ne-conserver-que-les-premiers-et-derniers-points-adresse">
<h4>2.3 Ne conserver que les premiers et derniers points adresse<a class="headerlink" href="#ne-conserver-que-les-premiers-et-derniers-points-adresse" title="Permalink to this heading"></a></h4>
<p>Pour identifier le côté du point adresse par rapport au tronçon.</p>
<blockquote>
<div><p><strong>1 - Sélection des tronçons sur les communes dont l’adressage est certifié/publié sur La BAN</strong></p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">commune_publ</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="w">  </span><span class="c1">------ selection des communes bd_topo correspondant aux communes publiées adresse</span>
<span class="w">      </span><span class="k">select</span><span class="w"> </span><span class="n">bc</span><span class="p">.</span><span class="n">geom</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">v_communes_publiees</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">ign</span><span class="p">.</span><span class="n">bdtopo_commune</span><span class="w"> </span><span class="n">bc</span>
<span class="w">         </span><span class="k">where</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">insee_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bc</span><span class="p">.</span><span class="n">insee_com</span>
<span class="w">   </span><span class="p">),</span>
<span class="w">   </span><span class="n">troncon_com_pub</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="c1">--- selection des tronçon sur les communes bdtopo sléctionnées plus haut</span>
<span class="w">      </span><span class="k">select</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">ign</span><span class="p">.</span><span class="n">bdtopo_troncon_de_route</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">commune_publ</span>
<span class="w">      </span><span class="k">where</span><span class="w"> </span><span class="n">st_intersects</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="n">commune_publ</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
<span class="w">   </span><span class="p">),</span>
</pre></div>
</div>
</div></blockquote>
<p><strong>2 - Sélection des points adresses droite/gauches les plus proches du point de fin et départ du tronçon</strong></p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">point_pair_first</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="c1">------ selection du point adresse par tronçon à droite le plus proche point de départ du tronçon</span>
<span class="w">   </span><span class="k">select</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">id_troncon</span><span class="p">)</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id_point</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id_troncon</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id_voie</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">numero</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">suffixe</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">cote_voie</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">geom_pt_adresse</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">geom_pt</span><span class="p">,</span>
<span class="w">   </span><span class="n">st_distance</span><span class="p">(</span><span class="n">ST_StartPoint</span><span class="p">(</span><span class="n">st_linemerge</span><span class="p">(</span><span class="n">tc</span><span class="p">.</span><span class="n">geom</span><span class="p">)),</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">geom_pt_proj</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">dist</span>
<span class="w">   </span><span class="k">from</span><span class="w"> </span><span class="n">point_cote</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">troncon_com_pub</span><span class="w"> </span><span class="n">tc</span>
<span class="w">   </span><span class="k">where</span><span class="w"> </span><span class="n">cote_voie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;droite&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id_troncon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tc</span><span class="p">.</span><span class="n">id</span>
<span class="w">   </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id_troncon</span><span class="p">,</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="k">ASC</span><span class="w"> </span><span class="c1">--- ordonner de la plus petite distance à la plus grande pour que distinct sélectionne la première entité avec la plus courte distance</span>
<span class="p">),</span>
<span class="n">point_pair_der</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="c1">------ selection du point adresse par tronçon à droite et le plus proche du point de fin du tronçon</span>
<span class="w">   </span><span class="k">select</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">id_troncon</span><span class="p">)</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id_point</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id_troncon</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id_voie</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">numero</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">suffixe</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">cote_voie</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">geom_pt_adresse</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">geom_pt</span><span class="p">,</span>
<span class="w">   </span><span class="n">st_distance</span><span class="p">(</span><span class="n">ST_EndPoint</span><span class="p">(</span><span class="n">st_linemerge</span><span class="p">(</span><span class="n">tc</span><span class="p">.</span><span class="n">geom</span><span class="p">)),</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">geom_pt_proj</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">dist</span>
<span class="w">   </span><span class="k">from</span><span class="w"> </span><span class="n">point_cote</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">troncon_com_pub</span><span class="w"> </span><span class="n">tc</span>
<span class="w">   </span><span class="k">where</span><span class="w"> </span><span class="n">cote_voie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;droite&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id_troncon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tc</span><span class="p">.</span><span class="n">id</span>
<span class="w">   </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id_troncon</span><span class="p">,</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="k">ASC</span>
<span class="p">),</span>
<span class="n">point_impair_first</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="c1">------ selection du points adresse par tronçon à gauche et le plus proche du  point de départ du tronçon</span>
<span class="w">   </span><span class="k">select</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">id_troncon</span><span class="p">)</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id_point</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id_troncon</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id_voie</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">numero</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">suffixe</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">cote_voie</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">geom_pt_adresse</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">geom_pt</span><span class="p">,</span>
<span class="w">   </span><span class="n">st_distance</span><span class="p">(</span><span class="n">ST_StartPoint</span><span class="p">(</span><span class="n">st_linemerge</span><span class="p">(</span><span class="n">tc</span><span class="p">.</span><span class="n">geom</span><span class="p">)),</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">geom_pt_proj</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">dist</span>
<span class="w">   </span><span class="k">from</span><span class="w"> </span><span class="n">point_cote</span><span class="w"> </span><span class="k">c</span><span class="p">,</span><span class="w"> </span><span class="n">troncon_com_pub</span><span class="w"> </span><span class="n">tc</span>
<span class="w">   </span><span class="k">where</span><span class="w"> </span><span class="n">cote_voie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;gauche&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id_troncon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tc</span><span class="p">.</span><span class="n">id</span>
<span class="w">   </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id_troncon</span><span class="p">,</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="k">ASC</span>
<span class="p">),</span>
<span class="n">point_impair_der</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="c1">------ selection du point adresse par tronçon à gauche et le plus proche du  point de fin du tronçon</span>
<span class="w">   </span><span class="k">select</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">id_troncon</span><span class="p">)</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">id_point</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">id_troncon</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">id_voie</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">numero</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">suffixe</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">cote_voie</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">geom_pt_adresse</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">geom_pt</span><span class="p">,</span>
<span class="w">   </span><span class="n">st_distance</span><span class="p">(</span><span class="n">ST_EndPoint</span><span class="p">(</span><span class="n">st_linemerge</span><span class="p">(</span><span class="n">tc</span><span class="p">.</span><span class="n">geom</span><span class="p">)),</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">geom_pt_proj</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">dist</span>
<span class="w">   </span><span class="k">from</span><span class="w"> </span><span class="n">point_cote</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">troncon_com_pub</span><span class="w"> </span><span class="n">tc</span>
<span class="w">   </span><span class="k">where</span><span class="w"> </span><span class="n">cote_voie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;gauche&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">id_troncon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tc</span><span class="p">.</span><span class="n">id</span>
<span class="w">   </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">id_troncon</span><span class="p">,</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="k">ASC</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p><strong>3 - Jointure des précédentes sélections :</strong> tronçons rapprochés (z),  geométrie tronçon ign (e) et  nom complet des voies (v)</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">Select</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">id_troncon</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">id_voie</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">nom_complet</span><span class="p">,</span><span class="w"> </span><span class="c1">------ J</span>
<span class="n">CONCAT</span><span class="p">(</span><span class="n">point_pair_first</span><span class="p">.</span><span class="n">numero</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">point_pair_first</span><span class="p">.</span><span class="n">suffixe</span><span class="p">)</span><span class="w">  </span><span class="k">as</span><span class="w"> </span><span class="n">prem_num_droite</span><span class="p">,</span>
<span class="n">CONCAT</span><span class="p">(</span><span class="n">point_pair_der</span><span class="p">.</span><span class="n">numero</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">point_pair_der</span><span class="p">.</span><span class="n">suffixe</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">der_num_droite</span><span class="p">,</span>
<span class="n">CONCAT</span><span class="p">(</span><span class="n">point_impair_first</span><span class="p">.</span><span class="n">numero</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">point_impair_first</span><span class="p">.</span><span class="n">suffixe</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">prem_num_gauche</span><span class="p">,</span>
<span class="n">CONCAT</span><span class="p">(</span><span class="n">point_impair_der</span><span class="p">.</span><span class="n">numero</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">point_impair_der</span><span class="p">.</span><span class="n">suffixe</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">der_num_gauche</span><span class="p">,</span>
<span class="n">e</span><span class="p">.</span><span class="n">geom</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">geom_tronçon</span>
<span class="k">from</span><span class="w"> </span><span class="n">point_cote</span><span class="w"> </span><span class="n">z</span>
<span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">point_pair_first</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">id_troncon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">point_pair_first</span><span class="p">.</span><span class="n">id_troncon</span>
<span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">point_pair_der</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">id_troncon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">point_pair_der</span><span class="p">.</span><span class="n">id_troncon</span>
<span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">point_impair_first</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">id_troncon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">point_impair_first</span><span class="p">.</span><span class="n">id_troncon</span>
<span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">point_impair_der</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">id_troncon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">point_impair_der</span><span class="p">.</span><span class="n">id_troncon</span>
<span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">troncon_com_pub</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">id_troncon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">id</span>
<span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">voie</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">id_voie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">id_voie</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">id_troncon</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">id_voie</span><span class="p">,</span><span class="w"> </span><span class="n">point_pair_first</span><span class="p">.</span><span class="n">numero</span><span class="p">,</span><span class="w"> </span><span class="n">point_pair_der</span><span class="p">.</span><span class="n">numero</span><span class="p">,</span><span class="w"> </span><span class="n">point_impair_first</span><span class="p">.</span><span class="n">numero</span><span class="p">,</span><span class="w"> </span><span class="n">point_impair_der</span><span class="p">.</span><span class="n">numero</span><span class="p">,</span>
<span class="n">point_pair_first</span><span class="p">.</span><span class="n">suffixe</span><span class="p">,</span><span class="w"> </span><span class="n">point_pair_der</span><span class="p">.</span><span class="n">suffixe</span><span class="p">,</span><span class="w"> </span><span class="n">point_impair_first</span><span class="p">.</span><span class="n">suffixe</span><span class="p">,</span><span class="w"> </span><span class="n">point_impair_der</span><span class="p">.</span><span class="n">suffixe</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">nom_complet</span><span class="w">  </span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</div></blockquote>
<a class="reference internal image-reference" href="_images/II_2_3_start_point_end_point.png"><img alt="_images/II_2_3_start_point_end_point.png" src="_images/II_2_3_start_point_end_point.png" style="width: 380px;" /></a>
</div>
</div>
<div class="section" id="liste-des-points-adresse-indetermines">
<h3>3- Liste des points adresse indeterminés<a class="headerlink" href="#liste-des-points-adresse-indetermines" title="Permalink to this heading"></a></h3>
<p>On identifie ici les points adresse dont le côté n’a pu être determiné : mauvais tracé d’un tronçon, positionnement particulier du point adresse par rapport au tronçon (à l’extrémité d’un tronçon).</p>
<p>Pour cela nous créons une vue materialisée <a href="#id2"><span class="problematic" id="id3">*</span></a>adresse.vm_sdis_pts_adresse_indetermine * dont le code se trouve ici : <a class="reference external" href="https://github.com/sig14/sig14.github.io/blob/master/deci/sql/vm_adresses_indeterminees_voies_ign.sql">vm sql</a></p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="w">   </span><span class="k">with</span><span class="w"> </span><span class="n">bdtopo_idvoie</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="c1">--- Fonction donnant la séléction des id_tronçons bdtopo et des id_voies adresse</span>
<span class="w">   </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w">  </span><span class="n">adresse</span><span class="p">.</span><span class="n">id_voie_bdtopo_sdis</span><span class="p">()</span>
<span class="w">   </span><span class="p">),</span>
<span class="w">   </span><span class="n">commune_pub</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="c1">------ selection des communes bd_topo correspondant aux communes publiées adresse</span>
<span class="w">      </span><span class="k">select</span><span class="w"> </span><span class="n">st_buffer</span><span class="p">(</span><span class="n">bc</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">geom</span>
<span class="w">      </span><span class="k">from</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">v_communes_publiees</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">ign</span><span class="p">.</span><span class="n">bdtopo_commune</span><span class="w"> </span><span class="n">bc</span>
<span class="w">         </span><span class="k">where</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">insee_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bc</span><span class="p">.</span><span class="n">insee_com</span>
<span class="w">   </span><span class="p">),</span>
<span class="w">   </span><span class="n">troncon_com_pub</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="c1">--- selection des tronçon sur les communes bdtopo sléctionnées plus haut</span>
<span class="w">      </span><span class="k">select</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">ign</span><span class="p">.</span><span class="n">bdtopo_troncon_de_route</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">commune_pub</span>
<span class="w">      </span><span class="k">where</span><span class="w"> </span><span class="n">st_intersects</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="n">commune_pub</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
<span class="w">   </span><span class="p">)</span>
<span class="k">select</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="w"> </span><span class="c1">--- selection des tronçon qui n&#39;ont pas d&#39;id_voie associé</span>
<span class="k">from</span><span class="w"> </span><span class="n">troncon_com_pub</span><span class="w"> </span><span class="n">p</span>
<span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">bdtopo_idvoie</span><span class="w"> </span><span class="n">a</span>
<span class="k">on</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id_troncon</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id_voie</span>
<span class="k">having</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id_voie</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">null</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="voies-adresses-non-affiliees-a-un-troncon">
<h3>4- Voies adresses non affiliées à un tronçon<a class="headerlink" href="#voies-adresses-non-affiliees-a-un-troncon" title="Permalink to this heading"></a></h3>
<p>On identifie ici les voies adresses pour lesquelles aucun tronçon n’a pu être rapproché : pas de tronçon superposé, une trop petite partie du tronçon superposée.</p>
<p>Pour cela nous créons une vue materialisée <em>adresse.vm_troncon_no_voie_bd_topo</em> dont le code se trouve ici : <a class="reference external" href="https://github.com/sig14/sig14.github.io/blob/master/deci/sql/vm_voies_adresses_sans_tron%C3%A7on_ign.sql">vm sql</a></p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">with</span><span class="w"> </span><span class="n">bdtopo_idvoie</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="c1">--- Fonction donnant la séléction des id_tronçons bdtopo et des id_voies adresse</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w">  </span><span class="n">adresse</span><span class="p">.</span><span class="n">id_voie_bdtopo_sdis</span><span class="p">()</span>
<span class="p">),</span>

<span class="n">distance_troncon</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="c1">--- Projection des points adresses sur les tronçon ayant le même id_voie et de la distance entre le point et la voie</span>
<span class="k">select</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id_point</span><span class="p">,</span><span class="w"> </span><span class="n">troncon</span><span class="p">.</span><span class="n">id_troncon</span><span class="p">,</span><span class="w"> </span><span class="n">troncon</span><span class="p">.</span><span class="n">id_voie</span><span class="p">,</span><span class="w"> </span><span class="n">troncon</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">numero</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">suffixe</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">geom_pt_adresse</span><span class="p">,</span>
<span class="n">ST_LineInterpolatePoint</span><span class="p">(</span><span class="n">ST_LineMerge</span><span class="p">(</span><span class="n">troncon</span><span class="p">.</span><span class="n">geom</span><span class="p">),</span>
<span class="n">ST_LineLocatePoint</span><span class="p">(</span><span class="n">ST_AsEWKT</span><span class="p">(</span><span class="n">ST_LineMerge</span><span class="p">(</span><span class="n">troncon</span><span class="p">.</span><span class="n">geom</span><span class="p">)),</span><span class="w"> </span><span class="n">ST_AsEWKT</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">)))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">geom_pt_proj</span><span class="p">,</span>
<span class="n">st_distance</span><span class="p">(</span><span class="n">troncon</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">dist</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">bdtopo_idvoie</span><span class="w">  </span><span class="n">troncon</span>
<span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">point_adresse</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">troncon</span><span class="p">.</span><span class="n">id_voie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id_voie</span>
<span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">adresse</span><span class="p">.</span><span class="n">v_communes_publiees</span><span class="w"> </span><span class="n">l</span><span class="w">  </span><span class="k">on</span><span class="w"> </span><span class="n">st_intersects</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="n">l</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
<span class="p">),</span>
<span class="n">point_proj</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="c1">--- Séléction des unique des id_points avec id tronçon associés dont la distance est la plus courte (une voie pouvant comprendre plusieurs tronçons bdtopo on associe les points adresses aux tronçon le plus proche)</span>
<span class="k">select</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="p">(</span><span class="n">distance_troncon</span><span class="p">.</span><span class="n">id_point</span><span class="p">)</span><span class="w"> </span><span class="n">distance_troncon</span><span class="p">.</span><span class="n">id_point</span><span class="p">,</span><span class="w"> </span><span class="n">distance_troncon</span><span class="p">.</span><span class="n">id_troncon</span><span class="p">,</span>
<span class="n">distance_troncon</span><span class="p">.</span><span class="n">id_voie</span><span class="p">,</span><span class="w"> </span><span class="n">distance_troncon</span><span class="p">.</span><span class="n">numero</span><span class="p">,</span><span class="w"> </span><span class="n">distance_troncon</span><span class="p">.</span><span class="n">suffixe</span><span class="p">,</span><span class="w"> </span><span class="n">distance_troncon</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">geom_pt_adresse</span><span class="p">,</span><span class="w"> </span><span class="n">geom_pt_proj</span>
<span class="k">from</span><span class="w"> </span><span class="n">distance_troncon</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">id_point</span><span class="p">,</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="k">ASC</span><span class="p">),</span>
<span class="n">line_cross</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="c1">--- tracer une ligne prolongées entre le point adresse et son point projeté sur le tronçon</span>
<span class="k">select</span><span class="w"> </span><span class="n">point_proj</span><span class="p">.</span><span class="n">id_point</span><span class="p">,</span><span class="w"> </span><span class="n">point_proj</span><span class="p">.</span><span class="n">id_troncon</span><span class="p">,</span><span class="w"> </span><span class="n">point_proj</span><span class="p">.</span><span class="n">id_voie</span><span class="p">,</span><span class="w"> </span><span class="n">point_proj</span><span class="p">.</span><span class="n">numero</span><span class="p">,</span><span class="w"> </span><span class="n">point_proj</span><span class="p">.</span><span class="n">suffixe</span><span class="p">,</span><span class="w"> </span><span class="n">point_proj</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">geom_pt_adresse</span><span class="p">,</span>
<span class="n">geom_pt_proj</span><span class="p">,</span>
<span class="n">ST_MakeLine</span><span class="p">(</span><span class="n">geom_pt_adresse</span><span class="p">,</span>
<span class="n">ST_TRANSLATE</span><span class="p">(</span><span class="n">geom_pt_adresse</span><span class="p">,</span><span class="w"> </span><span class="n">sin</span><span class="p">(</span><span class="n">ST_AZIMUTH</span><span class="p">(</span><span class="n">geom_pt_adresse</span><span class="p">,</span><span class="n">geom_pt_proj</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">ST_DISTANCE</span><span class="p">(</span><span class="n">geom_pt_adresse</span><span class="p">,</span><span class="n">geom_pt_proj</span><span class="p">)</span>
<span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">ST_DISTANCE</span><span class="p">(</span><span class="n">geom_pt_adresse</span><span class="p">,</span><span class="n">geom_pt_proj</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">50</span><span class="o">/</span><span class="mi">49</span><span class="p">))),</span><span class="w"> </span><span class="n">cos</span><span class="p">(</span><span class="n">ST_AZIMUTH</span><span class="p">(</span><span class="n">geom_pt_adresse</span><span class="p">,</span><span class="n">geom_pt_proj</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">ST_DISTANCE</span><span class="p">(</span><span class="n">geom_pt_adresse</span><span class="p">,</span><span class="n">geom_pt_proj</span><span class="p">)</span>
<span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">ST_DISTANCE</span><span class="p">(</span><span class="n">geom_pt_adresse</span><span class="p">,</span><span class="n">geom_pt_proj</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">50</span><span class="o">/</span><span class="mi">49</span><span class="p">)))))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">geom_segment</span>
<span class="k">from</span><span class="w"> </span><span class="n">point_proj</span><span class="w"> </span><span class="p">),</span>
<span class="n">point_cote</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="c1">--- Definir le coté de du point adresse par rapport au tronçon grâce à son sens de croisement du segment précédemment crée</span>

<span class="k">select</span><span class="w"> </span><span class="n">line_cross</span><span class="p">.</span><span class="n">id_point</span><span class="p">,</span><span class="w"> </span><span class="n">line_cross</span><span class="p">.</span><span class="n">id_troncon</span><span class="p">,</span><span class="w"> </span><span class="n">line_cross</span><span class="p">.</span><span class="n">id_voie</span><span class="p">,</span><span class="w"> </span><span class="n">line_cross</span><span class="p">.</span><span class="n">numero</span><span class="p">,</span><span class="w"> </span><span class="n">line_cross</span><span class="p">.</span><span class="n">suffixe</span><span class="p">,</span>
<span class="k">case</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">ST_LineCrossingDirection</span><span class="p">(</span><span class="n">geom_segment</span><span class="p">,</span><span class="w"> </span><span class="n">ST_LineMerge</span><span class="p">(</span><span class="n">geom</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;gauche&#39;</span>
<span class="w">      </span><span class="k">WHEN</span><span class="w"> </span><span class="n">ST_LineCrossingDirection</span><span class="p">(</span><span class="n">geom_segment</span><span class="p">,</span><span class="w"> </span><span class="n">ST_LineMerge</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;droite&#39;</span>
<span class="w">      </span><span class="k">WHEN</span><span class="w"> </span><span class="n">ST_LineCrossingDirection</span><span class="p">(</span><span class="n">geom_segment</span><span class="p">,</span><span class="w"> </span><span class="n">ST_LineMerge</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;indefini&#39;</span>
<span class="w">      </span><span class="k">ELSE</span><span class="w"> </span><span class="s1">&#39;probleme&#39;</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">cote_voie</span><span class="p">,</span>
<span class="n">geom_segment</span><span class="p">,</span><span class="w"> </span><span class="n">geom_pt_adresse</span><span class="p">,</span><span class="w"> </span><span class="n">geom_pt_proj</span>
<span class="k">from</span><span class="w"> </span><span class="n">line_cross</span><span class="p">)</span>

<span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">point_cote</span><span class="w">  </span><span class="k">where</span><span class="w"> </span><span class="n">cote_voie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;indefini&#39;</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">cote_voie</span><span class="w"> </span><span class="o">=</span><span class="s1">&#39;probleme&#39;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="c1">--- Sélection des points adresses indéfinis ou à problème par rapport au tronçon de rattachement</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
</div>
<div class="toctree-wrapper compound">
<span id="document-traitements_fme/I_plannificateur_taches"></span><div class="section" id="i-produire-un-calendrier-des-taches-du-plannificateur">
<h2>I- Produire un calendrier des tâches du plannificateur<a class="headerlink" href="#i-produire-un-calendrier-des-taches-du-plannificateur" title="Permalink to this heading"></a></h2>
<p>Dans le cadre de ses missions, le pôle SIG du Département enrichit la base de données épaisse, effectue des mises à jour automatiques (interconnexion aux API via l’ETL FME) et des traitements spécifiques sur la base de données.</p>
<p>Pour cela, des tâches sont programmées via le logiciel ‘Task scheduler’ de windows.</p>
<p>Avec la multiplication des tâches plannifiées, un traitement FME a été mis en place pour automatiser la création d’un calendrier partagé des tâches windows dans Outlook.</p>
<a class="reference internal image-reference" href="_images/task_calendar.gif"><img alt="_images/task_calendar.gif" src="_images/task_calendar.gif" style="width: 788.0px; height: 433.0px;" /></a>
<div class="section" id="normes-de-saisies-sur-le-plannificateur-windows">
<h3>1 - Normes de saisies sur le plannificateur Windows<a class="headerlink" href="#normes-de-saisies-sur-le-plannificateur-windows" title="Permalink to this heading"></a></h3>
<p>Afin que l’ensemble des paramètres soient correctement interprété par FME, certaines normes doivent êtres respectées lors de la création/saisie d’une tâche sur windows.</p>
<div class="section" id="onglet-description">
<h4>1.1 - Onglet description<a class="headerlink" href="#onglet-description" title="Permalink to this heading"></a></h4>
<ul>
<li><p>Saisie de la CATEGORIE dans le format suivant :</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">CATEGORIE</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">Interne</span><span class="w"> </span><span class="n">ou</span><span class="w"> </span><span class="n">Entrant</span><span class="w"> </span><span class="n">ou</span><span class="w"> </span><span class="n">Sortant</span><span class="p">).</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<p>NE PAS OUBLIER LE POINT A LA FIN !!</p>
<ul>
<li><p>Saisie de la SOURCE des données dans le format suivant :</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SOURCE</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">lien</span><span class="w"> </span><span class="n">ou</span><span class="w"> </span><span class="n">nom</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">la</span><span class="o">/</span><span class="n">des</span><span class="w"> </span><span class="k">source</span><span class="p">(</span><span class="n">s</span><span class="p">))</span><span class="w"> </span><span class="o">|*</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<p>NE PAS OUBLIER LE <a href="#id1"><span class="problematic" id="id2">|</span></a>* A LA FIN !!</p>
<ul>
<li><p>Saisie de la DESTINATION des données dans le format suivant :</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">DESTINATION</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">lien</span><span class="w"> </span><span class="n">ou</span><span class="w"> </span><span class="n">nom</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">la</span><span class="o">/</span><span class="n">des</span><span class="w"> </span><span class="k">source</span><span class="p">(</span><span class="n">s</span><span class="p">))</span><span class="w"> </span><span class="o">|*</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<p>NE PAS OUBLIER LE <a href="#id3"><span class="problematic" id="id4">|</span></a>* A LA FIN !!</p>
<ul>
<li><p>Saisie du RESUME de la tâche dans le format suivant :</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">RESUME</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">tâche</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<p>LE RESUME ET SON CONTENU DOIT TOUJOURS TERMINER LA DESCRIPTION !!</p>
<a class="reference internal image-reference" href="_images/0_1_description.png"><img alt="_images/0_1_description.png" src="_images/0_1_description.png" style="width: 316.0px; height: 239.5px;" /></a>
</div>
<div class="section" id="onglet-declencheur">
<h4>1.2 - Onglet déclencheur<a class="headerlink" href="#onglet-declencheur" title="Permalink to this heading"></a></h4>
<ul class="simple">
<li><p>La date de démarrage doit toujour commencer le même jour que celui programmé (ex : si programmé les lundi, démarrage un lundi ou si programmé le premier vendredi du mois, démarrage un premier vendredi)</p></li>
</ul>
<a class="reference internal image-reference" href="_images/0_2_date_progra.png"><img alt="_images/0_2_date_progra.png" src="_images/0_2_date_progra.png" style="width: 632.5px; height: 319.0px;" /></a>
<ul class="simple">
<li><p>On ne définit pas d’arrêt de la tâche à cette étape (on se sert de l’exécution limite à une autre étape, cela risque de concurencer)</p></li>
</ul>
<a class="reference internal image-reference" href="_images/0_3_no_limit_in_time.png"><img alt="_images/0_3_no_limit_in_time.png" src="_images/0_3_no_limit_in_time.png" style="width: 620.5px; height: 307.5px;" /></a>
</div>
<div class="section" id="onglet-parametres">
<h4>1.1 - Onglet Paramètres<a class="headerlink" href="#onglet-parametres" title="Permalink to this heading"></a></h4>
<ul class="simple">
<li><p>Programmer l’arrêt de la tâche en fonction de sa durée réelle (c’est cette limite qui va définir la durée de la tâche : en heures ou en minutes)</p></li>
</ul>
<a class="reference internal image-reference" href="_images/0_4_execution_time_limit.png"><img alt="_images/0_4_execution_time_limit.png" src="_images/0_4_execution_time_limit.png" style="width: 316.5px; height: 241.0px;" /></a>
</div>
</div>
<div class="section" id="fonctionnement-du-workbbench-fme">
<h3>2 - Fonctionnement du workbbench FME<a class="headerlink" href="#fonctionnement-du-workbbench-fme" title="Permalink to this heading"></a></h3>
<p>Le workbench FME se trouve <a class="reference external" href="https://github.com/sig14/sig14.github.io/releases/tag/FME_xml_task_windows_scheduler_to_ics">ici</a></p>
<div class="section" id="charger-les-fichiers-xml-task-schduler">
<h4>2.1 - Charger les fichiers XML task schduler<a class="headerlink" href="#charger-les-fichiers-xml-task-schduler" title="Permalink to this heading"></a></h4>
<p>A chaque création d’une tâche sur le logiciel ‘Task scheduler’ de Windows, un fichier xml est enregistré sur C:WindowsSystem32Tasks*</p>
<p>FME récupère l’ensemble des fichiers XML se trouvant dans ce dossier.</p>
</div>
<div class="section" id="extraction-des-donnees-de-temporalites-regexp">
<h4>2.2 - Extraction des données de temporalités (REGEXP)<a class="headerlink" href="#extraction-des-donnees-de-temporalites-regexp" title="Permalink to this heading"></a></h4>
<a class="reference internal image-reference" href="_images/I_1_extract_data.png"><img alt="_images/I_1_extract_data.png" src="_images/I_1_extract_data.png" style="width: 788.0px; height: 239.0px;" /></a>
<ul>
<li><p>Récupération du texte entre les balises <strong>URI</strong> (nom de la tâche)</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span>(?&lt;=&lt;URI&gt;)(.*)(?=&lt;\/URI&gt;)
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Exclure les tâches qui commencent par “User_Feed_” (tâches par défaut de windows)</p></li>
<li><p>Récupération du texte entre les balises <strong>command</strong> (actions effectuées par la tâche) sous forme de listes</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span>(?&lt;=&lt;Command&gt;)(.*?)(?=&lt;\/Command&gt;)
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Concaténation des listes d’actions</p></li>
<li><p>Récupération du texte entre les balises <strong>Description</strong> (Description de la tâche) sous forme de listes</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span>(?&lt;=&lt;Description&gt;)(.*)(?=&lt;\/Description&gt;)
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>remplacer les sauts de lignes des description par des balises <strong>n</strong> puis saut de ligne (interprétables par Outlook)</p></li>
<li><p>Récupération de la valeur entre les balises <strong>StarBoundary</strong> (heure et date de démarrage de la tâche)</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span>(?&lt;=StartBoundary&gt;)(.*?)(?=&lt;\/StartBoundary)
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Supprimer les <strong>:</strong> et <strong>-</strong> de la date de démarrage (interprétables par Outlook)</p></li>
<li><p>Récupération de la valeur après balises <strong>SheduleBy</strong> (programmation par interval : mois, jours, années)</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span>(?&lt;=ScheduleBy)(\w*)(?=&gt;)
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Récupération de la valeur après <strong>ExecutionTimeLimit</strong> (limite de temps avant interuption de la tâche)</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span>(?&lt;=ExecutionTimeLimit&gt;)(\w*)
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Récupération de la valeur comprise entre <strong>CATEGORIE</strong> et <strong>.</strong> (catégorie de donénes entrantes, sortantes ou flux internes)</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span>(?&lt;=CATEGORIE :)(.*?)(?=\.)
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Supression des espaces dans le champs catégorie</p></li>
</ul>
</div>
<div class="section" id="creation-des-champs-pour-le-listing-excel">
<h4>2.3 - Création des champs pour le listing excel<a class="headerlink" href="#creation-des-champs-pour-le-listing-excel" title="Permalink to this heading"></a></h4>
<a class="reference internal image-reference" href="_images/I_8_listing_excel.png"><img alt="_images/I_8_listing_excel.png" src="_images/I_8_listing_excel.png" style="width: 387.5px; height: 190.0px;" /></a>
<ul>
<li><p>Récupération des valeurs entre DESTINATION et <a href="#id5"><span class="problematic" id="id6">|</span></a>* (url ou nom de la destination des données)</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span>(?&lt;=DESTINATION :)(.*?)(?=\|\*)
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Créer une valeur vide pour les entités qui n’ont pas de destination renseignée</p></li>
<li><p>Récupération des valeurs entre DSOURCE et <a href="#id7"><span class="problematic" id="id8">|</span></a>* (url ou nom de la source des données)</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span>(?&lt;=SOURCE :)(.*?)(?=\|\*)
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Créer une valeur vide pour les entités qui n’ont pas de source renseignée</p></li>
<li><p>Récupération des valeurs après RESUME et avant la balise /DESCRIPTION (résumé de la tâche)</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span>(?&lt;=RESUME :)(.*?)(?=&lt;\/Description&gt;)
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Créer une valeur vide pour les entités qui n’ont pas de résumé renseigné</p></li>
</ul>
</div>
<div class="section" id="filtre-sur-les-temporalites">
<h4>2.4 - Filtre sur les temporalités<a class="headerlink" href="#filtre-sur-les-temporalites" title="Permalink to this heading"></a></h4>
<a class="reference internal image-reference" href="_images/I_2_filtre_temporalite.png"><img alt="_images/I_2_filtre_temporalite.png" src="_images/I_2_filtre_temporalite.png" style="width: 129.0px; height: 362.0px;" /></a>
</div>
<div class="section" id="extraction-du-detail-de-temporalite">
<h4>2.5 - Extraction du détail de temporalité<a class="headerlink" href="#extraction-du-detail-de-temporalite" title="Permalink to this heading"></a></h4>
<a class="reference internal image-reference" href="_images/I_3_detail_temporalite.png"><img alt="_images/I_3_detail_temporalite.png" src="_images/I_3_detail_temporalite.png" style="width: 406.5px; height: 431.0px;" /></a>
<p><strong>Pour les temporalité Day</strong> :</p>
<ul>
<li><p>Récupération des chiffres après la balise <strong>DaysInterval</strong> (interval de jours pour lancement de la tâche)</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span>(?&lt;=&lt;DaysInterval&gt;)(\d*)
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<p><strong>Pour les temporalité Week</strong> :</p>
<ul>
<li><p>Récupération des chifres Entre les balises <strong>WeeksInterval</strong> (interval de semaines pour lancement de la tâche)</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span>(?&lt;=&lt;WeeksInterval&gt;)(.*)(?=&lt;\/WeeksInterval&gt;)
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<p><strong>Pour les temporalité Month</strong> :</p>
<ul>
<li><p>Récupération du texte Entre les balises <strong>Months</strong> (différents mois de lancement de la tâche)</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span>(?&lt;=&lt;Months&gt;)(.*)(?=&lt;\/Months)
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Création de liste avec les textes de mois extraits</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span>(?&lt;=&lt;)(.*?\/&gt;)
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Récupération du chiffre après la balise <strong>Day</strong> (jour des mois de lancement de la tâche)</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span>(?&lt;=&lt;Day&gt;)(\d*)
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Explosion des listes de mois</p></li>
</ul>
<p><strong>Pour les temporalité MonthDayOfWeek</strong> :</p>
<ul>
<li><p>Récupération des chiffres après la balise <strong>Week</strong> (numéro de semaine de lancement)</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span>(?&lt;=&lt;Week&gt;)(\d*)
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Récupération du texte entre les balises <strong>DaysofWeek</strong> (jours de la semaine pour lancement de la tâche)</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span>(?&lt;=&lt;DaysofWeek&gt;)(.*)(?=&lt;\/DaysofWeek)
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Création des valeurs outlook de jours de semaines en fonction des chiffres extraits (nombres et Prefixes)</p></li>
<li><p>Récupération du texte Entre les balises <strong>Months</strong> (différents mois de lancement de la tâche)</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span>(?&lt;=&lt;Months&gt;)(.*)(?=&lt;\/Months)
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Création de liste avec les textes de mois extraits</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span>(?&lt;=&lt;)(.*?\/&gt;)
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Explosion des listes de mois</p></li>
</ul>
</div>
<div class="section" id="mise-en-forme-du-detail-de-temporalite">
<h4>2.6 - Mise en forme du détail de temporalité<a class="headerlink" href="#mise-en-forme-du-detail-de-temporalite" title="Permalink to this heading"></a></h4>
<a class="reference internal image-reference" href="_images/I_4_mise_en_forme_detail_temporalite.png"><img alt="_images/I_4_mise_en_forme_detail_temporalite.png" src="_images/I_4_mise_en_forme_detail_temporalite.png" style="width: 218.5px; height: 260.5px;" /></a>
<ul class="simple">
<li><p>Création du numéro de mois correspondant à la valeur de mois extraite</p></li>
<li><p>Préfixer les attributs <strong>Days</strong> et <strong>Month</strong> en fonction de leur longueur et mise en forme de la date pour Outlook</p></li>
</ul>
</div>
<div class="section" id="structuration-du-texte-au-format-ics">
<h4>2.7 - Structuration du texte au format ICS<a class="headerlink" href="#structuration-du-texte-au-format-ics" title="Permalink to this heading"></a></h4>
<a class="reference internal image-reference" href="_images/I_5_structuration.png"><img alt="_images/I_5_structuration.png" src="_images/I_5_structuration.png" style="width: 196.5px; height: 102.5px;" /></a>
<p><strong>Pour les temporalité Day</strong> :</p>
<p>BEGIN:VEVENT
CATEGORIES:Journalier
SUMMARY: &#64;Value(task_name)
DTSTART;TZID=”Romance Standard Time”:&#64;Value(start_time)
RRULE:FREQ=DAILY;INTERVAL=&#64;Value(day_interval)
DURATION:&#64;Value(duration)
DESCRIPTION:</p>
<blockquote>
<div><p>&#64;Value(description)</p>
</div></blockquote>
<p>LOCATION:&#64;Value(task_actions)
END:VEVENT</p>
<p><strong>Pour les temporalité Week</strong> :</p>
<p>BEGIN:VEVENT
CATEGORIES:Hebdomadaire
SUMMARY: &#64;Value(task_name)
DTSTART;TZID=”Romance Standard Time”:&#64;Value(start_time)
RRULE:FREQ=WEEKLY;INTERVAL=&#64;Value(week_interval)
DURATION:&#64;Value(duration)
DESCRIPTION:</p>
<blockquote>
<div><p>&#64;Value(description)</p>
</div></blockquote>
<p>LOCATION:&#64;Value(task_actions)
END:VEVENT</p>
<p><strong>Pour les temporalité Month</strong> :</p>
<p>BEGIN:VEVENT
CATEGORIES:Mensuel
SUMMARY:&#64;Value(task_name)
DTSTART;TZID=”Romance Standard Time”:&#64;Value(start_time2)
RRULE:FREQ=YEARLY;BYMONTHDAY=&#64;Value(num_day);BYMONTH=&#64;Value(num_month2)
DURATION:&#64;Value(duration)
DESCRIPTION:</p>
<blockquote>
<div><p>&#64;Value(description)</p>
</div></blockquote>
<p>LOCATION:&#64;Value(task_actions)
END:VEVENT</p>
<p><strong>Pour les temporalité MonthDayOfWeek</strong> :</p>
<p>BEGIN:VEVENT
CATEGORIES:Mensuel
SUMMARY:&#64;Value(task_name)
DTSTART;TZID=”Romance Standard Time”:&#64;Value(start_time2)
RRULE:FREQ=YEARLY;BYDAY=&#64;Value(num_day2);BYMONTH=&#64;Value(num_month2);BYSETPOS=&#64;Value(week)
DURATION:&#64;Value(duration)
DESCRIPTION:</p>
<blockquote>
<div><p>&#64;Value(description)</p>
</div></blockquote>
<p>LOCATION:&#64;Value(task_actions)
END:VEVENT</p>
</div>
<div class="section" id="ecriture-du-fichier-ics">
<h4>2.8 - Ecriture du fichier ics<a class="headerlink" href="#ecriture-du-fichier-ics" title="Permalink to this heading"></a></h4>
<a class="reference internal image-reference" href="_images/I_6_writer.png"><img alt="_images/I_6_writer.png" src="_images/I_6_writer.png" style="width: 276.0px; height: 211.0px;" /></a>
<p>Dans les paramètres d’attribut du writer, modifier la valeur :</p>
<p>BEGIN:VCALENDAR
VERSION:2.0
&#64;Value(text_line_data)
END:VCALENDAR</p>
<p>Et enregistrer en destination Text file avec suffixe .ics dans le nom.</p>
<a class="reference internal image-reference" href="_images/I_7_save_as_ics.png"><img alt="_images/I_7_save_as_ics.png" src="_images/I_7_save_as_ics.png" style="width: 269.5px; height: 122.5px;" /></a>
</div>
<div class="section" id="mise-en-forme-excel">
<h4>2.9 - Mise en forme Excel<a class="headerlink" href="#mise-en-forme-excel" title="Permalink to this heading"></a></h4>
<a class="reference internal image-reference" href="_images/I_9_miseen_forme_excel.png"><img alt="_images/I_9_miseen_forme_excel.png" src="_images/I_9_miseen_forme_excel.png" style="width: 336.0px; height: 365.5px;" /></a>
<ul class="simple">
<li><p>Création de la périodicité  et de l’interval</p></li>
</ul>
<p><strong>Pour les temporalité Day</strong> :</p>
<p>periodicite : journalier
interval : Tous les &#64;Value(day_interval) jours</p>
<p><strong>Pour les temporalité Week</strong> :</p>
<p>periodicite : hebdomadaire
interval : Toutes les &#64;Value(week_interval) semaines</p>
<p><strong>Pour les temporalité Month</strong> :</p>
<p>periodicite : mensuel
interval :
Le &#64;Value(num_day) des mois de :
&#64;Value(months)</p>
<p><strong>Pour les temporalité MonthDayOfWeek</strong> :</p>
<p>periodicite : mesnuel
interval :
Le &#64;Value(num_day) de la &#64;Value(week) eme semaine des mois de :
&#64;Value(months)</p>
</div>
</div>
<div class="section" id="ouverture-des-fichiers">
<h3>3 - Ouverture des fichiers<a class="headerlink" href="#ouverture-des-fichiers" title="Permalink to this heading"></a></h3>
<p>Dans outlook, importer le calendrier à partir du fichier ICS créé.</p>
<a class="reference internal image-reference" href="_images/II_1_import_ics.png"><img alt="_images/II_1_import_ics.png" src="_images/II_1_import_ics.png" style="width: 603.0px; height: 358.0px;" /></a>
<p>En cliquant sur un rendez-vous, vous pouvez consulter :</p>
<ul class="simple">
<li><p>La périodicité des traitements (si paramétrage des catégories dans Outlook : plus bas dans le mail)</p></li>
<li><p>Le nom de la tâche (objet)</p></li>
<li><p>L’emplacement de l’action effectuée (emplacement)</p></li>
<li><p>L’heure de début</p></li>
<li><p>L’heure de fin (limite d’exécution du traitement)</p></li>
</ul>
<p>Dans le corps du RDV :
-       La catégorie d’import/export données : données entrantes, sortantes ou partagées/transférées en interne
-       Le chemin/url sources des données
-       Le chemin/url destination des données
-       Une description du traitement</p>
<p>Vous pouvez définir les catégories dans outlook comme ci-dessous pour visualiser la périodicité des traitements en couleur et les modalités d’imports/export de données (entrants, sortants, interne).</p>
<p>-&gt; Dans Accueil , indicateurs , classer</p>
<a class="reference internal image-reference" href="_images/II_1_categories_outlook.png"><img alt="_images/II_1_categories_outlook.png" src="_images/II_1_categories_outlook.png" style="width: 860.0px; height: 332.0px;" /></a>
<p>Dans Excel, ouvrir le fichier .xls</p>
<a class="reference internal image-reference" href="_images/II_1_result_excel.png"><img alt="_images/II_1_result_excel.png" src="_images/II_1_result_excel.png" style="width: 896.0px; height: 266.0px;" /></a>
</div>
</div>
</div>
<div class="toctree-wrapper compound">
<span id="document-traitements_gdal/I_geopackage"></span><div class="section" id="i-produire-un-geopackage-des-orthos-tuilees">
<h2>I- Produire un GeoPackage des orthos tuilées<a class="headerlink" href="#i-produire-un-geopackage-des-orthos-tuilees" title="Permalink to this heading"></a></h2>
<p>Dans le cadre de ses missions, …</p>
</div>
<span id="document-traitements_gdal/II_cog"></span><div class="section" id="ii-produire-un-cog-a-partir-des-orthos-ign">
<h2>II- Produire un COG à partir des orthos IGN<a class="headerlink" href="#ii-produire-un-cog-a-partir-des-orthos-ign" title="Permalink to this heading"></a></h2>
<p>Dans le cadre de ses missions, le pôle SIG</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, SIG14 team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>